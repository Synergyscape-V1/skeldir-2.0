openapi: 3.1.0
info:
  title: Skeldir Shopify Webhooks
  version: 2.0.0
  description: |
    Shopify webhook schemas for order and checkout events.
    These webhooks are received by the backend for revenue verification.
  contact:
    name: Skeldir Engineering
    email: engineering@skeldir.com
    url: https://skeldir.com

servers:
  - url: http://localhost:4015
    description: Prism Mock Server (Shopify Webhooks)

tags:
  - name: Shopify Webhooks
    description: Shopify webhook endpoints for order and checkout events

paths:
  /api/webhooks/shopify/order_create:
    post:
      summary: Shopify order created webhook
      description: Triggered when a new order is created in Shopify
      operationId: shopifyOrderCreate
      tags:
        - Shopify Webhooks
      parameters:
        - name: X-Shopify-Hmac-SHA256
          in: header
          required: false
          schema:
            type: string
          description: HMAC signature for webhook verification
        - name: X-Shopify-Shop-Domain
          in: header
          required: false
          schema:
            type: string
          description: Shop domain that triggered the webhook
        - name: X-Shopify-Topic
          in: header
          required: false
          schema:
            type: string
            enum: [orders/create]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifyOrder'
            example:
              id: 8209829119461
              order_number: 1001
              total_price: "199.99"
              currency: USD
              created_at: '2025-11-26T14:30:00Z'
              note_attributes:
                - name: skeldir_session_id
                  value: sess_abc123
                - name: utm_source
                  value: facebook
      responses:
        '200':
          $ref: '#/components/responses/WebhookAccepted'
        '401':
          $ref: '#/components/responses/WebhookUnauthorized'
        '422':
          $ref: '../_common/base.yaml#/components/responses/ValidationError'
        '500':
          $ref: '../_common/base.yaml#/components/responses/ServerError'

  /api/webhooks/shopify/orders/paid:
    post:
      summary: Shopify order paid webhook
      description: Triggered when a Shopify order transitions to paid
      operationId: shopifyOrderPaid
      tags:
        - Shopify Webhooks
      parameters:
        - name: X-Shopify-Hmac-SHA256
          in: header
          required: false
          schema:
            type: string
        - name: X-Shopify-Shop-Domain
          in: header
          required: false
          schema:
            type: string
        - name: X-Shopify-Topic
          in: header
          required: false
          schema:
            type: string
            enum: [orders/paid]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifyOrder'
            example:
              id: 8209829119461
              order_number: 1001
              total_price: "199.99"
              currency: USD
              created_at: '2025-11-26T14:35:00Z'
              financial_status: paid
              note_attributes:
                - name: skeldir_session_id
                  value: sess_def456
      responses:
        '200':
          $ref: '#/components/responses/WebhookAccepted'
        '401':
          $ref: '#/components/responses/WebhookUnauthorized'
        '422':
          $ref: '../_common/base.yaml#/components/responses/ValidationError'

  /api/webhooks/shopify/refunds/create:
    post:
      summary: Shopify refund created webhook
      description: Triggered when a refund is issued for a Shopify order
      operationId: shopifyRefundCreate
      tags:
        - Shopify Webhooks
      parameters:
        - name: X-Shopify-Hmac-SHA256
          in: header
          required: false
          schema:
            type: string
        - name: X-Shopify-Shop-Domain
          in: header
          required: false
          schema:
            type: string
        - name: X-Shopify-Topic
          in: header
          required: false
          schema:
            type: string
            enum: [refunds/create]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifyRefund'
            example:
              id: 2309829119461
              order_id: 8209829119461
              transactions:
                - id: 3892749823
                  amount: "50.00"
                  kind: refund
                  currency: USD
      responses:
        '200':
          $ref: '#/components/responses/WebhookAccepted'
        '401':
          $ref: '#/components/responses/WebhookUnauthorized'
        '422':
          $ref: '../_common/base.yaml#/components/responses/ValidationError'

  /api/webhooks/shopify/checkouts/update:
    post:
      summary: Shopify checkout updated webhook
      description: Triggered when a checkout is updated in Shopify
      operationId: shopifyCheckoutUpdated
      tags:
        - Shopify Webhooks
      parameters:
        - name: X-Shopify-Hmac-SHA256
          in: header
          required: false
          schema:
            type: string
        - name: X-Shopify-Shop-Domain
          in: header
          required: false
          schema:
            type: string
        - name: X-Shopify-Topic
          in: header
          required: false
          schema:
            type: string
            enum: [checkouts/update]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifyCheckout'
      responses:
        '200':
          $ref: '#/components/responses/WebhookAccepted'
        '401':
          $ref: '#/components/responses/WebhookUnauthorized'

components:
  responses:
    WebhookAccepted:
      description: Webhook processed successfully
      content:
        application/json:
          schema:
            $ref: '../_common/base.yaml#/components/schemas/SuccessResponse'
          example:
            success: true
            correlation_id: 00000000-0000-0000-0000-000000000000
            message: Webhook received
    WebhookUnauthorized:
      description: Unauthorized - invalid tenant key or signature
      content:
        application/json:
          schema:
            oneOf:
              - type: object
                required:
                  - detail
                properties:
                  detail:
                    type: object
                    required:
                      - status
                    properties:
                      status:
                        type: string
                        example: invalid_tenant_key
              - type: object
                required:
                  - status
                properties:
                  status:
                    type: string
                    example: invalid_signature
                  vendor:
                    type: string
                    example: shopify

  schemas:
    ShopifyOrder:
      type: object
      required:
        - id
        - order_number
        - total_price
        - created_at
      properties:
        id:
          type: integer
          format: int64
          description: Shopify order ID
        order_number:
          type: integer
          description: Human-readable order number
        total_price:
          type: string
          description: Total order price as string
        subtotal_price:
          type: string
          description: Subtotal before taxes and shipping
        total_tax:
          type: string
          description: Total tax amount
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
          description: Currency code
          example: USD
        created_at:
          type: string
          format: date-time
        confirmed:
          type: boolean
          description: Whether the order is confirmed
        financial_status:
          type: string
          enum: [pending, paid, refunded, voided]
        note_attributes:
          type: array
          description: Custom attributes including attribution data
          items:
            type: object
            properties:
              name:
                type: string
              value:
                type: string
        customer:
          type: object
          properties:
            id:
              type: integer
              format: int64
            email:
              type: string
              format: email
        line_items:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              title:
                type: string
              quantity:
                type: integer
              price:
                type: string

    ShopifyCheckout:
      type: object
      required:
        - token
        - total_price
      properties:
        token:
          type: string
          description: Checkout token
        total_price:
          type: string
          description: Total checkout price
        subtotal_price:
          type: string
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
        abandoned_checkout_url:
          type: string
          format: uri
        note_attributes:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              value:
                type: string

    ShopifyRefund:
      type: object
      required:
        - id
        - order_id
        - transactions
      properties:
        id:
          type: integer
          format: int64
          description: Refund ID
        order_id:
          type: integer
          format: int64
          description: Associated order ID
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
          description: Refund currency
          example: USD
        transactions:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              amount:
                type: string
                description: Refund amount
              currency:
                type: string
                pattern: '^[A-Z]{3}$'
              kind:
                type: string
                enum: [refund]
              parent_id:
                type: integer
                format: int64
