name: b11-p5-webhook-secret-redesign-adjudication

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  b11-p5-webhook-secret-redesign-gates:
    name: b11-p5-webhook-secret-redesign-gates
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/skeldir
      AUTH_JWT_SECRET: ci-secret
      AUTH_JWT_ALGORITHM: HS256
      AUTH_JWT_ISSUER: https://issuer.skeldir.test
      AUTH_JWT_AUDIENCE: skeldir-api
      PLATFORM_TOKEN_ENCRYPTION_KEY: ci-platform-key
      PLATFORM_TOKEN_KEY_ID: ci-key-id
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-dev.txt

      - name: Guard plaintext webhook secret references
        run: |
          python scripts/security/b11_p5_webhook_plaintext_guard.py --report docs/forensics/evidence/b11_p5/no_plaintext_webhook_guard.txt

      - name: Guard SQL multi-decrypt anti-patterns
        run: |
          python scripts/security/b11_p3_no_multi_decrypt_guard.py --report docs/forensics/evidence/b11_p5/no_multi_decrypt_guard.txt

      - name: Execute B11-P5 static/runtime tests
        run: |
          cd backend
          pytest tests/test_b11_p5_webhook_secret_redesign.py -q | tee ../docs/forensics/evidence/b11_p5/cache_boundedness_test.txt

      - name: Upload B11-P5 evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p5-webhook-secret-redesign-evidence
          path: |
            docs/forensics/evidence/b11_p5/no_plaintext_webhook_guard.txt
            docs/forensics/evidence/b11_p5/no_multi_decrypt_guard.txt
            docs/forensics/evidence/b11_p5/cache_boundedness_test.txt
            docs/forensics/evidence/b11_p5/PROOF_INDEX.md
