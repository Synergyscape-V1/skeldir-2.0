name: Contract Artifacts CI

# Purpose: Operationalize contract tests, mocks, and docs with hard gates
# Implements: Jamie's operational rigor + Schmidt's scientific methodology
# Sequence: Bundling -> Integrity -> Provider -> Docs

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'api-contracts/**/*.yaml'
      - 'contracts/**/*.yaml'
      - 'backend/app/api/**/*.py'
      - 'backend/app/schemas/**/*.py'
      - 'scripts/contracts/**'
      - '.github/workflows/contract-artifacts.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'api-contracts/**/*.yaml'
      - 'contracts/**/*.yaml'
      - 'backend/app/api/**/*.py'
      - 'backend/app/schemas/**/*.py'
      - 'scripts/contracts/**'
      - '.github/workflows/contract-artifacts.yml'

jobs:
  # Job 1: Bundle and validate contracts
  contract-bundling:
    name: Bundle & Validate Contracts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Node dependencies
        run: npm install
      
      - name: Bundle contracts
        run: bash scripts/contracts/bundle.sh
      
      - name: Upload bundled artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-bundles
          path: api-contracts/dist/openapi/v1/*.bundled.yaml
          retention-days: 7
  
  # Job 2: Contract integrity tests (Schmidt's Phase B)
  contract-integrity-tests:
    name: Contract Integrity Tests (Mocks vs Contracts)
    runs-on: ubuntu-latest
    needs: contract-bundling
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download bundled artifacts
        uses: actions/download-artifact@v4
        with:
          name: contract-bundles
          path: api-contracts/dist/openapi/v1
      
      - name: Install Prism CLI
        run: npm install -g @stoplight/prism-cli
      
      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt -r requirements-dev.txt
      
      - name: Start mock servers
        run: bash scripts/start-mocks.sh
      
      - name: Wait for mocks to be ready
        run: sleep 5
      
      - name: Run contract integrity tests
        run: |
          cd tests/contract
          pytest test_mock_integrity.py -v --tb=short
      
      - name: Stop mock servers
        if: always()
        run: bash scripts/stop-mocks.sh || true
  
  # Job 3: Provider contract tests (Jamie's Provider Tests)
  contract-provider-tests:
    name: Provider Contract Tests (Implementation vs Contracts)
    runs-on: ubuntu-latest
    needs: contract-bundling
    env:
      CI: "true"
      DATABASE_URL: postgresql://test_user:test_password@localhost:5432/skeldir_test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download bundled artifacts
        uses: actions/download-artifact@v4
        with:
          name: contract-bundles
          path: api-contracts/dist/openapi/v1
      
      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt -r requirements-dev.txt
      
      - name: Run provider contract tests
        run: |
          cd tests/contract
          pytest test_contract_semantics.py -v --tb=short
  
  # Job 4: Documentation build and validation
  contract-docs:
    name: Build & Validate Documentation
    runs-on: ubuntu-latest
    needs: contract-bundling
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git SHA
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Node dependencies
        run: npm install
      
      - name: Download bundled artifacts
        uses: actions/download-artifact@v4
        with:
          name: contract-bundles
          path: api-contracts/dist/openapi/v1
      
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli
      
      - name: Install Python dependencies (for validation)
        run: pip install pyyaml
      
      - name: Build documentation
        run: bash scripts/contracts/build_docs.sh
      
      - name: Validate documentation
        run: python scripts/contracts/validate_docs.py
      
      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: api-contracts/dist/docs/v1/
          retention-days: 30
  
  # Summary job: Report overall status
  contract-artifacts-status:
    name: Contract Artifacts Status
    runs-on: ubuntu-latest
    needs: [contract-bundling, contract-integrity-tests, contract-provider-tests, contract-docs]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "Contract Artifacts CI Status:"
          echo "  Bundling: ${{ needs.contract-bundling.result }}"
          echo "  Integrity Tests: ${{ needs.contract-integrity-tests.result }}"
          echo "  Provider Tests: ${{ needs.contract-provider-tests.result }}"
          echo "  Documentation: ${{ needs.contract-docs.result }}"
          
          if [[ "${{ needs.contract-bundling.result }}" != "success" ]] || \
             [[ "${{ needs.contract-integrity-tests.result }}" != "success" ]] || \
             [[ "${{ needs.contract-provider-tests.result }}" != "success" ]] || \
             [[ "${{ needs.contract-docs.result }}" != "success" ]]; then
            echo ""
            echo "Contract artifacts pipeline FAILED"
            echo ""
            echo "Failure interpretation:"
            if [[ "${{ needs.contract-bundling.result }}" != "success" ]]; then
              echo "  - Bundling failed: Invalid OpenAPI syntax or bundling errors"
            fi
            if [[ "${{ needs.contract-integrity-tests.result }}" != "success" ]]; then
              echo "  - Integrity tests failed: Contract examples violate their own schemas"
              echo "    -> Action: Fix contract examples in source YAML files"
            fi
            if [[ "${{ needs.contract-provider-tests.result }}" != "success" ]]; then
              echo "  - Provider tests failed: Implementation diverges from contracts"
              echo "    -> Action: Fix FastAPI implementation to match contracts"
            fi
            if [[ "${{ needs.contract-docs.result }}" != "success" ]]; then
              echo "  - Documentation failed: Unable to build or validate docs"
              echo "    -> Action: Check Redocly CLI errors or validation output"
            fi
            exit 1
          else
            echo ""
            echo "Contract artifacts pipeline PASSED"
            echo ""
            echo "All gates passed:"
            echo "  - Contracts bundled and validated"
            echo "  - Mock servers serve contract-compliant responses"
            echo "  - Implementation conforms to contracts"
            echo "  - Documentation built and validated"
          fi



