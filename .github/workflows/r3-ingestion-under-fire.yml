# R3 â€” Ingestion Under Fire (Idempotency + DLQ + PII)
#
# Runs an adversarial HTTP load harness against a real FastAPI + Postgres stack
# in CI, then verifies DB truth invariants (no duplicates, deterministic DLQ,
# no PII persistence) purely from CI logs.

name: "R3: Ingestion Under Fire"

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'backend/app/**'
      - 'alembic/**'
      - 'scripts/r3/**'
      - '.github/workflows/r3-ingestion-under-fire.yml'

jobs:
  r3-ingestion-under-fire:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: r3
          POSTGRES_PASSWORD: r3
          POSTGRES_DB: r3
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U r3 -d r3"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      CI: "true"
      PYTHONPATH: backend
      TENANT_API_KEY_HEADER: X-Skeldir-Tenant-Key
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/r3
      MIGRATION_DATABASE_URL: postgresql://r3:r3@127.0.0.1:5432/r3
      DATABASE_POOL_SIZE: "20"
      DATABASE_MAX_OVERFLOW: "0"
      DATABASE_POOL_TIMEOUT_SECONDS: "3"
      DATABASE_POOL_TOTAL_CAP: "30"
      INGESTION_FOLLOWUP_TASKS_ENABLED: "false"
      R3_ADMIN_DATABASE_URL: postgresql://r3:r3@127.0.0.1:5432/r3
      R3_RUNTIME_DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/r3
      R3_API_BASE_URL: http://127.0.0.1:8000
      R3_LADDER: "50,250,1000"
      R3_CONCURRENCY: "200"
      R3_TIMEOUT_S: "10"
      R3_NULL_BENCHMARK: "1"
      R3_NULL_BENCHMARK_TARGET_RPS: "50"
      R3_NULL_BENCHMARK_DURATION_S: "60"
      R3_NULL_BENCHMARK_MIN_RPS: "50"
      R3_EG34_P95_MAX_MS: "2000"
      R3_EG34_TEST1_RPS: "29"
      R3_EG34_TEST1_DURATION_S: "60"
      R3_EG34_TEST2_RPS: "46"
      R3_EG34_TEST2_DURATION_S: "60"
      R3_EG34_TEST3_RPS: "5"
      R3_EG34_TEST3_DURATION_S: "300"

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Setup Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: "3.11"

      - name: "EG-R3-FIX-1: SHA anchoring"
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATE_SHA="$(git rev-parse HEAD)"
          echo "EG_R3_FIX_1_SHA_ANCHOR"
          echo "GITHUB_SHA=${GITHUB_SHA}"
          echo "git_rev_parse_HEAD=${CANDIDATE_SHA}"
          echo "RUN_URL=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          echo "END_EG_R3_FIX_1_SHA_ANCHOR"
          if [ "${CANDIDATE_SHA}" != "${GITHUB_SHA}" ]; then
            echo "FAIL: git rev-parse HEAD does not match GITHUB_SHA"
            exit 1
          fi

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt -r backend/requirements-dev.txt

      - name: Run migrations
        shell: bash
        run: |
          set -euo pipefail
          alembic upgrade heads

      - name: Provision runtime DB identity
        shell: bash
        run: |
          set -euo pipefail
          psql "${MIGRATION_DATABASE_URL}" <<'SQL'
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
              CREATE ROLE app_user LOGIN PASSWORD 'app_user';
            END IF;
          END$$;
          GRANT CONNECT ON DATABASE r3 TO app_user;
          GRANT USAGE ON SCHEMA public TO app_user;
          GRANT USAGE ON SCHEMA security TO app_user;
          GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
          GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;
          GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA security TO app_user;
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO app_user;
          SQL

      - name: Calibrate Worker Counts
        shell: bash
        run: |
          python -c "import os; c=os.cpu_count() or 2; l=max(1, min(c-2, 2)); s=max(2, c-l-1); print(f'R3_LOADGEN_WORKERS={l}'); print(f'R3_SERVER_WORKERS={s}')" >> $GITHUB_ENV

      - name: Start API
        shell: bash
        run: |
          set -euo pipefail
          nohup python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers "$R3_SERVER_WORKERS" --no-access-log > uvicorn.log 2>&1 &

          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:8000/health >/dev/null; then
              echo "API is healthy"
              exit 0
            fi
            sleep 1
          done

          echo "API failed to become healthy"
          echo "---- uvicorn.log ----"
          tail -n 200 uvicorn.log || true
          exit 1

      - name: Run R3 harness
        id: r3_harness
        continue-on-error: true
        shell: bash
        env:
          CANDIDATE_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          python scripts/r3/ingestion_under_fire.py | tee r3_harness.log

      - name: Assert no raw PII in API logs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if grep -E -n "pii_user@test.invalid|receipt@test.invalid|203.0.113.99|bill@test.invalid" uvicorn.log; then
            echo "FAIL: raw PII marker detected in uvicorn.log"
            exit 1
          fi
          echo "PASS: no raw PII markers detected in uvicorn.log"

      - name: Render R3 summary (candidate-anchored)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          python scripts/r3/render_r3_summary.py \
            --log r3_harness.log \
            --out docs/forensics/validation/runtime/r3_summary.md \
            --candidate-sha "${GITHUB_SHA}" \
            --run-url "${RUN_URL}" | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Upload R3 logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: r3-runtime-logs-${{ github.sha }}
          path: |
            r3_harness.log
            uvicorn.log

      - name: "EG-R3-FIX-1: Hard gate (harness must succeed)"
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.r3_harness.outcome }}" != "success" ]; then
            echo "FAIL: harness step outcome=${{ steps.r3_harness.outcome }}"
            exit 1
          fi
          echo "PASS: harness step outcome=success"

      - name: Open PR to anchor proof in repo
        if: steps.r3_harness.outcome == 'success'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if git diff --quiet -- docs/forensics/validation/runtime/r3_summary.md; then
            echo "No r3_summary changes to commit."
            exit 0
          fi

          BRANCH="ci/r3-proof-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "${BRANCH}"
          git add docs/forensics/validation/runtime/r3_summary.md
          git commit -m "docs: anchor R3 proof for ${GITHUB_SHA}"

          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin "${BRANCH}"

          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          TITLE="R3 proof: ${GITHUB_SHA}"
          BODY="Anchors R3 completion evidence for candidate SHA ${GITHUB_SHA}.\n\nCI run: ${RUN_URL}"
          export TITLE BRANCH BODY
          python - <<'PY' > pr.json
          import json, os
          title = os.environ["TITLE"]
          head = os.environ["BRANCH"]
          base = "main"
          body = os.environ["BODY"]
          print(json.dumps({"title": title, "head": head, "base": base, "body": body}))
          PY
          curl -fsS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls" \
            -d @pr.json \
            >/dev/null || true
          echo "Opened PR for ${BRANCH}"

      - name: Dump server logs on failure
        if: failure()
        shell: bash
        run: |
          echo "---- uvicorn.log ----"
          tail -n 300 uvicorn.log || true
