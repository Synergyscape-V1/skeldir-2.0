name: b11-p1-control-plane-adjudication

on:
  pull_request_target:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ssot-contract-gate:
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/skeldir
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-dev.txt

      - name: Enforce SSOT contract + snapshot drift
        run: |
          python scripts/security/b11_p1_ssot_guard.py --check-drift

      - name: Run non-vacuous SSOT tests
        run: |
          cd backend
          pytest tests/test_b11_p1_ssot_contract.py -q

      - name: Upload SSOT evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p1-ssot-evidence
          path: |
            docs/forensics/evidence/b11_p1/ssot_contract_snapshot.json
            docs/forensics/evidence/b11_p1/PROOF_INDEX.md

  env-boundary-gate:
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/skeldir
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-dev.txt

      - name: Enforce namespace invariants (fail-closed + canonical pathing)
        run: |
          cd backend
          pytest tests/test_b11_p1_ssot_contract.py -q -k "control_plane_env_is_fail_closed or all_paths_resolve_with_canonical_prefix"

  terraform-control-plane-gate:
    if: (github.ref == 'refs/heads/main' || github.event_name == 'pull_request_target') && (github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository)
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-2
      B11_P1_TF_STATE_BUCKET: ${{ vars.B11_P1_TF_STATE_BUCKET }}
      B11_P1_TF_LOCK_TABLE: ${{ vars.B11_P1_TF_LOCK_TABLE }}
      B11_P1_TF_STATE_KEY: ${{ vars.B11_P1_TF_STATE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::326730685463:role/skeldir-ci-deploy
          aws-region: us-east-2

      - name: Bootstrap remote Terraform backend (idempotent)
        run: |
          set -euo pipefail
          : "${B11_P1_TF_STATE_BUCKET:?B11_P1_TF_STATE_BUCKET is required}"
          : "${B11_P1_TF_LOCK_TABLE:?B11_P1_TF_LOCK_TABLE is required}"
          KEY="${B11_P1_TF_STATE_KEY:-b11-p1/terraform.tfstate}"
          echo "state_bucket=${B11_P1_TF_STATE_BUCKET}"
          echo "state_lock_table=${B11_P1_TF_LOCK_TABLE}"
          echo "state_key=${KEY}"
          echo "backend_preflight=pass"
          echo "note=backend resources must pre-exist; authoritative verification happens during terraform init/state proof"

      - name: Terraform fmt/validate (authoritative backend)
        run: |
          cd infra/b11_p1/terraform
          terraform fmt -check
          terraform init \
            -backend-config="bucket=${B11_P1_TF_STATE_BUCKET}" \
            -backend-config="key=${B11_P1_TF_STATE_KEY:-b11-p1/terraform.tfstate}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${B11_P1_TF_LOCK_TABLE}" \
            -backend-config="encrypt=true" \
            -reconfigure \
            -input=false
          terraform validate

      - name: Capture IaC state proof scaffold (authoritative)
        run: |
          python scripts/security/b11_p1_iac_state_proof.py

      - name: Upload IaC evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p1-iac-evidence
          path: |
            docs/forensics/evidence/b11_p1/iac_state_proof.txt
            docs/forensics/evidence/b11_p1/PROOF_INDEX.md

  aws-proof-gate:
    if: (github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository) && (github.ref == 'refs/heads/main' || github.event_name == 'pull_request_target')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-2
      B11_P1_ENV: ci
      B11_P1_ROLE_NAME: skeldir-ci-deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::326730685463:role/skeldir-ci-deploy
          aws-region: us-east-2

      - name: Generate deny/audit/iam proof artifacts
        run: |
          python scripts/security/b11_p1_generate_proofs.py

      - name: Enforce non-vacuous deny proof
        run: |
          grep -q "RESULT=PASS" docs/forensics/evidence/b11_p1/deny_proof_cross_env.txt
          grep -q "RESULT=PASS" docs/forensics/evidence/b11_p1/cloudtrail_audit_proof.txt

      - name: Upload AWS evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p1-aws-evidence
          path: |
            docs/forensics/evidence/b11_p1/deny_proof_cross_env.txt
            docs/forensics/evidence/b11_p1/cloudtrail_audit_proof.txt
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-ci-deploy.json
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-app-runtime-prod.json
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-app-runtime-stage.json
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-rotation-lambda.json
            docs/forensics/evidence/b11_p1/PROOF_INDEX.md
