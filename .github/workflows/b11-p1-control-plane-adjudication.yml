name: b11-p1-control-plane-adjudication

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ssot-contract-gate:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/skeldir
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-dev.txt

      - name: Enforce SSOT contract + snapshot drift
        run: |
          python scripts/security/b11_p1_ssot_guard.py --check-drift

      - name: Run non-vacuous SSOT tests
        run: |
          cd backend
          pytest tests/test_b11_p1_ssot_contract.py -q

      - name: Upload SSOT evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p1-ssot-evidence
          path: |
            docs/forensics/evidence/b11_p1/ssot_contract_snapshot.json
            docs/forensics/evidence/b11_p1/PROOF_INDEX.md

  env-boundary-gate:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/skeldir
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-dev.txt

      - name: Enforce namespace invariants (fail-closed + canonical pathing)
        run: |
          cd backend
          pytest tests/test_b11_p1_ssot_contract.py -q -k "control_plane_env_is_fail_closed or all_paths_resolve_with_canonical_prefix"

  terraform-control-plane-gate:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-2
      B11_P1_TF_STATE_BUCKET: ${{ vars.B11_P1_TF_STATE_BUCKET }}
      B11_P1_TF_LOCK_TABLE: ${{ vars.B11_P1_TF_LOCK_TABLE }}
      B11_P1_TF_STATE_KEY: ${{ vars.B11_P1_TF_STATE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::326730685463:role/skeldir-ci-deploy
          aws-region: us-east-2

      - name: Bootstrap remote Terraform backend (idempotent)
        run: |
          set -euo pipefail
          : "${B11_P1_TF_STATE_BUCKET:?B11_P1_TF_STATE_BUCKET is required}"
          : "${B11_P1_TF_LOCK_TABLE:?B11_P1_TF_LOCK_TABLE is required}"
          KEY="${B11_P1_TF_STATE_KEY:-b11-p1/terraform.tfstate}"
          echo "state_bucket=${B11_P1_TF_STATE_BUCKET}"
          echo "state_lock_table=${B11_P1_TF_LOCK_TABLE}"
          echo "state_key=${KEY}"

          if ! aws s3api head-bucket --bucket "${B11_P1_TF_STATE_BUCKET}" 2>/dev/null; then
            aws s3api create-bucket \
              --bucket "${B11_P1_TF_STATE_BUCKET}" \
              --region "${AWS_REGION}" \
              --create-bucket-configuration "LocationConstraint=${AWS_REGION}"
          fi

          aws s3api put-bucket-versioning \
            --bucket "${B11_P1_TF_STATE_BUCKET}" \
            --versioning-configuration Status=Enabled

          aws s3api put-bucket-encryption \
            --bucket "${B11_P1_TF_STATE_BUCKET}" \
            --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'

          aws s3api put-public-access-block \
            --bucket "${B11_P1_TF_STATE_BUCKET}" \
            --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

          if ! aws dynamodb describe-table --table-name "${B11_P1_TF_LOCK_TABLE}" >/dev/null 2>&1; then
            aws dynamodb create-table \
              --table-name "${B11_P1_TF_LOCK_TABLE}" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region "${AWS_REGION}"
          fi

      - name: Terraform fmt/validate
        run: |
          cd infra/b11_p1/terraform
          terraform fmt -check
          terraform init \
            -backend-config="bucket=${B11_P1_TF_STATE_BUCKET}" \
            -backend-config="key=${B11_P1_TF_STATE_KEY:-b11-p1/terraform.tfstate}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${B11_P1_TF_LOCK_TABLE}" \
            -backend-config="encrypt=true" \
            -reconfigure \
            -input=false
          terraform validate

      - name: Capture IaC state proof scaffold
        run: |
          python scripts/security/b11_p1_iac_state_proof.py

      - name: Upload IaC evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p1-iac-evidence
          path: |
            docs/forensics/evidence/b11_p1/iac_state_proof.txt
            docs/forensics/evidence/b11_p1/PROOF_INDEX.md

  aws-proof-gate:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-2
      B11_P1_ENV: ci
      B11_P1_ROLE_NAME: skeldir-ci-deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::326730685463:role/skeldir-ci-deploy
          aws-region: us-east-2

      - name: Generate deny/audit/iam proof artifacts
        run: |
          python scripts/security/b11_p1_generate_proofs.py

      - name: Enforce non-vacuous deny proof
        run: |
          grep -q "RESULT=PASS" docs/forensics/evidence/b11_p1/deny_proof_cross_env.txt

      - name: Upload AWS evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p1-aws-evidence
          path: |
            docs/forensics/evidence/b11_p1/deny_proof_cross_env.txt
            docs/forensics/evidence/b11_p1/cloudtrail_audit_proof.txt
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-ci-deploy.json
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-app-runtime-prod.json
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-app-runtime-stage.json
            docs/forensics/evidence/b11_p1/iam_policy_skeldir-rotation-lambda.json
            docs/forensics/evidence/b11_p1/PROOF_INDEX.md
