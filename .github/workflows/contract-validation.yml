name: API Contract Validation

on:
  push:
    paths:
      - 'api-contracts/**/*.yaml'
      - 'scripts/contracts/**'
      - 'scripts/governance/**'
      - 'scripts/*.py'
      - 'backend/app/schemas/**'
      - 'backend/tests/test_generated_models.py'
      - '.github/workflows/contract-validation.yml'
  pull_request:
    paths:
      - 'api-contracts/**/*.yaml'
      - 'scripts/contracts/**'
      - 'scripts/governance/**'
      - 'scripts/*.py'
      - 'backend/app/schemas/**'
      - 'backend/tests/test_generated_models.py'
      - '.github/workflows/contract-validation.yml'

jobs:
  bundle-contracts:
    name: Bundle OpenAPI Contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "npm install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Bundle all contracts
        run: |
          chmod +x scripts/contracts/bundle.sh
          bash scripts/contracts/bundle.sh

      - name: Verify bundled artifacts
        run: |
          if [ ! -d "api-contracts/dist/openapi/v1" ]; then
            echo "ERROR: Bundled artifacts directory not found"
            exit 1
          fi
          BUNDLE_COUNT=$(find api-contracts/dist/openapi/v1 -name "*.yaml" | wc -l)
          if [ "$BUNDLE_COUNT" -lt 5 ]; then
            echo "ERROR: Expected bundled files, found $BUNDLE_COUNT"
            exit 1
          fi
          echo "✓ Found $BUNDLE_COUNT bundled artifacts"

  validate-openapi:
    name: Validate OpenAPI Specifications
    runs-on: ubuntu-latest
    needs: bundle-contracts
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "npm install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Install OpenAPI Generator CLI
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install -g @openapitools/openapi-generator-cli; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "OpenAPI Generator CLI install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Bundle contracts
        run: |
          chmod +x scripts/contracts/bundle.sh
          bash scripts/contracts/bundle.sh

      - name: Validate bundled OpenAPI files
        run: |
          echo "Validating bundled OpenAPI specifications..."
          for file in api-contracts/dist/openapi/v1/*.yaml; do
            if [ -f "$file" ]; then
              echo "Validating $(basename "$file")..."
              npx @openapitools/openapi-generator-cli validate -i "$file" || exit 1
            fi
          done
          echo "All bundled OpenAPI files validated successfully"

  check-breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install oasdiff
        run: |
          go install github.com/oasdiff/oasdiff@v1.11.7

      - name: Check breaking changes
        run: |
          echo "Checking for breaking changes..."
          if [ -d "api-contracts/baselines/v1.0.0" ]; then
            for file in api-contracts/openapi/v1/**/*.yaml api-contracts/openapi/v1/_common/*.yaml; do
              if [ -f "$file" ]; then
                # Handle webhook files in subdirectory
                if [[ "$file" == *"webhooks/"* ]]; then
                  baseline_file="api-contracts/baselines/v1.0.0/webhooks/$(basename $file)"
                elif [[ "$file" == *"_common/"* ]]; then
                  # Skip _common files for breaking change checks
                  continue
                else
                  baseline_file="api-contracts/baselines/v1.0.0/$(basename $file)"
                fi
                if [ -f "$baseline_file" ]; then
                  echo "Comparing $file with baseline..."
                  oasdiff breaking "$baseline_file" "$file" || exit 1
                fi
              fi
            done
          else
            echo "No baseline found, skipping breaking change check"
          fi
          echo "No breaking changes detected"

  lint-contracts:
    name: Lint API Contracts (Spectral)
    runs-on: ubuntu-latest
    needs: bundle-contracts
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "npm install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Install Spectral
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install -g @stoplight/spectral-cli; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "Spectral CLI install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Lint contracts with Spectral
        run: |
          echo "Linting OpenAPI contracts with Spectral..."
          spectral lint api-contracts/openapi/v1/*.yaml \
            api-contracts/openapi/v1/webhooks/*.yaml \
            --ruleset api-contracts/.spectral.yaml \
            --fail-severity error
          echo "✓ All contracts passed Spectral linting"

  enforce-semver:
    name: Enforce Semantic Versioning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check semver format
        run: |
          echo "Checking semantic versioning format..."
          semver_regex='^[0-9]+\.[0-9]+\.[0-9]+$'
          for file in api-contracts/openapi/v1/**/*.yaml api-contracts/openapi/v1/_common/*.yaml; do
            if [ -f "$file" ]; then
              version=$(grep -A 2 "^info:" "$file" | grep "version:" | awk '{print $2}' | tr -d '"')
              if [[ ! "$version" =~ $semver_regex ]]; then
                echo "ERROR: Invalid semver format in $file: $version"
                exit 1
              fi
              echo "✓ $file: $version"
            fi
          done
          echo "All files have valid semver versions"

  validate-governance:
    name: Validate Governance (Coverage & Invariants)
    runs-on: ubuntu-latest
    needs: [bundle-contracts, lint-contracts]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Node dependencies
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "npm install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Install Python dependencies
        run: |
          pip install pyyaml

      - name: Bundle contracts
        run: |
          chmod +x scripts/contracts/bundle.sh
          bash scripts/contracts/bundle.sh

      - name: Validate Coverage Manifest
        run: |
          echo "Validating coverage manifest..."
          chmod +x scripts/governance/validate_coverage.py
          python scripts/governance/validate_coverage.py --verbose

      - name: Validate Invariants
        run: |
          echo "Validating invariants registry..."
          chmod +x scripts/governance/validate_invariants.py
          python scripts/governance/validate_invariants.py --verbose

  generate-models:
    name: Generate Pydantic Models
    runs-on: ubuntu-latest
    needs: bundle-contracts
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Node dependencies
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "npm install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Install Python dependencies
        run: |
          pip install -r backend/requirements.txt -r backend/requirements-dev.txt

      - name: Bundle contracts
        run: |
          chmod +x scripts/contracts/bundle.sh
          bash scripts/contracts/bundle.sh

      - name: Generate Pydantic models
        run: |
          chmod +x scripts/generate-models.sh
          bash scripts/generate-models.sh

      - name: Verify model generation (non-trivial)
        run: |
          echo "Verifying generated models are non-trivial..."

          # Check all expected files exist
          for file in attribution auth reconciliation export webhooks_shopify webhooks_woocommerce webhooks_stripe webhooks_paypal; do
            SCHEMA_FILE="backend/app/schemas/${file}.py"

            if [ ! -f "$SCHEMA_FILE" ]; then
              echo "ERROR: $SCHEMA_FILE not found"
              exit 1
            fi

            # Check file contains class definitions
            CLASS_COUNT=$(grep -c "^class " "$SCHEMA_FILE" || echo 0)
            if [ "$CLASS_COUNT" -eq 0 ]; then
              echo "ERROR: $SCHEMA_FILE contains no class definitions"
              cat "$SCHEMA_FILE"
              exit 1
            fi

            # Check file size > 100 bytes (not a stub comment)
            FILE_SIZE=$(wc -c < "$SCHEMA_FILE")
            if [ "$FILE_SIZE" -lt 100 ]; then
              echo "ERROR: $SCHEMA_FILE is too small ($FILE_SIZE bytes)"
              exit 1
            fi

            echo "✓ $SCHEMA_FILE: $CLASS_COUNT classes, $FILE_SIZE bytes"
          done

          echo "All generated models are non-trivial"

      - name: Validate critical model classes exist
        run: |
          echo "Validating critical model classes..."

          # Define critical models that MUST exist
          declare -A EXPECTED_MODELS=(
            ["attribution"]="RealtimeRevenueResponse"
            ["auth"]="LoginRequest LoginResponse RefreshRequest RefreshResponse"
            ["reconciliation"]="ReconciliationStatusResponse"
            ["export"]="ExportRevenueResponse"
            ["webhooks_shopify"]="ShopifyOrderCreateRequest WebhookAcknowledgement"
          )

          for domain in "${!EXPECTED_MODELS[@]}"; do
            SCHEMA_FILE="backend/app/schemas/${domain}.py"
            MODELS="${EXPECTED_MODELS[$domain]}"

            for model in $MODELS; do
              if ! grep -q "class ${model}" "$SCHEMA_FILE"; then
                echo "ERROR: ${model} not found in $SCHEMA_FILE"
                echo "Generated file content:"
                cat "$SCHEMA_FILE"
                exit 1
              fi
              echo "✓ Found ${model} in ${domain}.py"
            done
          done

          echo "All critical model classes exist"

  validate-model-structures:
    name: Validate Generated Model Structures
    runs-on: ubuntu-latest
    needs: generate-models
    env:
      CI: "true"
      DATABASE_URL: postgresql://test_user:test_password@localhost:5432/skeldir_test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Node dependencies
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "npm install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Install Python dependencies
        run: |
          pip install -r backend/requirements.txt -r backend/requirements-dev.txt

      - name: Bundle and generate models
        run: |
          bash scripts/contracts/bundle.sh
          bash scripts/generate-models.sh

      - name: Validate model structures
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python scripts/validate_model_usage.py

      - name: Run model unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          cd backend
          pytest tests/test_generated_models.py -v

      - name: "Operational Gate P4: Check for hand-rolled models"
        run: |
          python scripts/check_model_usage.py
      - name: "Operational Gate P2: Verify downstream dependency on generated models"
        run: |
          echo "Testing operational dependency: corrupting generated model..."
          # Corrupt the RealtimeRevenueResponse class
          sed -i 's/class RealtimeRevenueResponse/class RealtimeRevenueResponse_BROKEN/' backend/app/schemas/attribution.py

          # Attempt to import - should fail
          if python -c "from backend.app.schemas.attribution import RealtimeRevenueResponse" 2>/dev/null; then
            echo "ERROR: Import succeeded after corruption - models are not operationally required"
            exit 1
          fi

          # Restore file
          sed -i 's/class RealtimeRevenueResponse_BROKEN/class RealtimeRevenueResponse/' backend/app/schemas/attribution.py

          # Verify validation script would fail
          if python scripts/validate_model_usage.py 2>&1 | grep -q "RealtimeRevenueResponse"; then
            echo "✓ Operational dependency verified: validation fails when model is corrupted"
          else
            echo "ERROR: Validation did not detect corrupted model"
            exit 1
          fi

  # ============================================================================
  # GOVERNANCE VALIDATION JOBS (Phase C0-C5)
  # ============================================================================

  validate-canonical-events:
    name: Validate Canonical Events (C0)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: |
          pip install pyyaml

      - name: Validate canonical events and state machine
        run: |
          python scripts/governance/validate_canonical_events.py

  validate-coverage-matrix:
    name: Validate Coverage Matrix (C1)
    runs-on: ubuntu-latest
    needs: validate-canonical-events
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: |
          pip install pyyaml

      - name: Validate provider coverage matrix
        run: |
          python scripts/governance/validate_coverage_matrix.py

  validate-contract-coverage:
    name: Validate Contract Coverage (C2)
    runs-on: ubuntu-latest
    needs: [validate-coverage-matrix, bundle-contracts]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          for attempt in 1 2 3 4 5; do
            if npm install; then
              break
            fi
            if [ "$attempt" -eq 5 ]; then
              echo "npm install failed after 5 attempts"
              exit 1
            fi
            sleep 2
          done
          pip install pyyaml

      - name: Bundle contracts
        run: |
          chmod +x scripts/contracts/bundle.sh
          bash scripts/contracts/bundle.sh

      - name: Validate contract coverage
        run: |
          python scripts/governance/validate_contract_coverage.py

      - name: Validate coverage manifest
        run: |
          python scripts/governance/validate_coverage.py

  validate-integration-mappings:
    name: Validate Integration Mappings (C3)
    runs-on: ubuntu-latest
    needs: [validate-coverage-matrix, validate-contract-coverage]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: |
          pip install pyyaml

      - name: Validate integration mappings
        run: |
          python scripts/governance/validate_integration_mappings.py
