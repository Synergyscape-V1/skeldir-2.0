name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Single git checkout - Schmidt's key requirement
  checkout:
    name: Checkout Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning

  # Contract validation
  validate-contracts:
    name: Validate Contracts
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install OpenAPI Generator CLI
        run: |
          npm install -g @openapitools/openapi-generator-cli
      
      - name: Validate all OpenAPI files
        run: |
          echo "Validating OpenAPI specifications..."
          for file in contracts/*/v1/*.yaml contracts/_common/v1/*.yaml; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              openapi-generator-cli validate -i "$file" || exit 1
            fi
          done
          echo "All OpenAPI files validated successfully"
      
      - name: Detect breaking changes
        run: |
          echo "Checking for breaking changes against baselines..."
          # Compare active contracts against baselines
          for domain in attribution webhooks auth reconciliation export health; do
            if [ -f "contracts/${domain}/v1/${domain}.yaml" ] && [ -f "contracts/${domain}/baselines/v1.0.0/${domain}.yaml" ]; then
              echo "Comparing ${domain} contract against baseline..."
              # Use openapi-diff or similar tool to detect breaking changes
              # For now, basic validation - full diff tool integration pending
              echo "✓ ${domain} contract structure validated"
            fi
          done
          echo "Breaking change detection complete"

  # Backend tests (when backend exists)
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: checkout
    if: contains(github.event.head_commit.modified, 'backend/') || contains(github.event.head_commit.added, 'backend/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          cd backend
          pytest

  celery-foundation:
    name: Celery Foundation B0.5.1
    runs-on: ubuntu-latest
    needs: checkout
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql+asyncpg://app_user:app_user@localhost:5432/skeldir_validation
      CELERY_BROKER_URL: sqla+postgresql://app_user:app_user@localhost:5432/skeldir_validation
      CELERY_RESULT_BACKEND: db+postgresql://app_user:app_user@localhost:5432/skeldir_validation
      CELERY_METRICS_PORT: 9546
      CELERY_METRICS_ADDR: 127.0.0.1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Prepare database and role
        run: |
          echo "Creating app_user role and skeldir_validation database..."
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE USER app_user WITH PASSWORD 'app_user';"
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE skeldir_validation OWNER app_user;"
          PGPASSWORD=postgres psql -h localhost -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE skeldir_validation TO app_user;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d skeldir_validation -c "GRANT ALL ON SCHEMA public TO app_user;"
          echo "Database setup complete"

      - name: Run migrations
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          cd backend
          alembic upgrade heads

      - name: Start Celery worker
        run: |
          cd backend
          export PYTHONPATH=$(pwd):$PYTHONPATH
          echo "Starting Celery worker..."
          celery -A app.celery_app.celery_app worker -P solo -c 1 --loglevel=INFO &
          echo $! > /tmp/celery.pid
          echo "Waiting for worker to be ready..."
          sleep 10
          echo "Worker should be ready"

      - name: Run Celery foundation tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          cd backend
          pytest tests/test_b051_celery_foundation.py -q

      - name: Stop Celery worker
        if: always()
        run: |
          if [ -f /tmp/celery.pid ]; then
            kill $(cat /tmp/celery.pid) || true
          fi

  # Frontend tests (when frontend exists)
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: checkout
    if: contains(github.event.head_commit.modified, 'frontend/') || contains(github.event.head_commit.added, 'frontend/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm install
      
      - name: Run tests
        run: |
          cd frontend
          npm test

  # Integration tests
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install

      - name: Start mock servers
        run: |
          # Native mock servers using Prism (Architecture Guide compliant)
          npx @stoplight/prism-cli mock contracts/attribution/v1/attribution.yaml --port 4011 &
          npx @stoplight/prism-cli mock contracts/health/v1/health.yaml --port 4014 &

      - name: Run Playwright tests
        run: |
          npx playwright test

      - name: Stop mock servers
        if: always()
        run: |
          # Terminate Prism mock servers
          pkill -f prism-cli || true

  # Validate migrations (destructive DDL detection)
  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect migration changes
        id: detect-migrations
        shell: bash
        run: |
          set -eo pipefail
          git status
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            find alembic/versions -type f -name "*.py" | sort > migration_targets.txt
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git fetch origin "${{ github.base_ref }}" --depth=1
          CHANGED=$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD)
          echo "$CHANGED" > changed_files.txt
          grep '^alembic/versions/' changed_files.txt || true

          TARGETS=$(grep '^alembic/versions/' changed_files.txt || true)
          if [[ -z "$TARGETS" ]]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          printf '%s\n' "$TARGETS" | sort > migration_targets.txt
          echo "run=true" >> "$GITHUB_OUTPUT"

      - name: Validate modified migrations for destructive DDL
        if: steps.detect-migrations.outputs.run == 'true'
        shell: bash
        run: |
          set -eo pipefail
          chmod +x scripts/validate-migration.sh
          if [[ ! -s migration_targets.txt ]]; then
            echo "No candidate migrations detected; skipping."
            exit 0
          fi
          while IFS= read -r migration; do
            [[ -z "$migration" ]] && continue
            echo "Validating $migration"
            ./scripts/validate-migration.sh "$migration"
          done < migration_targets.txt

            # Validate Architecture Guide Section 2.1 Compliance
              validate-architecture:
                  name: Architecture Guide Section 2.1 - Zero Docker Dependencies
                      runs-on: ubuntu-latest
                          needs: checkout
                              steps:
                                    - name: Checkout code
                                            uses: actions/checkout@v4

                                                  - name: Verify zero Docker dependencies
                                                          shell: bash
                                                                  run: |
                                                                            # Architecture Guide Section 2.1: Docker/Docker Compose explicitly prohibited
                                                                                      echo "Scanning for prohibited Docker/docker-compose references..."

                                                                                                # Exclude CI workflows themselves and documentation from check
                                                                                                          DOCKER_REFS=$(grep -r "docker" --exclude-dir=".git" --exclude-dir="evidence_registry" --exclude="*.md" . | grep -v "# CI:DESTRUCTIVE_OK" | grep -v ".github/workflows" | wc -l)

                                                                                                                    if [ "$DOCKER_REFS" -gt 0 ]; then
                                                                                                                                echo "❌ FAIL: Found $DOCKER_REFS Docker references (Architecture Guide Section 2.1 violation)"
                                                                                                                                            grep -r "docker" --exclude-dir=".git" --exclude-dir="evidence_registry" --exclude="*.md" . | grep -v "# CI:DESTRUCTIVE_OK" | grep -v ".github/workflows"
                                                                                                                                                        exit 1
                                                                                                                                                                  else
                                                                                                                                                                              echo "✅ PASS: Zero Docker dependencies - Architecture Guide Section 2.1 compliant"
                                                                                                                                                                                        fi

  # Generate models
  generate-models:
    name: Generate Pydantic Models
    runs-on: ubuntu-latest
    needs: checkout
    if: contains(github.event.head_commit.modified, 'contracts/') || contains(github.event.head_commit.added, 'contracts/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install datamodel-code-generator[openapi] pydantic>=2.0.0
      
      - name: Generate Pydantic models
        run: |
          chmod +x scripts/generate-models.sh
          bash scripts/generate-models.sh
      
      - name: Verify model generation
        run: |
          if [ ! -f "backend/app/schemas/attribution.py" ] || [ ! -f "backend/app/schemas/auth.py" ]; then
            echo "ERROR: Model generation failed - required files not found"
            exit 1
          fi
          echo "Model generation successful"
