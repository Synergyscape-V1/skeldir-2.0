# R6 â€” Worker Resource Governance (Context Gathering)
name: "R6: Worker Resource Governance (Context Gathering)"

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'backend/app/**'
      - 'alembic/**'
      - 'scripts/r6/**'
      - '.github/workflows/r6-worker-resource-governance.yml'

jobs:
  r6-worker-resource-governance:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: r6_admin
          POSTGRES_PASSWORD: r6_admin
          POSTGRES_DB: r6
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U r6_admin -d r6"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      CI: "true"
      PYTHONPATH: backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/r6
      MIGRATION_DATABASE_URL: postgresql://r6_admin:r6_admin@127.0.0.1:5432/r6
      CELERY_BROKER_URL: sqla+postgresql://app_user:app_user@127.0.0.1:5432/r6
      CELERY_RESULT_BACKEND: db+postgresql://app_user:app_user@127.0.0.1:5432/r6
      CELERY_TASK_ACKS_LATE: "true"
      CELERY_TASK_REJECT_ON_WORKER_LOST: "true"
      CELERY_TASK_ACKS_ON_FAILURE_OR_TIMEOUT: "true"
      CELERY_WORKER_PREFETCH_MULTIPLIER: "1"
      CELERY_TASK_SOFT_TIME_LIMIT_S: "300"
      CELERY_TASK_TIME_LIMIT_S: "360"
      CELERY_WORKER_MAX_TASKS_PER_CHILD: "1"
      CELERY_WORKER_MAX_MEMORY_PER_CHILD_KB: "200000"
      CELERY_CHORD_UNLOCK_MAX_RETRIES: "5"
      CELERY_CHORD_UNLOCK_RETRY_DELAY_S: "2"
      CELERY_BROKER_ENGINE_POOL_SIZE: "2"
      CELERY_BROKER_ENGINE_MAX_OVERFLOW: "0"
      CELERY_RESULT_BACKEND_ENGINE_POOL_SIZE: "2"
      R6_POSTGRES_IMAGE: "postgres:16"
      R6_WORKER_LOG_PATH: r6_worker.log
      R6_PROBE_LOG_PATH: r6_probe.log

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: R6 SHA guard
        shell: bash
        run: |
          set -euo pipefail
          echo "R6_GITHUB_SHA=$GITHUB_SHA"
          head_sha="$(git rev-parse HEAD)"
          echo "R6_GIT_SHA=$head_sha"
          if [ "$head_sha" != "$GITHUB_SHA" ]; then
            echo "R6_SHA_MISMATCH head=$head_sha github=$GITHUB_SHA"
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt -r backend/requirements-dev.txt

      - name: Create least-privilege app_user role
        shell: bash
        env:
          PGPASSWORD: r6_admin
        run: |
          set -euo pipefail
          psql -h 127.0.0.1 -U r6_admin -d r6 <<'SQL'
          DO $$
          BEGIN
              IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
                  CREATE ROLE app_user LOGIN PASSWORD 'app_user' NOSUPERUSER NOCREATEDB NOCREATEROLE INHERIT;
              END IF;
          END
          $$;
          
          REVOKE CREATE ON SCHEMA public FROM PUBLIC;
          GRANT USAGE ON SCHEMA public TO app_user;
          GRANT CONNECT ON DATABASE r6 TO app_user;
          SQL

      - name: Run migrations
        shell: bash
        run: |
          set -euo pipefail
          alembic upgrade heads

      - name: Start Celery worker
        shell: bash
        run: |
          set -euo pipefail
          nohup celery -A app.celery_app.celery_app worker \
            --loglevel=INFO \
            --pool=prefork \
            --concurrency=2 \
            -Q housekeeping,maintenance,llm,attribution \
            --max-tasks-per-child "${CELERY_WORKER_MAX_TASKS_PER_CHILD}" \
            --max-memory-per-child "${CELERY_WORKER_MAX_MEMORY_PER_CHILD_KB}" \
            --logfile r6_worker.log \
            --pidfile /tmp/r6_worker.pid >/dev/null 2>&1 &
          sleep 5

      - name: Run R6 context gathering
        shell: bash
        env:
          R6_SHA: ${{ github.sha }}
          R6_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          python scripts/r6/r6_context_gathering.py

      - name: Print R6 runtime evidence
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          base="docs/validation/runtime/R6_context_gathering/${{ github.sha }}"
          echo "R6_CELERY_REPORT_LOG_BEGIN"
          cat "$base/R6_CELERY_REPORT.log" || true
          echo "R6_CELERY_REPORT_LOG_END"
          echo "R6_CELERY_INSPECT_CONF_LOG_BEGIN"
          cat "$base/R6_CELERY_INSPECT_CONF.log" || true
          echo "R6_CELERY_INSPECT_CONF_LOG_END"
          echo "R6_CELERY_INSPECT_STATS_LOG_BEGIN"
          cat "$base/R6_CELERY_INSPECT_STATS.log" || true
          echo "R6_CELERY_INSPECT_STATS_LOG_END"
          echo "R6_ACTIVE_QUEUES_LOG_BEGIN"
          cat "$base/R6_ACTIVE_QUEUES.log" || true
          echo "R6_ACTIVE_QUEUES_LOG_END"
          echo "R6_TASK_REGISTRY_LOG_BEGIN"
          cat "$base/R6_TASK_REGISTRY.log" || true
          echo "R6_TASK_REGISTRY_LOG_END"
          echo "R6_RUNTIME_SNAPSHOT_JSON_BEGIN"
          cat "$base/R6_CELERY_INSPECT_CONF.json" || true
          echo "R6_RUNTIME_SNAPSHOT_JSON_END"
          echo "R6_GAP_REPORT_BEGIN"
          cat "$base/R6_GAP_REPORT.md" || true
          echo "R6_GAP_REPORT_END"
          echo "R6_PROBE_TIMEOUT_JSON_BEGIN"
          cat "$base/R6_PROBE_TIMEOUT.json" || true
          echo "R6_PROBE_TIMEOUT_JSON_END"
          echo "R6_PROBE_RETRY_JSON_BEGIN"
          cat "$base/R6_PROBE_RETRY.json" || true
          echo "R6_PROBE_RETRY_JSON_END"
          echo "R6_PROBE_PREFETCH_JSON_BEGIN"
          cat "$base/R6_PROBE_PREFETCH.json" || true
          echo "R6_PROBE_PREFETCH_JSON_END"
          echo "R6_PROBE_RECYCLE_JSON_BEGIN"
          cat "$base/R6_PROBE_RECYCLE.json" || true
          echo "R6_PROBE_RECYCLE_JSON_END"
          echo "R6_PROBE_LOG_BEGIN"
          cat r6_probe.log || true
          echo "R6_PROBE_LOG_END"
          echo "R6_TASK_GOVERNANCE_MATRIX_BEGIN"
          cat "$base/R6_TASK_GOVERNANCE_MATRIX.md" || true
          echo "R6_TASK_GOVERNANCE_MATRIX_END"

      - name: Verify R6 runtime probes
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          import sys
          from pathlib import Path
          import re

          sha = os.environ.get("GITHUB_SHA") or ""
          base = Path("docs/validation/runtime/R6_context_gathering") / sha
          def read_json(name):
              path = base / name
              if not path.exists():
                  print(f"R6_VERIFY_MISSING_FILE {path}")
                  sys.exit(1)
              return json.loads(path.read_text(encoding="utf-8"))

          env = read_json("R6_ENV_SNAPSHOT.json")
          conf = read_json("R6_CELERY_INSPECT_CONF.json")
          timeout = read_json("R6_PROBE_TIMEOUT.json")
          retry = read_json("R6_PROBE_RETRY.json")
          recycle = read_json("R6_PROBE_RECYCLE.json")
          prefetch = read_json("R6_PROBE_PREFETCH.json")

          env_sha = env.get("R6_SHA")
          github_sha = env.get("github_sha") or sha
          if env_sha != sha or github_sha != sha:
              print(f"R6_VERIFY_SHA_FAIL env={env_sha} github={github_sha} expected={sha}")
              sys.exit(1)
          print(f"R6_VERIFY_SHA_OK {sha}")

          conf_summary = conf.get("conf", {})
          soft = conf_summary.get("task_soft_time_limit")
          hard = conf_summary.get("task_time_limit")
          max_tasks = conf_summary.get("worker_max_tasks_per_child")
          max_mem = conf_summary.get("worker_max_memory_per_child")
          prefetch_mult = conf_summary.get("worker_prefetch_multiplier")
          print(f"R6_VERIFY_BOUNDS soft={soft} hard={hard} max_tasks={max_tasks} max_mem={max_mem} prefetch={prefetch_mult}")
          if any(value in (None, 0, "") for value in (soft, hard, prefetch_mult)):
              sys.exit(1)
          if max_tasks in (None, 0) and max_mem in (None, 0):
              sys.exit(1)

          if not timeout.get("soft_limit_observed") or not timeout.get("hard_limit_observed"):
              print("R6_VERIFY_TIMEOUT_FAIL")
              sys.exit(1)
          print(f"R6_VERIFY_TIMEOUT_OK elapsed_s={timeout.get('elapsed_s')}")

          attempts = retry.get("attempt_numbers") or []
          attempt_max = retry.get("attempt_max")
          terminal_state = retry.get("terminal_state")
          if len(attempts) < 2 or attempt_max is None:
              print("R6_VERIFY_RETRY_FAIL no attempts")
              sys.exit(1)
          if terminal_state not in ("FAILURE", "REVOKED"):
              print(f"R6_VERIFY_RETRY_FAIL terminal_state={terminal_state}")
              sys.exit(1)
          print(f"R6_VERIFY_RETRY_OK attempts={attempts} terminal_state={terminal_state}")

          unique_pids = recycle.get("unique_pid_count")
          if unique_pids is None or unique_pids < 2:
              print("R6_VERIFY_RECYCLE_FAIL")
              sys.exit(1)
          print(f"R6_VERIFY_RECYCLE_OK unique_pids={unique_pids}")

          max_wait = prefetch.get("max_short_wait_s")
          threshold = prefetch.get("short_wait_threshold_s")
          if max_wait is None or threshold is None or max_wait > threshold:
              print(f"R6_VERIFY_PREFETCH_FAIL max_wait={max_wait} threshold={threshold}")
              sys.exit(1)
          print(f"R6_VERIFY_PREFETCH_OK max_wait={max_wait} threshold={threshold}")

          annotations = (conf.get("conf_full") or {}).get("task_annotations") or {}
          chord = annotations.get("celery.chord_unlock") or {}
          max_retries = chord.get("max_retries")
          delay = chord.get("default_retry_delay")
          backoff = chord.get("retry_backoff")
          jitter = chord.get("retry_jitter")
          print(f"R6_VERIFY_CHORD_UNLOCK max_retries={max_retries} delay={delay} backoff={backoff} jitter={jitter}")
          if not isinstance(max_retries, int) or max_retries <= 0:
              sys.exit(1)
          if not isinstance(delay, int) or delay <= 0:
              sys.exit(1)
          if backoff is None or jitter is None:
              sys.exit(1)
          print("R6_VERIFY_ALL_PASS true")
          PY

      - name: Stop Celery worker
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f /tmp/r6_worker.pid ]; then
            kill "$(cat /tmp/r6_worker.pid)" || true
          fi

      - name: Upload R6 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: r6-context-gathering-${{ github.sha }}
          path: |
            r6_worker.log
            r6_probe.log
            docs/validation/runtime/R6_context_gathering/${{ github.sha }}/
