name: b11-p2-secret-readiness-adjudication

on:
  pull_request:
    branches: [main]
  pull_request_target:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  b11-p2-secret-chokepoint-gate:
    name: b11-p2-secret-chokepoint-gate
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/skeldir
      AUTH_JWT_SECRET: ci-secret
      AUTH_JWT_PUBLIC_KEY_RING: ci-public-ring
      AUTH_JWT_ALGORITHM: RS256
      AUTH_JWT_ISSUER: https://issuer.skeldir.test
      AUTH_JWT_AUDIENCE: skeldir-api
      PLATFORM_TOKEN_ENCRYPTION_KEY: ci-platform-key
      PLATFORM_TOKEN_KEY_ID: ci-key-id
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-dev.txt

      - name: Enforce secret choke point static guard
        run: |
          python scripts/security/b11_p2_secret_chokepoint_guard.py --report docs/forensics/evidence/b11_p2/chokepoint_callsite_scan.txt

      - name: Run non-vacuous bypass tests
        run: |
          cd backend
          pytest tests/test_b11_p2_secret_chokepoint.py -q | tee ../docs/forensics/evidence/b11_p2/ci_non_vacuous_bypass_test_log.txt

      - name: Upload P2 static evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p2-static-evidence
          path: |
            docs/forensics/evidence/b11_p2/chokepoint_callsite_scan.txt
            docs/forensics/evidence/b11_p2/ci_non_vacuous_bypass_test_log.txt
            docs/forensics/evidence/b11_p2/PROOF_INDEX.md

  b11-p2-readiness-gate:
    name: b11-p2-readiness-gate
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: postgresql://app_user:app_user@127.0.0.1:5432/skeldir
      AUTH_JWT_SECRET: ci-secret
      AUTH_JWT_PUBLIC_KEY_RING: ci-public-ring
      AUTH_JWT_ALGORITHM: RS256
      AUTH_JWT_ISSUER: https://issuer.skeldir.test
      AUTH_JWT_AUDIENCE: skeldir-api
      PLATFORM_TOKEN_ENCRYPTION_KEY: ci-platform-key
      PLATFORM_TOKEN_KEY_ID: ci-key-id
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-dev.txt

      - name: Runtime probe - missing JWT readiness fails closed
        run: |
          cd backend
          pytest tests/test_b11_p2_readiness_hard_fail.py -q -k "jwt_secret_missing" | tee ../docs/forensics/evidence/b11_p2/runtime_probe_ready_missing_jwt.txt

      - name: Runtime probe - worker startup contract fails without DB
        run: |
          cd backend
          pytest tests/test_b11_p2_readiness_hard_fail.py -q -k "worker_boot_contract_fails_without_database_secret" | tee ../docs/forensics/evidence/b11_p2/runtime_probe_worker_startup_missing_db.txt

      - name: Run non-vacuous missing-secret tests
        run: |
          cd backend
          pytest tests/test_b11_p2_readiness_hard_fail.py -q | tee ../docs/forensics/evidence/b11_p2/ci_non_vacuous_missing_secret_test_log.txt

      - name: Upload P2 runtime evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: b11-p2-runtime-evidence
          path: |
            docs/forensics/evidence/b11_p2/runtime_probe_ready_missing_jwt.txt
            docs/forensics/evidence/b11_p2/runtime_probe_worker_startup_missing_db.txt
            docs/forensics/evidence/b11_p2/ci_non_vacuous_missing_secret_test_log.txt
            docs/forensics/evidence/b11_p2/PROOF_INDEX.md
