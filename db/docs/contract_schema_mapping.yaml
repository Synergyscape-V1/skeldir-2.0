# Contract→Schema Mapping (Machine-Readable)
# This YAML file enables future CI validation of contract compliance

types:
  openapi_string_uuid:
    postgres: uuid
    validation: "uuid format"
    example_contract: "api-contracts/openapi/v1/attribution.yaml:60-63"
    example_field: "tenant_id"
  
  openapi_string_datetime:
    postgres: timestamptz
    validation: "ISO 8601 format"
    example_contract: "api-contracts/openapi/v1/reconciliation.yaml:55-58"
    example_field: "last_run_at"
  
  openapi_number_float_currency:
    postgres: integer
    validation: "cents, CHECK >= 0"
    conversion: "API: revenue_cents / 100.0"
    example_contract: "api-contracts/openapi/v1/attribution.yaml:47-49"
    example_field: "total_revenue"
    rationale: "Integer arithmetic is exact, better performance than DECIMAL"
  
  openapi_boolean:
    postgres: boolean
    validation: "true/false"
    example_contract: "api-contracts/openapi/v1/attribution.yaml:52-54"
    example_field: "verified"
  
  openapi_integer:
    postgres: integer
    validation: "integer range"
    example_contract: "api-contracts/openapi/v1/attribution.yaml:56-59"
    example_field: "data_freshness_seconds"

nullability:
  required:
    postgres: "NOT NULL"
    exceptions:
      - name: "soft_delete"
        description: "Soft-delete fields (deleted_at) may be nullable"
      - name: "audit"
        description: "Optional audit metadata may be nullable"
      - name: "backward_compatibility"
        description: "New required fields may use NOT NULL DEFAULT <value> for migration safety"

enums:
  small_stable:
    postgres: "CHECK col IN (...)"
    threshold: 10
    example_contract: "api-contracts/openapi/v1/reconciliation.yaml:47-52"
    example_field: "state"
    example_values: ["idle", "running", "failed", "completed"]
  
  large_evolving:
    postgres: "lookup table"
    threshold: ">10 or frequently changing"
    rationale: "Lookup tables provide flexibility for evolving enums"

identifiers:
  primary_key:
    pattern: "id uuid PRIMARY KEY DEFAULT gen_random_uuid()"
    rationale: "UUIDs provide globally unique identifiers, prevent enumeration attacks"
  
  idempotency_key:
    pattern: "{tenant_id}:{event_id}"
    example: "550e8400-e29b-41d4-a716-446655440000:evt_12345"
    rationale: "Compound key format ensures idempotency across tenants and events"

timestamps:
  authoritative_clock: "now()"
  type: "timestamptz"
  rationale: "PostgreSQL now() provides server-side authoritative timestamps"
  monotonicity_notes:
    - "created_at is immutable (never updated)"
    - "updated_at is updated on every row modification"
    - "Domain-specific timestamps may differ from created_at"

entities:
  tenants:
    table: "tenants"
    contract_reference: "Referenced by all tenant-scoped tables via tenant_id FK"
    columns:
      - name: "id"
        type: "uuid"
        contract_mapping: "Primary key (no contract field)"
      - name: "name"
        type: "VARCHAR(255)"
        contract_mapping: "Tenant identification (no contract field)"
      - name: "created_at"
        type: "timestamptz"
        contract_mapping: "Audit trail (no contract field)"
      - name: "updated_at"
        type: "timestamptz"
        contract_mapping: "Audit trail (no contract field)"

  attribution_events:
    table: "attribution_events"
    contract_reference: "Supports webhook ingestion endpoints (shopify, stripe, paypal, woocommerce)"
    columns:
      - name: "id"
        type: "uuid"
        contract_mapping: "Primary key (no contract field)"
      - name: "tenant_id"
        type: "uuid"
        contract_mapping: "api-contracts/openapi/v1/attribution.yaml:60-63 (tenant_id: string uuid)"
      - name: "occurred_at"
        type: "timestamptz"
        contract_mapping: "Event timestamp (no contract field, domain-specific)"
      - name: "revenue_cents"
        type: "integer"
        contract_mapping: "api-contracts/openapi/v1/attribution.yaml:47-49 (total_revenue: number float) → revenue_cents (integer)"
      - name: "correlation_id"
        type: "uuid"
        contract_mapping: "api-contracts/openapi/v1/_common/components.yaml:17-23 (X-Correlation-ID header) → correlation_id (uuid)"
        stitching: "Links attribution_events, dead_events, attribution_allocations"
      - name: "external_event_id"
        type: "text"
        contract_mapping: "Webhook source event ID (e.g., Shopify order ID, PayPal transaction ID)"
        idempotency: "UNIQUE (tenant_id, external_event_id) for Shopify, PayPal, WooCommerce"
      - name: "raw_payload"
        type: "jsonb"
        contract_mapping: "Raw webhook payload (PII stripped per PRIVACY-NOTES.md)"

  dead_events:
    table: "dead_events"
    contract_reference: "Supports error handling for webhook ingestion failures"
    columns:
      - name: "id"
        type: "uuid"
        contract_mapping: "Primary key (no contract field)"
      - name: "tenant_id"
        type: "uuid"
        contract_mapping: "Tenant isolation (no contract field)"
      - name: "correlation_id"
        type: "uuid"
        contract_mapping: "api-contracts/openapi/v1/_common/components.yaml:17-23 (X-Correlation-ID header) → correlation_id (uuid)"
        stitching: "Links dead_events, attribution_events, attribution_allocations"
      - name: "source"
        type: "text"
        contract_mapping: "Source system identifier (shopify, stripe, paypal, woocommerce)"
      - name: "error_code"
        type: "text"
        contract_mapping: "Error classification (no contract field)"
      - name: "error_detail"
        type: "jsonb"
        contract_mapping: "Structured error information (no contract field)"
      - name: "raw_payload"
        type: "jsonb"
        contract_mapping: "Raw webhook payload that failed (PII stripped per PRIVACY-NOTES.md)"

  attribution_allocations:
    table: "attribution_allocations"
    contract_reference: "Supports attribution calculations and channel performance queries"
    columns:
      - name: "id"
        type: "uuid"
        contract_mapping: "Primary key (no contract field)"
      - name: "tenant_id"
        type: "uuid"
        contract_mapping: "Tenant isolation (no contract field)"
      - name: "event_id"
        type: "uuid"
        contract_mapping: "Foreign key to attribution_events (no contract field)"
      - name: "channel"
        type: "text"
        contract_mapping: "Channel identifier (e.g., google_search, facebook_ads). NOTE: Will be renamed to channel_code and FK-enforced via channel_taxonomy.code (Phase 3.3)"
        validation: "CHECK constraint (to be replaced with FK to channel_taxonomy.code - Phase 3.3)"
        fk_reference: "channel_taxonomy.code (FK enforced, replaces CHECK constraint)"
      - name: "allocation_ratio"
        type: "numeric(6,5)"
        contract_mapping: "Allocation ratio (0.0 to 1.0) - Phase 4A requirement"
        validation: "CHECK (allocation_ratio >= 0 AND allocation_ratio <= 1)"
        purpose: "Enable deterministic revenue accounting and sum-equality validation"
      - name: "model_version"
        type: "text"
        contract_mapping: "Attribution model version (semantic version string) - Phase 4A requirement"
        purpose: "Track which model version generated this allocation, enabling model rollups and sum-equality validation per model version"
      - name: "allocated_revenue_cents"
        type: "integer"
        contract_mapping: "Channel credit amount (no contract field)"
      - name: "correlation_id"
        type: "uuid"
        contract_mapping: "api-contracts/openapi/v1/_common/components.yaml:17-23 (X-Correlation-ID header) → correlation_id (uuid)"
        stitching: "Links attribution_allocations, attribution_events, dead_events"

  revenue_ledger:
    table: "revenue_ledger"
    contract_reference: "api-contracts/openapi/v1/attribution.yaml:39-64 (RealtimeRevenueResponse)"
    immutability_policy: "db/docs/IMMUTABILITY_POLICY.md"
    columns:
      - name: "id"
        type: "uuid"
        contract_mapping: "Primary key (no contract field)"
      - name: "tenant_id"
        type: "uuid"
        contract_mapping: "api-contracts/openapi/v1/attribution.yaml:60-63 (tenant_id: string uuid)"
      - name: "revenue_cents"
        type: "integer"
        contract_mapping: "api-contracts/openapi/v1/attribution.yaml:47-49 (total_revenue: number float) → revenue_cents (integer)"
      - name: "is_verified"
        type: "boolean"
        contract_mapping: "api-contracts/openapi/v1/attribution.yaml:52-54 (verified: boolean) → is_verified (boolean)"
      - name: "updated_at"
        type: "timestamptz"
        contract_mapping: "Used to calculate data_freshness_seconds (api-contracts/openapi/v1/attribution.yaml:56-59)"
      - name: "allocation_id"
        type: "uuid"
        contract_mapping: "Foreign key to attribution_allocations (nullable) - Phase 4C requirement"
        purpose: "Link ledger entry to specific allocation for allocation-based posting"
      - name: "posted_at"
        type: "timestamptz"
        contract_mapping: "Timestamp when revenue was posted - Phase 4C requirement"
        purpose: "Track posting time for audit trail and reconciliation"

  reconciliation_runs:
    table: "reconciliation_runs"
    contract_reference: "api-contracts/openapi/v1/reconciliation.yaml:39-64 (ReconciliationStatusResponse)"
    columns:
      - name: "id"
        type: "uuid"
        contract_mapping: "Primary key (no contract field)"
      - name: "tenant_id"
        type: "uuid"
        contract_mapping: "api-contracts/openapi/v1/reconciliation.yaml:60-63 (tenant_id: string uuid)"
      - name: "state"
        type: "VARCHAR(20)"
        contract_mapping: "api-contracts/openapi/v1/reconciliation.yaml:47-52 (state: enum idle|running|failed|completed) → state VARCHAR(20) CHECK"
      - name: "last_run_at"
        type: "timestamptz"
        contract_mapping: "api-contracts/openapi/v1/reconciliation.yaml:55-58 (last_run_at: string date-time) → last_run_at (timestamptz)"

correlation_stitching:
  description: "correlation_id enables event stitching across tables for forensic analysis"
  source: "X-Correlation-ID header (api-contracts/openapi/v1/_common/components.yaml:17-23)"
  tables:
    - name: "attribution_events"
      column: "correlation_id"
      purpose: "Link successful event ingestion to downstream processing"
    - name: "dead_events"
      column: "correlation_id"
      purpose: "Link failed event ingestion for error tracing"
    - name: "attribution_allocations"
      column: "correlation_id"
      purpose: "Link attribution model results to source events"
  reconstruction_rules:
    - rule: "Complete Event Flow"
      query: "Find all events related to correlation_id across all tables"
      tables: ["attribution_events", "dead_events", "attribution_allocations"]
    - rule: "Error Tracing"
      query: "Why did correlation_id fail?"
      tables: ["dead_events", "attribution_events"]
    - rule: "Attribution Chain"
      query: "Show attribution chain for correlation_id"
      tables: ["attribution_events", "attribution_allocations"]

sum_equality_invariant:
  description: "Sum-equality invariant ensures allocations sum to event revenue per (tenant_id, event_id, model_version)"
  specification: "db/docs/SUM_EQUALITY_INVARIANT.md"
  rounding_policy: "db/docs/ROUNDING_POLICY.md"
  tolerance: "±1 cent"
  enforcement:
    - mechanism: "Trigger function (check_allocation_sum)"
      purpose: "Real-time enforcement, raises exception if sum mismatch exceeds tolerance"
      location: "alembic/versions/202511131240_add_sum_equality_validation.py"
    - mechanism: "Materialized view (mv_allocation_summary)"
      purpose: "Reporting and validation, tracks drift and balanced status"
      location: "alembic/versions/202511131240_add_sum_equality_validation.py"
  validation:
    - test_script: "db/tests/test_sum_equality.sql"
      purpose: "Empirical validation of sum-equality invariant"

channel_taxonomy:
  description: "Canonical channel taxonomy enforced via FK, replacing CHECK constraints"
  specification: "B0.3_IMPLEMENTATION_COMPLETE.md (Phase 3.2)"
  table: "channel_taxonomy"
  primary_key: "code"
  contract_mapping:
    field_name: "channel_code"
    type: "string"
    description: "Channel code must match a value from channel_taxonomy.code"
    constraint: "FK to channel_taxonomy.code (database-enforced)"
  read_path:
    join_required: true
    join_table: "channel_taxonomy"
    exposed_fields:
      - "display_name"
      - "family"
      - "is_paid"
    query_pattern: "INNER JOIN channel_taxonomy ct ON aa.channel_code = ct.code WHERE ct.is_active = true"
  vendor_mapping:
    file: "db/channel_mapping.yaml"
    purpose: "Map vendor-specific channel indicators to canonical codes"
    ingestion_responsibility: "B0.4 ingestion service reads mapping file and normalizes channels"


