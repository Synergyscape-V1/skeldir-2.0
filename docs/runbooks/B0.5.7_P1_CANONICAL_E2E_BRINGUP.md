# B0.5.7-P1 - Canonical E2E Bring-Up (Docker Compose)

This runbook is the **single blessed** local bring-up path for a production-like topology:
- Postgres (persistence + Celery broker + results; Postgres-only)
- FastAPI API (`/health/live`, `/health/ready`, `/health/worker`, `/metrics`)
- Celery worker (no HTTP listener)
- Worker metrics exporter (`/metrics` on port **9108**)

## Prerequisites

- Docker Desktop running (Docker engine must respond to `docker ps`)
- Python is not required for bring-up (only for optional local pytest gate)

## One-command bring-up (blessed)

```powershell
.\scripts\e2e\up.ps1
```

## Teardown

Default teardown removes volumes (fresh DB next time):
```powershell
.\scripts\e2e\down.ps1
```

Keep volumes (preserve DB state):
```powershell
.\scripts\e2e\down.ps1 -KeepVolumes
```

## Port configuration (avoid collisions)

Override host ports via env vars:
- `SKELDIR_API_PORT` (default `18000`)
- `SKELDIR_EXPORTER_PORT` (default `9108`)
- `SKELDIR_DB_PORT` (default `15432`)

Example (use API port 18000):
```powershell
$env:SKELDIR_API_PORT="18000"
.\scripts\e2e\up.ps1
```

## Expected health checks

Assuming `SKELDIR_API_PORT=18000`:
```powershell
curl.exe -sS -i http://127.0.0.1:18000/health/live
curl.exe -sS -i http://127.0.0.1:18000/health/ready
curl.exe -sS -i http://127.0.0.1:18000/health/worker
```

Expected:
- `/health/live` -> `200`
- `/health/ready` -> `200`
- `/health/worker` -> `200` (requires worker running)

## Expected metrics checks (truthful scrape targets)

API `/metrics` (broker-truth only; must include `celery_queue_*`, must **not** include `celery_task_*`):
```powershell
curl.exe -sS http://127.0.0.1:$env:SKELDIR_API_PORT/metrics | findstr /i "celery_queue_"
curl.exe -sS http://127.0.0.1:$env:SKELDIR_API_PORT/metrics | findstr /i "celery_task_"
```

Exporter `/metrics` (worker/task metrics only; must include `celery_task_*` and `matview_refresh_*` after at least one refresh task):
```powershell
curl.exe -sS http://127.0.0.1:$env:SKELDIR_EXPORTER_PORT/metrics | findstr /i "celery_task_"
curl.exe -sS http://127.0.0.1:$env:SKELDIR_EXPORTER_PORT/metrics | findstr /i "matview_refresh_"
```

## Common failures

- **Docker engine off**: `docker ps` fails with a pipe error. Start Docker Desktop and retry `.\scripts\e2e\up.ps1`.
- **Port collision**: if `18000` is in use, set `SKELDIR_API_PORT` (example above).
- **Slow first pull/build**: first run downloads images and builds `backend/Dockerfile`.
