# B1.2-P2 Remediation Evidence

## Scope

Privacy-compliant auth substrate on `main` authority state:

- identity-at-rest contract
- users/memberships/roles schema substrate
- migration reversibility proof
- auth-substrate 0-PII audit proof
- tenant RLS isolation proof

## Hypothesis Adjudication

- `H01` (missing auth substrate tables): **Validated pre-fix**, remediated by migration `202602271430_b12_p2_auth_substrate.py`.
- `H02` (identity representation undefined under 0-PII): **Validated pre-fix**, remediated by `docs/security/identity_storage_contract.md`.
- `H03` (multi-tenant membership semantics missing): **Validated pre-fix**, remediated by `tenant_memberships` + uniqueness/FK constraints.
- `H04` (RLS posture unspecified for new auth tables): **Validated pre-fix**, remediated by RLS policies on `tenant_memberships` and `tenant_membership_roles`.
- `H05` (no automated 0-PII auth audit): **Validated pre-fix**, remediated by `scripts/security/b12_p2_auth_pii_guard.py` + tests + negative control.
- `H06` (migration reversibility unproven): **Validated pre-fix**, remediated by `test_01_auth_substrate_migration_reversibility`.

## Investigation Notes

### `app.current_user_id` semantics (pre-existing)

- Current runtime user context resolves through `app.core.identity.resolve_user_id`.
- Missing/invalid user values map to `SYSTEM_USER_ID = 00000000-0000-0000-0000-000000000000`.
- B1.2-P2 keeps this contract intact and does not assume token issuance/revocation behavior from later phases.

### Identity representation options evaluated

1. Store plaintext email in `users`: rejected (direct PII at rest).
2. Store reversible encrypted email in `users`: rejected for P2 substrate (still retains recoverable PII and increases key management/legal scope).
3. Store deterministic peppered hashes only: selected.

Selected representation:

- `users.login_identifier_hash`: deterministic peppered hash for login lookup.
- `users.external_subject_hash`: deterministic peppered hash for IdP subject lookup.
- No raw email/IP columns in auth substrate tables.

### CI enforcement placement

- Migration reversibility + RLS + auth PII positive audit:
  - existing required job `JWT Tenant Context Invariants`
- Non-vacuous auth PII negative control:
  - existing required job `Phase 1 Negative Controls` via `scripts/contracts/run_negative_controls.sh`

## Exit Gate Mapping

### Exit Gate 1: Identity-at-rest contract locked

- Proof:
  - `docs/security/identity_storage_contract.md`
- CI job:
  - `JWT Tenant Context Invariants` (consumes tests that enforce contract invariants against runtime schema)

### Exit Gate 2: Schema substrate present + reversible

- Proof:
  - `alembic/versions/007_skeldir_foundation/202602271430_b12_p2_auth_substrate.py`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_01_auth_substrate_migration_reversibility`
  - `backend/app/models/auth_substrate.py`
- CI job:
  - `JWT Tenant Context Invariants`

### Exit Gate 3: 0-PII audit non-vacuous and CI-enforced

- Proof:
  - `scripts/security/b12_p2_auth_pii_guard.py`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_03_auth_substrate_stores_no_raw_email_or_ip`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_04_auth_pii_guard_negative_control`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_05_auth_pii_guard_detects_real_raw_value_injection`
  - `scripts/contracts/run_negative_controls.sh` step `12/12`
- CI jobs:
  - `JWT Tenant Context Invariants` (positive proof)
  - `Phase 1 Negative Controls` (negative control proof)

### Exit Gate 4: Tenant isolation posture real for auth tables

- Proof:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_02_auth_membership_rls_isolation`
  - RLS policies in migration `202602271430_b12_p2_auth_substrate.py`
- CI job:
  - `JWT Tenant Context Invariants`

## Deliverable Checklist

- [x] `docs/security/identity_storage_contract.md`
- [x] Auth substrate migration + ORM models
- [x] Migration reversibility test
- [x] Auth-substrate PII guard + negative control
- [x] Evidence mapping document (`this file`)
