# B1.2 Context Inventory Report

Scope: forensic inventory only (`origin/main`), no implementation/refactor/migration/CI edits.

Main authority snapshot:
- `origin/main` SHA: `7e8f50ad9b4b7c48a812a384110996feaaeba411`
- Evidence pack root: `evidence/B1.2_context_inventory/`

## 1) System Reality Map

### HTTP auth + middleware chain
- Auth enforcement is dependency-based (`Depends(get_auth_context)`), not global JWT middleware.
- Request path (JWT-protected endpoints):
  1. Route dependency resolves bearer token and JWT claims.
  2. `tenant_id` claim is required; missing claim returns 401.
  3. DB dependency opens session with tenant/user GUC set via `set_config`.
  4. Handler executes SQL.
- Public/non-JWT families are explicit by dependency selection:
  - public/health/metrics routes with no JWT dependency
  - webhook routes with `tenant_secrets` + HMAC signature validation.

Evidence:
- `inventory/request_lifecycle_map.md`
- `inventory/endpoint_classification.csv`
- `inventory/route_dependency_inventory.tsv`
- `inventory/main_app_wiring_lines.txt`

### Tenant binding and RLS
- JWT claim -> tenant binding occurs in auth dependency.
- API DB session path sets:
  - `set_config('app.current_tenant_id', :tenant_id, false)`
  - `set_config('app.current_user_id', :user_id, false)`
- Missing `tenant_id` claim yields 401 before DB session/GUC calls.
- `SET LOCAL` is available in helper APIs and worker decorator flows, but API request session path currently uses session-scoped `set_config(..., false)`.

Evidence:
- `rls/db_session_guc_lines.txt`
- `rls/db_dependency_flow_lines.txt`
- `runtime/jwt_missing_tenant_prevents_db_session.json`

### Worker (Celery) async context propagation
- Canonical worker decorator exists: `@tenant_task`:
  - enforces `tenant_id`
  - sets contextvars
  - applies tenant/user GUC at task entry.
- Task families are mixed:
  - tenant-scoped families use `@tenant_task` or explicit tenant GUC before SQL
  - global/tenant-optional families exist (`refresh_all_matviews_global_legacy`, `pulse_matviews_global`, `health.probe`, optional-tenant housekeeping).
- Runtime probe confirms decorator behavior for one representative tenant task.

Evidence:
- `worker/task_decorator_matrix.csv`
- `worker/task_family_context_assessment.md`
- `worker/tenant_context_gap_search.txt`
- `runtime/tenant_task_runtime_probe.json`

### Non-JWT modality map
- Non-JWT route families are explicit and intentional:
  - health/liveness/metrics
  - webhooks using tenant key + provider HMAC signature verification.
- OpenAPI artifacts include `tenantKeyAuth` for webhook families and `bearerAuth` for JWT families.

Evidence:
- `non_jwt/webhook_hmac_lines.txt`
- `non_jwt/route_family_lines.txt`
- `non_jwt/openapi_auth_modality_lines.txt`
- `non_jwt/contract_scope_lines.txt`

### Data model readiness for B1.2 auth
- Present: tenant/business schema, platform credential encryption, webhook secret infrastructure.
- Not found in runtime models/migrations for B1.2 auth substrate:
  - users/memberships/roles data model for RBAC
  - refresh-token persistence store
  - denylist (`jti`) storage
  - `tokens_invalid_before` kill-switch substrate.

Evidence:
- `rls/auth_data_model_readiness_map.md`
- `rls/auth_model_absence_checks.txt`
- `jwt/revocation_feature_absence_checks.txt`

### JWT key-ring + secret substrate
- JWT key material is resolved through B1.1 secret choke point (`core/secrets.py`) with key-ring cache and unknown-`kid` refresh debounce.
- Verification path still calls `get_jwt_validation_config()` during request auth; that path calls secret retrieval for `AUTH_JWT_SECRET`.
- Under control-plane mode, secret retrieval path is uncached command-based AWS fetch; this creates per-request external secret-read risk despite key-ring cache.
- JWT algorithm is configurable (`HS256`/`RS256`), not hard-pinned to RS256 on `main`.

Evidence:
- `jwt/keyring_and_chokepoint_lines.txt`
- `jwt/jwt_config_contract_lines.txt`
- `jwt/jwt_rotation_tests_inventory.txt`

### CI gate state (inventory only)
- Required status checks contract includes `Phase 1 Runtime Conformance`.
- CI workflow shows `Phase 1 Runtime Conformance` job executes `tests/contract/test_contract_semantics.py`.
- Literal RD IDs (`RD-B07-3`, `RD-B01-1`) are not present in discovered CI artifacts.
- JWT->GUC tests exist in repo; explicit required-check enforcement for that integration gate is not evidenced.

Evidence:
- `ci/required_status_checks_contract.json`
- `ci/contract_semantics_required_check_lines.txt`
- `ci/rd_id_presence_search.txt`
- `ci/jwt_to_guc_test_presence_lines.txt`

## 2) Hypothesis Verdict Matrix (H01-H42)

See authoritative matrix with repro commands in:
- `evidence/B1.2_context_inventory/PROOF_INDEX.md`

Summary status:
- Validated YES: H02, H06, H10, H11, H15, H16, H17, H18, H21, H22, H23, H25, H30, H31, H32
- Refuted NO: H01, H03, H05, H09, H12, H14, H40, H41, H42
- Mixed/PARTIAL: H04, H13, H20
- Unknown: H08, H19, H24

## 3) Gap Register (vs B1.2 target state)

1. RBAC substrate gap
- No implemented role source-of-truth path (fat/thin/hybrid not present in code/data model).
- No Admin/Manager/Viewer enforcement path observed.

2. Token lifecycle gap
- Auth API endpoints are sample stubs; no durable refresh-token hashing/rotation implementation.
- No `jti` denylist or `tokens_invalid_before` kill-switch mechanism found.

3. JWT performance/security posture gap
- Key-ring cache exists, but verification path still hits secret retrieval config path each request (control-plane mode risk).
- Algorithm is configurable and not standardized to RS256 in current authority.

4. GUC scope consistency gap
- API session path uses session-scoped `set_config(..., false)` instead of local transaction-scoped semantics.

5. Worker context coherence gap
- Task context propagation is mixed; tenantless/global task paths remain active.
- No universal task context envelope including auth revocation primitives.

6. Error-contract uniformity gap
- Auth failure payload shapes differ by modality (Problem Details vs plain JSON), and diagnostic detail leakage differs by route family.

7. CI gate traceability gap
- Required checks and runtime conformance exist; RD-specific gate IDs for B1.2 prerequisites are not discoverable in current CI inventory.

## 4) Risk Register

1. GUC poisoning / tenant bleed risk
- Session-scoped GUC in API path can persist across pooled connection reuse if transaction boundaries are mishandled.

2. RLS posture uncertainty risk
- Runtime DB role anti-bypass posture (`rolsuper`, `rolbypassrls`) not re-proven in this inventory pack.

3. Async tenantless execution risk
- Non-tenant/global worker task families can execute without enforced tenant envelope semantics.

4. Non-JWT bricking risk
- Future blanket JWT enforcement would break webhook/HMAC ingestion paths unless modality boundaries remain explicit.

5. Error detail leakage risk
- Some auth failures expose reason/vendor diagnostics that increase oracle surface.

6. Logging signal degradation risk
- Runtime log formatting errors observed during probes can suppress operational evidence and complicate leak detection.

## 5) Implementation Preconditions (must be true before B1.2 coding)

1. Decide and codify RBAC source-of-truth model with immediate revocation semantics.
- Current forced-binary outcome: unimplemented (no fat/thin/hybrid path in authority code).
- Required B1.2 sentence from authority state: RBAC source of truth is unimplemented; hot-path authorization cost is undefined; revocation mechanism is absent.

2. Establish auth data model substrate
- users/memberships/roles + tenant scoping
- refresh-token hash store + rotate-on-use metadata
- denylist/kill-switch storage (`jti`, `tokens_invalid_before` or equivalent).

3. Standardize JWT verification path
- RS256 decision and key-ring/JWKS behavior
- eliminate per-request external secret fetch behavior in hot path.

4. Normalize tenant GUC semantics
- enforce transaction-local tenant/user binding in API and worker SQL paths with explicit proof tests.

5. Close worker coherence gaps
- require canonical task context envelope and tenant validation for every tenant-scoped task family.

6. Normalize non-leaky auth error contracts
- deterministic 401/403 schema with bounded detail across JWT and non-JWT modalities.

7. Bind CI gates to B1.2 prerequisites
- explicit required checks for contract semantics and JWT->GUC integration behavior.

---

Gate status summary:
- PASS: EG0, EG1, EG2, EG3, EG4, EG5, EG6, EG7, EG9
- FAIL: EG8, EG10

## 6) B1.2-P0 Contract + CI Adjudication Lock (Remediation Execution)

Scope constrained to contracts + CI wiring; no JWT feature implementation added.

Applied changes:
- Contract security scheme authority normalized:
  - `tenantKeyAuth` added to shared schema authority in `api-contracts/openapi/v1/_common/base.yaml`.
  - Webhook contracts now reference shared `tenantKeyAuth` (`shopify.yaml`, `woocommerce.yaml`, `stripe.yaml`, `paypal.yaml`) instead of local duplicate definitions.
- Contract adjudication strengthened:
  - `tests/contract/test_contract_semantics.py` now includes static topology/error-surface assertions that fail when:
    - JWT route families lose `bearerAuth`,
    - webhook families lose `tenantKeyAuth` or gain `bearerAuth`,
    - 401/403 responses drift from `application/problem+json` + canonical `ProblemDetails` surface.
- CI required check lock extended:
  - Added job `JWT Tenant Context Invariants` in `.github/workflows/ci.yml` running:
    - `tests/test_b060_phase1_auth_tenant.py::test_missing_tenant_claim_returns_401`
    - `backend/tests/test_b07_p1_identity_guc.py`
  - Added `JWT Tenant Context Invariants` to required contexts contract:
    - `contracts-internal/governance/b03_phase2_required_status_checks.main.json`.
- Non-vacuous negative controls expanded:
  - `scripts/contracts/run_negative_controls.sh` now includes negative controls for:
    - auth-topology drift,
    - 401 schema drift,
    - JWT missing-tenant invariant bypass.

Evidence artifacts generated:
- `docs/forensics/evidence/b12_p0/B1.2-P0_Adjudication_Map.md`
- `docs/forensics/evidence/b12_p0/auth_contract_inventory.json`
- `docs/forensics/evidence/b12_p0/runtime/negative_control_topology.txt`
- `docs/forensics/evidence/b12_p0/runtime/negative_control_error_schema.txt`
- `docs/forensics/evidence/b12_p0/runtime/negative_control_jwt_tenant.txt`
- Regenerator: `scripts/contracts/generate_b12_p0_adjudication_map.py`

Observed residual gap (evidence-backed):
- 403 canonical schema definition exists, but no current operations expose a 403 contract response in bundled specs (`operations_with_403_problem = 0` in `auth_contract_inventory.json`).
