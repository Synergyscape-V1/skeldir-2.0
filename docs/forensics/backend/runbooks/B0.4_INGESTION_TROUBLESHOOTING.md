# B0.4 Ingestion Troubleshooting Runbook

## Common Issues

### Events Routed to DLQ
- **Symptoms**: `/metrics` shows `events_dlq_total` rising; logs with `event_routed_to_dlq`.
- **Investigate**:
  - Check DLQ logs for `error_type` and `classification`.
  - Query DB: `SELECT * FROM dead_events WHERE tenant_id = :tenant_id ORDER BY ingested_at DESC LIMIT 10;`
  - Verify payload schema against `app/schemas/webhooks_*.py`.
  - Check signature headers for correctness.
- **Resolution**:
  - Fix payload/schema mismatch; retry via DLQ retry flow.
  - Correct signature secret or webhook configuration at vendor.

### High Duplicate Rate
- **Symptoms**: `events_duplicate_total` increasing; logs `duplicate_event_detected`.
- **Investigate**:
  - Confirm idempotency key derivation per vendor (`{vendor}_{event_type}_{primary_id}`).
  - Look for replayed webhook deliveries at vendor side.
- **Resolution**:
  - Deduplicate at source or adjust idempotency key mapping if incorrect.
  - Verify retries/backoff configuration at vendor.

### Slow Ingestion / Latency Spikes
- **Symptoms**: `ingestion_duration_seconds` p95 rising; webhook responses slow.
- **Investigate**:
  - Inspect DB latency; check connection saturation.
  - Validate channel normalization/cache.
  - Review recent deployments or schema changes.
- **Resolution**:
  - Increase pool size cautiously; cache channel mappings; enable batching in future B0.5.

### Tenant Cannot See Events (RLS)
- **Symptoms**: Tenant API returns no events; cross-tenant leakage suspected.
- **Investigate**:
  - Ensure `app.current_tenant_id` is set (health/ready RLS check).
  - Verify policies on `attribution_events`/`dead_events` (`relrowsecurity`, `relforcerowsecurity` true).
  - Check logs for missing tenant_id in context.
- **Resolution**:
  - Fix tenant resolution (API key hash), redeploy with correct DSN (`app_user`).
  - Re-run `/health/ready` to confirm.

## Useful Queries / Commands
- Recent DLQ entries: `SELECT id, error_type, classification, tenant_id, ingested_at FROM dead_events ORDER BY ingested_at DESC LIMIT 20;`
- Duplicate detection count: scrape `/metrics` for `events_duplicate_total`.
- RLS status: `SELECT relrowsecurity, relforcerowsecurity FROM pg_class WHERE relname='attribution_events';`

## Operational Hooks
- Metrics: `/metrics` (internal-only). Monitor `events_ingested_total`, `events_duplicate_total`, `events_dlq_total`, `ingestion_duration_seconds`.
- Health: `/health`, `/health/ready` (DB + RLS checks).
- Logs: JSON with `event`, `tenant_id`, `correlation_id_request`, `correlation_id_business`, `vendor`, `event_type`.

