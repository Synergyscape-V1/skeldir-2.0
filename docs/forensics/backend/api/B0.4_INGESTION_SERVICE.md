# B0.4 Ingestion Service API (Webhooks, Health, Metrics)

## Webhook Endpoints (All POST)
- Shopify: `/api/webhooks/shopify/order_create`
- Stripe: `/api/webhooks/stripe/payment_intent_succeeded`
- PayPal: `/api/webhooks/paypal/sale_completed`
- WooCommerce: `/api/webhooks/woocommerce/order_completed`

### Common Requirements
- Headers:
  - `X-Skeldir-Tenant-Key`: API key identifying tenant (required)
  - `X-Correlation-ID`: optional; generated if absent
  - Vendor signature header:
    - Shopify: `X-Shopify-Hmac-Sha256` (base64 HMAC-SHA256 of raw body)
    - Stripe: `Stripe-Signature` (timestamped HMAC per Stripe spec)
    - PayPal: `PayPal-Transmission-Sig` (HMAC-SHA256 hex)
    - WooCommerce: `X-WC-Webhook-Signature` (base64 HMAC-SHA256)
- Body: vendor-specific schema (see `app/schemas/webhooks_*.py`)
- Behaviour:
  - 200 success: `{"status": "success", "event_id": "...", "idempotency_key": "..."}`
  - 200 DLQ (validation failure): `{"status": "dlq_routed", "dead_event_id": "...", "error": "..."}`
  - 401 invalid signature/tenant: `{"status": "invalid_signature"|"invalid_tenant_key", "vendor": "<vendor>"}` (signature cases)

### Event Construction
- Idempotency key: UUIDv5 over `{vendor}_{event_type}_{vendor_primary_id}`
- Channel/vendor: vendor identifier normalized in ingestion
- Correlation IDs:
  - Request-level: `X-Correlation-ID` (header/auto)
  - Business-level: idempotency key propagated through ingestion/DLQ

## Health & Metrics
- `/health` (GET): liveness (200 if process up)
- `/health/ready` (GET): readiness (DB connect + RLS/GUC checks)
- `/metrics` (GET): Prometheus exposition; internal-only (restrict via infra)

## Quickstart: Adding a New Vendor Webhook
1) Define Pydantic schema and signature validation helper.  
2) Add router POST under `/api/webhooks/<vendor>/<event>` with:
   - Tenant resolution via `X-Skeldir-Tenant-Key`
   - Signature verification (401 on fail)
   - Idempotency key derivation and event_data mapping
   - Business correlation set to idempotency key
   - Call `ingest_with_transaction(...)`
3) Ensure logs include required fields; metrics labels use constrained sets.  
4) Add tests for success + invalid signature + metrics/log assertions.  
