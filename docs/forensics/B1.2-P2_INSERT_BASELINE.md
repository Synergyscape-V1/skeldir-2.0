# B1.2-P2 INSERT Corrective Baseline (FORCE RLS Gap)

## Scope

Baseline proof for B1.2-P2 corrective v3 on `main` before applying `users` INSERT remediation under FORCE RLS.

Database target used for baseline commands:

- `postgresql://postgres:postgres@localhost:5432/postgres`
- Alembic head at capture time: `202602281100`

## A) Policy Inventory (`public.users`)

Command:

```sql
SELECT polname, polcmd, polroles, pg_get_expr(polqual, polrelid), pg_get_expr(polwithcheck, polrelid)
FROM pg_policy
WHERE polrelid = 'public.users'::regclass
ORDER BY polname;
```

Observed rows:

- `users_self_select_policy` (`polcmd='r'`)
- `users_self_update_policy` (`polcmd='w'`)

No INSERT policy existed.

## B) RLS Flags (`public.users`)

Command:

```sql
SELECT relrowsecurity, relforcerowsecurity
FROM pg_class
WHERE oid = 'public.users'::regclass;
```

Observed:

- `relrowsecurity=true`
- `relforcerowsecurity=true`

## C) Role and Privilege Posture

Commands:

```sql
SELECT rolname, rolsuper, rolbypassrls
FROM pg_roles
WHERE rolname IN ('app_user','app_rw','app_ro')
ORDER BY rolname;
```

```sql
SELECT grantee, privilege_type
FROM information_schema.role_table_grants
WHERE table_schema='public' AND table_name='users'
ORDER BY grantee, privilege_type;
```

Observed:

- Role posture safe at baseline: `rolsuper=false`, `rolbypassrls=false` for all runtime roles.
- `app_user` had `SELECT, UPDATE` on `users`.
- `app_user` did not have `INSERT` on `users`.
- `app_rw`/`app_ro` had no `users` grants.

## D) Practical Pre-Auth Insert Attempt

Command pattern:

1. `SET ROLE app_user`
2. keep `app.current_user_id` unset/empty
3. attempt `INSERT INTO public.users (...) VALUES (...)`

Observed result:

- `insert_succeeded=false`
- error: `permission denied for table users`

Verdict: validated H01/H02/H03. Under FORCE RLS and current grants/policies, pre-auth provisioning insert was not viable.

## E) Provisioning Path Discovery

Code search for user creation paths (`INSERT INTO users`, `create_user`) found no active API/service provisioning flow in `backend/app` at baseline; writes appeared in migration/tests only.

Operationally, runtime DB identity defaults to `app_user` in existing runtime/CI scripts and test contracts.

## F) Schema Invariant Check (`users.tenant_id`)

Command:

```sql
SELECT COUNT(*)
FROM information_schema.columns
WHERE table_schema='public' AND table_name='users' AND column_name='tenant_id';
```

Observed:

- count `0`

Verdict: schema invariant held (`users.tenant_id` absent).
