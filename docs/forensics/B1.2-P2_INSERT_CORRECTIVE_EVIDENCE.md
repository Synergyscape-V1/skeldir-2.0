# B1.2-P2 INSERT Corrective Evidence (FORCE RLS Provisioning Viability)

## Summary

This patch closes the `users` INSERT viability gap introduced by FORCE RLS default-deny write semantics by adding:

- a narrowly scoped `FOR INSERT` policy on `public.users` for `app_user`
- `INSERT` table privilege on `public.users` for `app_user`
- CI-adjudicated proof that pre-auth insert works for writer role and fails when INSERT policy is removed

Baseline record:

- `docs/forensics/B1.2-P2_INSERT_BASELINE.md`

## Remediation Implemented

- Added migration:
  - `alembic/versions/007_skeldir_foundation/202602281430_b12_p2_users_insert_under_force_rls.py`
  - grants `INSERT` on `public.users` to `app_user` (guarded by role existence)
  - creates `users_provision_insert_policy`:
    - `FOR INSERT`
    - `TO app_user`
    - `WITH CHECK` enforcing non-empty `login_identifier_hash`, valid `auth_provider`, and non-null `id`
- Updated schema authority:
  - `db/schema/canonical_schema.sql`
- Extended auth substrate tests:
  - `backend/tests/test_b12_p2_auth_substrate.py`
  - `test_06` now asserts users INSERT policy existence
  - new `test_10_users_preauth_insert_viability_under_force_rls`
- Extended required negative controls:
  - `scripts/contracts/run_negative_controls.sh`
  - added `16/16` INSERT-policy regression control via `SKELDIR_B12_USERS_FORCE_DROP_INSERT_POLICY=1`

## Exit Gate Mapping

### Exit Gate 1 - INSERT Policy Exists and is Correctly Scoped

- Proof:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_06_users_registry_least_privilege_contract`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_10_users_preauth_insert_viability_under_force_rls`
- Asserts:
  - policy name `users_provision_insert_policy` exists
  - policy command is INSERT
  - policy roles include `app_user`

### Exit Gate 2 - Pre-auth Insert Viability Proof (CI)

- Proof:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_10_users_preauth_insert_viability_under_force_rls`
- Asserts:
  - `SET ROLE app_user` + unset/empty `app.current_user_id` can insert a new `users` row
  - `SET ROLE app_ro` cannot insert

### Exit Gate 3 - Non-vacuous Negative Control (INSERT Policy Regression)

- Negative control:
  - `scripts/contracts/run_negative_controls.sh` step `16/16`
  - `SKELDIR_B12_USERS_FORCE_DROP_INSERT_POLICY=1 pytest ... -k test_10_users_preauth_insert_viability_under_force_rls`
- Expected behavior:
  - test fails deterministically if INSERT policy is removed

### Exit Gate 4 - No Regression in Non-enumerability + RLS Posture

- Existing proofs preserved:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_06_users_registry_least_privilege_contract`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_07_users_registry_self_only_rls_and_non_enumerability`
- Existing negative controls preserved:
  - BYPASSRLS mutation
  - grant regression mutation
  - users RLS disable mutation

## Validation Trail

- Local positive:
  - `pytest backend/tests/test_b12_p2_auth_substrate.py -q` -> `10 passed`
- Local negative control:
  - `SKELDIR_B12_USERS_FORCE_DROP_INSERT_POLICY=1 pytest backend/tests/test_b12_p2_auth_substrate.py -q -k test_10_users_preauth_insert_viability_under_force_rls` -> fails on missing INSERT policy assertion (expected)
- Required harness:
  - `bash scripts/contracts/run_negative_controls.sh`

## CI / Main Adjudication

- PR: pending
- Main merge commit: pending
- Required check run links: pending
