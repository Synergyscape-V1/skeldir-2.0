# SKELDIR BACKEND PHASES B0.1-B0.3: TECHNICAL EVALUATION ANSWERS

**Analysis Date**: 2025-01-XX  
**Methodology**: Static code analysis, empirical code inspection, documentation review  
**Codebase**: II SKELDIR II monorepo

---

## PHASE B0.1: API CONTRACT DEFINITION

### Engineering Analyst: Billy

#### Section 1: Specification & Design Completeness

**Question 1: OpenAPI Specification Structure**

**Answer**: The OpenAPI 3.1 specifications are located in two parallel directory structures:

1. **Primary location**: `api-contracts/openapi/v1/` containing:
   - Domain APIs: `auth.yaml`, `attribution.yaml`, `reconciliation.yaml`, `export.yaml`, `health.yaml`
   - Webhooks: `webhooks/shopify.yaml`, `webhooks/stripe.yaml`, `webhooks/paypal.yaml`, `webhooks/woocommerce.yaml`
   - Common components: `_common/components.yaml`, `_common/pagination.yaml`, `_common/parameters.yaml`

2. **Alternative structure**: `contracts/` organized by domain:
   - `contracts/auth/v1/auth.yaml`
   - `contracts/attribution/v1/attribution.yaml`
   - `contracts/webhooks/v1/*.yaml`

**Evidence**: 
- `docs/redoc-config.yaml:6-23` lists all contract file paths
- `api-contracts/README.md:8-24` documents the structure
- `contracts/README.md:10-27` shows alternative organization

**Question 2: Authentication Schema Coverage**

**Answer**: JWT authentication is documented in `api-contracts/openapi/v1/auth.yaml`:

- **Login endpoint** (`/api/auth/login`): Lines 12-91
  - Request schema: `email` (string, format: email), `password` (string, format: password)
  - Response schema: `access_token`, `refresh_token`, `expires_in`, `token_type`
  - Example response at lines 79-85

- **Token refresh** (`/api/auth/refresh`): Lines 93-167
  - Requires BearerAuth security (line 101)
  - Request: `refresh_token` field
  - Response: New access and refresh tokens

- **Security scheme**: Defined in `_common/components.yaml:9-14`
  - Type: `http`, scheme: `bearer`, bearerFormat: `JWT`

**Evidence**: `api-contracts/openapi/v1/auth.yaml:223-225` references BearerAuth from common components

**Question 3: Error Response Standardization**

**Answer**: RFC 7807 Problem Details is implemented in `api-contracts/openapi/v1/_common/components.yaml`:

- **Problem schema** (lines 42-89):
  - Required fields: `type`, `title`, `status`, `detail`
  - Optional: `instance`, `error_id` (UUID, Skeldir extension), `correlation_id` (UUID, Skeldir extension)
  - Example at lines 82-89

- **Standard error responses**:
  - `Unauthorized` (401): Lines 92-121 with two examples (invalid_token, missing_token)
  - `TooManyRequests` (429): Lines 123-145 with rate limit headers
  - `InternalServerError` (500): Lines 147-163

**Evidence**: All endpoints reference these via `$ref: '../_common/components.yaml#/components/responses/Unauthorized'` (e.g., `auth.yaml:87`)

**Question 4: Webhook Schema Documentation**

**Answer**: Webhook payload schemas are documented in separate files:

- **Shopify** (`api-contracts/openapi/v1/webhooks/shopify.yaml`):
  - Endpoint: `/webhooks/shopify/orders/create` (line 12)
  - Payload: `id` (integer), `total_price` (string), `currency` (string), `created_at` (date-time)
  - HMAC signature: `X-Shopify-Hmac-Sha256` header (lines 30-35)

- **Stripe** (`api-contracts/openapi/v1/webhooks/stripe.yaml`):
  - Endpoint: `/webhooks/stripe/charge/succeeded` (line 12)
  - Payload: `id` (string), `amount` (integer, cents), `currency` (string), `created` (integer, Unix timestamp)
  - Signature: `Stripe-Signature` header (lines 30-35)

- **PayPal** (`api-contracts/openapi/v1/webhooks/paypal.yaml`):
  - Endpoint: `/webhooks/paypal/payment/sale/completed` (line 12)
  - Payload: `id` (string), `amount` (object with `total`, `currency`), `create_time` (date-time)
  - Signature: `PAYPAL-AUTH-ALGO`, `PAYPAL-CERT-URL`, `PAYPAL-TRANSMISSION-SIG` headers (lines 30-48)

- **WooCommerce** (`api-contracts/openapi/v1/webhooks/woocommerce.yaml`):
  - Endpoint: `/webhooks/woocommerce/order/created` (line 12)
  - Payload: `id` (integer), `total` (string), `currency` (string), `date_created` (date-time)
  - Signature: `X-WC-Webhook-Signature` header (lines 30-35)

**Evidence**: Each webhook file contains complete schema definitions with PII stripping documentation

**Question 5: Semantic Versioning Implementation**

**Answer**: Versioning is handled via `info.version` field in each OpenAPI file:

- All contracts specify `version: 1.0.0` in the `info` section
- Directory structure supports versioning: `openapi/v1/` suggests future `v2/` support
- Baselines stored in `api-contracts/baselines/v1.0.0/` for breaking change detection
- Version bumping process documented in `CHANGELOG.md:6` (Semantic Versioning)

**Evidence**: 
- `api-contracts/openapi/v1/auth.yaml:4` shows `version: 1.0.0`
- `api-contracts/baselines/v1.0.0/` contains frozen baseline versions

**Question 6: Example Coverage Strategy**

**Answer**: Examples are provided for:

- **Success cases**: All endpoints include `examples` sections (e.g., `auth.yaml:79-85`)
- **Error cases**: Error responses include examples (e.g., `_common/components.yaml:101-121` for 401 errors)
- **Edge cases**: 
  - Empty arrays not explicitly shown in current contracts
  - Null values handled via `nullable: true` in schemas (e.g., `pagination.yaml:44`)

**Evidence**: Examples found in:
- `auth.yaml:79-85` (login success)
- `attribution.yaml:66-72` (revenue response)
- `_common/components.yaml:101-121` (error examples)

**Question 7: Pagination Schema Consistency**

**Answer**: Pagination is standardized in `api-contracts/openapi/v1/_common/pagination.yaml`:

- **Parameters**:
  - `limit`: integer, 1-100, default 50 (lines 10-20)
  - `cursor`: string, base64-encoded, optional (lines 22-30)

- **Response envelope**: `PaginationMeta` schema (lines 33-57)
  - Required: `cursor` (nullable), `limit`, `has_more` (boolean)

- **Usage**: Referenced via `$ref` in endpoints (e.g., `export.yaml:39-40`)

**Evidence**: `api-contracts/openapi/v1/export.yaml:39-40` demonstrates cursor-based pagination usage

#### Section 2: Implementation & Paradigm Alignment

**Question 8: Pydantic Model Generation Automation**

**Answer**: Model generation is automated via `scripts/generate-models.sh`:

- **Script location**: `scripts/generate-models.sh`
- **Tool**: Uses `datamodel-codegen` (line 23)
- **Output directory**: `backend/app/schemas/` (line 15)
- **Process**:
  - Generates models for domains: attribution, auth, reconciliation, export (lines 30-53)
  - Generates models for webhooks: shopify, stripe, paypal, woocommerce (lines 56-79)
  - Creates `__init__.py` with imports (lines 82-116)

**Evidence**: Script generates models using `datamodel-codegen --input "$CONTRACT_FILE" --output "$SCHEMAS_DIR/${domain}.py"`

**Question 9: Contract Validation Pipeline**

**Answer**: CI/CD validation configured in `.github/workflows/contract-validation.yml`:

- **Workflow**: Validates on push/PR to `contracts/**/*.yaml`
- **Validation tool**: `@openapitools/openapi-generator-cli` (line 28)
- **Process**: Iterates through all contract files and validates each (lines 33-38)
- **Breaking change detection**: Separate job using `oasdiff` (lines 41-47)

**Evidence**: `.github/workflows/contract-validation.yml:30-38` shows validation loop

**Question 10: Breaking Change Detection Configuration**

**Answer**: Breaking change detection uses `oasdiff`:

- **Tool**: `github.com/Tufin/oasdiff` (installed via Go, line 58)
- **Command**: `oasdiff breaking "$baseline_file" "$file"` (line 69)
- **Baselines**: Stored in `api-contracts/baselines/v1.0.0/`
- **Script**: `scripts/detect-breaking-changes.sh` provides local validation

**Evidence**: `.github/workflows/contract-validation.yml:56-69` shows oasdiff installation and usage

**Question 11: Contract-to-Implementation Mapping**

**Answer**: No evidence of contract testing tools (Dredd/Pact) found in codebase:

- **Model generation**: Ensures type alignment (Pydantic models from contracts)
- **CI validation**: Ensures contract syntax correctness
- **No contract testing**: No test files found using Dredd or Pact

**Evidence**: Search for "dredd" and "pact" returns no results in codebase

**Question 12: Webhook Signature Validation Documentation**

**Answer**: Webhook signature requirements documented in each webhook contract:

- **Shopify**: `X-Shopify-Hmac-Sha256` header (HMAC-SHA256) - `shopify.yaml:30-35`
- **Stripe**: `Stripe-Signature` header (HMAC-SHA256 with timestamp) - `stripe.yaml:30-35`
- **PayPal**: `PAYPAL-AUTH-ALGO`, `PAYPAL-CERT-URL`, `PAYPAL-TRANSMISSION-SIG` (RSA-SHA256) - `paypal.yaml:30-48`
- **WooCommerce**: `X-WC-Webhook-Signature` header (HMAC-SHA256) - `woocommerce.yaml:30-35`

**Evidence**: Each webhook file documents signature headers in the `parameters` section

**Question 13: Rate Limiting Policy Documentation**

**Answer**: Rate limiting documented in `_common/components.yaml`:

- **Headers**:
  - `X-RateLimit-Limit`: Maximum requests per window (line 24-28, example: 100)
  - `X-RateLimit-Remaining`: Remaining requests (line 29-33)
  - `X-RateLimit-Reset`: Unix timestamp for window reset (line 34-39)

- **Response**: `TooManyRequests` (429) includes all rate limit headers (lines 123-145)
- **Policy**: 100 req/min per tenant mentioned in documentation but not explicitly in schema

**Evidence**: `api-contracts/openapi/v1/_common/components.yaml:24-39` defines rate limit headers

**Question 14: Multi-Currency Support Schema**

**Answer**: Multi-currency fields not explicitly documented in current contracts:

- **Attribution response** (`attribution.yaml:47-51`): Only shows `total_revenue` as float (dollars)
- **Webhook payloads**: Include `currency` fields (e.g., `shopify.yaml:65-67`)
- **Database schema**: Uses `currency VARCHAR(3)` and `conversion_value_cents INTEGER` (see B0.3 answers)

**Evidence**: Current API contracts show revenue in dollars, not multi-currency amounts

#### Section 3: Integration & Cross-Component Validation

**Question 15: Mock-to-Contract Synchronization**

**Answer**: Mock servers use volume mounts to stay synchronized:

- **Docker Compose**: `docker-compose.mock.yml:10` mounts `./api-contracts/openapi/v1:/contracts:ro`
- **Read-only mount**: Ensures mocks always use latest contracts
- **No rebuild required**: Prism reads contracts from mounted volume at runtime

**Evidence**: `docker-compose.mock.yml:10,27,44,55,66,83,94,105,116` show volume mounts for all services

**Question 16: Frontend Contract Consumption**

**Answer**: Frontend integration documented in `docs/frontend-mock-integration.md`:

- **Environment variables**: Lines 51-58 show `REACT_APP_API_URL` configuration
- **SDK usage**: No generated TypeScript SDK found in codebase
- **Manual integration**: Frontend uses fetch/axios with manual correlation ID generation (lines 67-132)

**Evidence**: `docs/frontend-mock-integration.md:51-58` documents environment variable setup

**Question 17: Webhook-to-Ingestion Contract Alignment**

**Answer**: Webhook schemas map to database via `attribution_events` table:

- **Idempotency**: Webhook `id` fields map to `external_event_id` or `idempotency_key`
- **Revenue**: Webhook amount fields map to `revenue_cents` or `conversion_value_cents`
- **Timestamps**: Webhook `created_at`/`created` map to `event_timestamp`

**Evidence**: See B0.3 answers for database schema details

**Question 18: Authentication Flow End-to-End**

**Answer**: Complete flow documented in contracts:

1. **Login** (`auth.yaml:12-91`): POST `/api/auth/login` → returns `access_token`, `refresh_token`
2. **Token usage**: Bearer token in `Authorization` header (referenced via `security: - BearerAuth: []`)
3. **Token refresh** (`auth.yaml:93-167`): POST `/api/auth/refresh` with `refresh_token` → new tokens
4. **Protected endpoints**: All domain APIs require `BearerAuth` (e.g., `attribution.yaml:19-20`)

**Evidence**: `api-contracts/openapi/v1/auth.yaml` contains complete authentication flow

#### Section 4: Testing & Performance Benchmarking

**Question 19: Contract Test Coverage Metrics**

**Answer**: No contract test coverage metrics found:

- **No Dredd/Pact**: No test files using contract testing tools
- **No coverage reports**: No evidence of contract test execution
- **CI validation**: Only syntax validation, not behavioral contract testing

**Evidence**: Search for "dredd", "pact", "contract test" returns no results

**Question 20: Example Response Validation**

**Answer**: No automated example validation found:

- **Examples present**: All contracts include examples
- **No validation**: No scripts or tests validate examples against schemas
- **Manual review**: Examples appear to be manually written

**Evidence**: No test files found that validate OpenAPI examples

**Question 21: Breaking Change Regression Testing**

**Answer**: Breaking change detection exists but no regression test suite:

- **Detection**: `oasdiff breaking` compares against baselines
- **No regression tests**: No test cases comparing N vs N-1 versions
- **CI integration**: Breaking changes fail CI but no test suite

**Evidence**: `.github/workflows/contract-validation.yml:69` shows breaking change detection

#### Section 5: Documentation & Knowledge Transfer

**Question 22: Migration Guide Templating**

**Answer**: Migration guide template exists at `api-contracts/MIGRATION_TEMPLATE.md`:

- **Structure**: Includes sections for breaking changes, non-breaking changes, timeline, support
- **Format**: Markdown template with placeholders
- **Usage**: Template for future version upgrades

**Evidence**: `api-contracts/MIGRATION_TEMPLATE.md:1-93` contains complete template

**Question 23: OpenAPI Documentation Hosting**

**Answer**: Documentation hosting configured in `docs/redoc-config.yaml`:

- **Redoc config**: Lists all contract files for aggregation (lines 5-23)
- **Local preview**: `redocly preview-docs` command documented (line 16)
- **Production**: Documentation served from `/docs` endpoint (mentioned in `docs/README.md:33`)

**Evidence**: `docs/redoc-config.yaml:1-45` shows Redoc configuration

**Question 24: Webhook Integration Documentation**

**Answer**: Webhook setup documented in each webhook contract file:

- **Shopify**: `shopify.yaml:19-27` describes HMAC-SHA256 validation
- **Stripe**: `stripe.yaml:19-27` describes signature validation
- **PayPal**: `paypal.yaml:19-27` describes RSA-SHA256 validation
- **WooCommerce**: `woocommerce.yaml:19-27` describes HMAC-SHA256 validation

**Evidence**: Each webhook file contains security and privacy documentation in the `description` field

---

### Engineering Analyst: Alex

**Question 1: OpenAPI Directory Location**

**Answer**: Primary location is `api-contracts/openapi/v1/` containing all domain and webhook contracts. Alternative structure exists in `contracts/` organized by domain.

**Evidence**: `api-contracts/README.md:8-24` and `docs/redoc-config.yaml:6-23`

**Question 2: Edge Case Examples**

**Answer**: Edge cases like empty arrays not explicitly shown. Null values handled via `nullable: true`. Examples focus on success cases.

**Evidence**: `api-contracts/openapi/v1/_common/pagination.yaml:44` shows nullable cursor

**Question 3: RFC 7807 Implementation**

**Answer**: Implemented in `_common/components.yaml:42-89` with Skeldir extensions (`error_id`, `correlation_id`).

**Evidence**: `api-contracts/openapi/v1/_common/components.yaml:42-89`

**Question 4: BearerAuth Security Attachment**

**Answer**: Attached via `security: - BearerAuth: []` in endpoint definitions (e.g., `attribution.yaml:19-20`).

**Evidence**: `api-contracts/openapi/v1/attribution.yaml:19-20`

**Question 5: Webhook Payload Structure**

**Answer**: Each webhook has separate file in `api-contracts/openapi/v1/webhooks/` directory.

**Evidence**: `api-contracts/openapi/v1/webhooks/shopify.yaml`, `stripe.yaml`, `paypal.yaml`, `woocommerce.yaml`

**Question 6: Rate Limiting Policy Location**

**Answer**: Rate limiting headers documented in `_common/components.yaml:24-39`. Policy (100 req/min) mentioned in docs but not in schema.

**Evidence**: `api-contracts/openapi/v1/_common/components.yaml:24-39`

**Question 7: Pagination Strategy**

**Answer**: Cursor-based pagination defined in `_common/pagination.yaml` with `limit` and `cursor` parameters.

**Evidence**: `api-contracts/openapi/v1/_common/pagination.yaml:9-57`

**Question 8: Pydantic Model Generation Workflow**

**Answer**: `scripts/generate-models.sh` uses `datamodel-codegen` to generate models in `backend/app/schemas/`.

**Evidence**: `scripts/generate-models.sh:14-15,23,34-36`

**Question 9: Model Generation Trigger**

**Answer**: CI workflow runs model generation on contract changes. Manual execution via `bash scripts/generate-models.sh`.

**Evidence**: `docs/CI_CD.md:69-77` mentions CI integration

**Question 10: Breaking Change Detection Integration**

**Answer**: `.github/workflows/contract-validation.yml:56-69` installs and runs `oasdiff breaking`.

**Evidence**: `.github/workflows/contract-validation.yml:56-69`

**Question 11: Version Bumping Process**

**Answer**: Semantic versioning documented in `CHANGELOG.md:6`. No explicit process for minor vs patch bumps found.

**Evidence**: `CHANGELOG.md:6` references Semantic Versioning

**Question 12: Parallel Version Support**

**Answer**: Directory structure `openapi/v1/` suggests future `v2/` support. No current parallel version implementation.

**Evidence**: Directory structure implies versioning support

**Question 13: Prohibited Technologies Prevention**

**Answer**: No schema-level prevention found. Architecture mandates documented but not enforced in contracts.

**Evidence**: No contract-level enforcement mechanisms found

**Question 14: Frontend SDK CI/CD Process**

**Answer**: No `@muk223/api-client` package found. No TypeScript SDK generation in CI.

**Evidence**: Search for "api-client" returns no results

**Question 15: Webhook-to-Schema Cross-Reference**

**Answer**: Webhook schemas map to `revenue_ledger` and `attribution_events` tables. See B0.3 answers for details.

**Evidence**: See B0.3 database schema answers

**Question 16: Prism Error Schema Consumption**

**Answer**: Prism uses `examples` from contracts. Error examples defined in `_common/components.yaml`.

**Evidence**: `api-contracts/openapi/v1/_common/components.yaml:101-121` contains error examples

**Question 17: Pydantic Model Usage Enforcement**

**Answer**: No enforcement mechanism found. Models generated but usage not validated.

**Evidence**: No validation scripts found for model usage

**Question 18: Contract Test Coverage Tool**

**Answer**: No Dredd or Pact found. No contract test coverage metrics.

**Evidence**: Search for "dredd", "pact" returns no results

**Question 19: Contract Validation Pipeline Testing**

**Answer**: No test PR found. Breaking change detection exists but not tested with intentional breaks.

**Evidence**: No test cases found

**Question 20: Generated Model Validation**

**Answer**: CI verifies model generation succeeds but no syntax/import validation found.

**Evidence**: `docs/CI_CD.md:69-77` mentions verification but no details

**Question 21: 401 Response Schema Test**

**Answer**: No test case found validating 401 responses for protected endpoints.

**Evidence**: No test files found

**Question 22: Migration Guide Template**

**Answer**: `api-contracts/MIGRATION_TEMPLATE.md` contains template.

**Evidence**: `api-contracts/MIGRATION_TEMPLATE.md:1-93`

**Question 23: Webhook Signature Verification Documentation**

**Answer**: Each webhook contract documents signature verification in description fields. No code examples found.

**Evidence**: `shopify.yaml:22`, `stripe.yaml:22`, `paypal.yaml:22`, `woocommerce.yaml:22`

**Question 24: API Documentation Site Generation**

**Answer**: Redoc configuration in `docs/redoc-config.yaml`. Local preview via `redocly preview-docs`.

**Evidence**: `docs/redoc-config.yaml:1-45` and `docs/README.md:9-17`

---

## PHASE B0.2: MOCK SERVER DEPLOYMENT

### Engineering Analyst: Billy

**Question 25: Docker Compose Configuration**

**Answer**: `docker-compose.mock.yml` defines 9 Prism services:
- `auth`: port 4010 (lines 4-19)
- `attribution`: port 4011 (lines 21-36)
- `reconciliation`: port 4012 (lines 38-47)
- `export`: port 4013 (lines 49-58)
- `health`: port 4014 (lines 60-75)
- `webhooks-shopify`: port 4015 (lines 77-86)
- `webhooks-woocommerce`: port 4016 (lines 88-97)
- `webhooks-stripe`: port 4017 (lines 99-108)
- `webhooks-paypal`: port 4018 (lines 110-119)

**Evidence**: `docker-compose.mock.yml:4-119`

**Question 26: Prism Service Definitions**

**Answer**: Each service uses command: `prism mock /contracts/[domain].yaml -p [port] -h 0.0.0.0`

- Example: `prism mock /contracts/auth.yaml -p 4010 -h 0.0.0.0` (line 13)
- Environment: `PRISM_ERRORS=true` (line 12)
- Volume: `./api-contracts/openapi/v1:/contracts:ro` (line 10)

**Evidence**: `docker-compose.mock.yml:13` shows command format

**Question 27: Port Allocation Strategy**

**Answer**: Ports 4010-4018 allocated sequentially:
- 4010: auth
- 4011: attribution
- 4012: reconciliation
- 4013: export
- 4014: health
- 4015-4018: webhooks (shopify, woocommerce, stripe, paypal)

**Evidence**: `docker-compose.mock.yml` and `docs/frontend-mock-integration.md:33-45`

**Question 28: Health Check Endpoints**

**Answer**: Health checks configured for:
- `auth`: Lines 14-19 (POST to `/api/auth/login`)
- `attribution`: Lines 31-36 (GET to `/api/attribution/revenue/realtime`)
- `health`: Lines 70-75 (GET to `/api/health`)

**Evidence**: `docker-compose.mock.yml:14-19,31-36,70-75`

**Question 29: Mock Server Startup Script**

**Answer**: `scripts/start-mocks.sh` workflow:
1. Pre-flight checks (contract files, Docker, ports) - lines 16-72
2. Start services via `docker-compose -f docker-compose.yml up -d` - line 76
3. Wait for containers - lines 79-95
4. Health check polling - lines 98-108
5. Liveness verification with curl - lines 111-166

**Evidence**: `scripts/start-mocks.sh:1-182`

**Question 30: Dynamic Response Example Configuration**

**Answer**: Prism uses `examples` from OpenAPI contracts. `Prefer` header enables error simulation (documented in `docs/frontend-mock-integration.md:287-328`).

**Evidence**: `docs/frontend-mock-integration.md:291-302` shows Prefer header usage

**Question 31: Mock-to-Contract Validation**

**Answer**: No automated validation found. Manual validation via contract syntax checks.

**Evidence**: No test files found for mock response validation

**Question 32: Environment Variable Management**

**Answer**: Environment variables set in Docker Compose:
- `PRISM_ERRORS=true` for all services
- No `.env` file found in codebase

**Evidence**: `docker-compose.mock.yml:12,29,46,57,68,85,96,107,118`

**Question 33: Container Orchestration**

**Answer**: No `restart` policy specified. Healthchecks configured but no restart policy.

**Evidence**: `docker-compose.mock.yml` shows no `restart:` directive

**Question 34: Log Aggregation Strategy**

**Answer**: Logs accessed via `docker-compose logs` commands documented in `docs/frontend-mock-integration.md:340-358`.

**Evidence**: `docs/frontend-mock-integration.md:340-358`

**Question 35: Frontend Integration Validation**

**Answer**: Frontend integration guide exists (`docs/frontend-mock-integration.md`) but no validation workflow documented.

**Evidence**: `docs/frontend-mock-integration.md:1-454`

**Question 36: Mock-to-Production Parity**

**Answer**: No validation strategy found. Mocks use contract examples but no parity testing.

**Evidence**: No test files found

**Question 37: Error Simulation Testing**

**Answer**: Error simulation documented but no test cases found. Uses `Prefer: code=401` header.

**Evidence**: `docs/frontend-mock-integration.md:287-328` documents but no tests

**Question 38: Cross-Service Mock Communication**

**Answer**: No cross-service dependencies documented. Auth token from 4010 could be used for other services but not tested.

**Evidence**: No test files found

**Question 39: Mock Server Latency Benchmarking**

**Answer**: No benchmark data found. 500ms threshold mentioned but not measured.

**Evidence**: No benchmark scripts or results found

**Question 40: Concurrent Request Handling**

**Answer**: No load test results found.

**Evidence**: No load testing scripts found

**Question 41: Uptime Monitoring Configuration**

**Answer**: Healthchecks configured but no monitoring infrastructure found. 99.9% SLA mentioned but not implemented.

**Evidence**: `docker-compose.mock.yml` has healthchecks but no monitoring

**Question 42: Mock Server Validation Test Suite**

**Answer**: No `tests/integration/test_mock_servers.py` found.

**Evidence**: No test file exists

**Question 43: Frontend Integration Guide**

**Answer**: `docs/frontend-mock-integration.md` contains:
- Environment variables (lines 51-58)
- Service URLs (lines 33-45)
- Error handling (lines 134-165)
- Error simulation (lines 287-328)
- Troubleshooting (lines 330-441)

**Evidence**: `docs/frontend-mock-integration.md:1-454`

**Question 44: Mock Server Troubleshooting Runbook**

**Answer**: Troubleshooting section in `docs/frontend-mock-integration.md:330-441` covers:
- Service status checks
- Log viewing
- Restart procedures
- Common errors

**Evidence**: `docs/frontend-mock-integration.md:330-441`

**Question 45: Mock-to-Production Migration Guide**

**Answer**: Migration documented in `docs/frontend-mock-integration.md` mentions updating `REACT_APP_API_URL` but no detailed guide.

**Evidence**: `docs/frontend-mock-integration.md:51-58` shows environment variable configuration

### Engineering Analyst: Alex

**Question 1-5: Docker Compose and Prism Configuration**

**Answer**: All answered above in Billy's questions 25-28.

**Question 6: Mock Server Startup Script**

**Answer**: `scripts/start-mocks.sh` - answered in Billy's question 29.

**Question 7: Contract Change Refresh Workflow**

**Answer**: Volume mounts are read-only, so Prism reads latest contracts without rebuild. Restart may be needed.

**Evidence**: `docker-compose.mock.yml:10` shows read-only mount

**Question 8: 429 Error Simulation**

**Answer**: Use `Prefer: code=429` header as documented in `docs/frontend-mock-integration.md:305-315`.

**Evidence**: `docs/frontend-mock-integration.md:305-315`

**Question 9: Realistic Data Configuration**

**Answer**: Prism uses examples from contracts. Examples include realistic UUIDs (e.g., `auth.yaml:82-83`).

**Evidence**: Contract examples contain realistic data

**Question 10: FE-1.2 Handoff**

**Answer**: No documented handoff process found.

**Evidence**: No documentation found

**Question 11: Mock Response Schema Validation**

**Answer**: No automated validation found.

**Evidence**: No test files found

**Question 12: Mock Data Consistency with Database**

**Answer**: No validation found ensuring mock data matches database constraints.

**Evidence**: No validation scripts found

**Question 13: Mock Auth Token Flow**

**Answer**: Mock auth server (4010) can return tokens, but no documented flow for using tokens with other mocks.

**Evidence**: No documented flow found

**Question 14: Latency Benchmarking Tool**

**Answer**: No benchmark tool or results found.

**Evidence**: No benchmark scripts found

**Question 15: Healthcheck Configuration**

**Answer**: Healthchecks configured in `docker-compose.mock.yml` for auth, attribution, and health services.

**Evidence**: `docker-compose.mock.yml:14-19,31-36,70-75`

**Question 16: Integration Test for Error Responses**

**Answer**: No `tests/integration/test_mock_servers.py` found.

**Evidence**: No test file exists

**Question 17: Uptime Monitoring**

**Answer**: No monitoring infrastructure found.

**Evidence**: No monitoring configuration found

**Question 18-20: Documentation**

**Answer**: All answered in Billy's questions 43-45.

---

## PHASE B0.3: DATABASE SCHEMA FOUNDATION

### Engineering Analyst: Billy

**Question 46: Core Schema Migration Files**

**Answer**: Core tables created in `alembic/versions/001_core_schema/202511131115_add_core_tables.py`:
- `tenants` (lines 54-96)
- `attribution_events` (lines 98-152)
- `dead_events` (lines 154-190)
- `attribution_allocations` (lines 192-236)
- `revenue_ledger` (lines 238-272)
- `reconciliation_runs` (lines 274-308)

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:40-308`

**Question 47: Foreign Key Constraint Topology**

**Answer**: Foreign keys:
- `attribution_events.tenant_id → tenants.id` (ON DELETE CASCADE) - line 102
- `dead_events.tenant_id → tenants.id` (ON DELETE CASCADE) - line 158
- `attribution_allocations.tenant_id → tenants.id` (ON DELETE CASCADE) - line 196
- `attribution_allocations.event_id → attribution_events.id` (ON DELETE CASCADE) - line 197
- `revenue_ledger.tenant_id → tenants.id` (ON DELETE CASCADE) - line 242
- `reconciliation_runs.tenant_id → tenants.id` (ON DELETE CASCADE) - line 278

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py` shows all FK definitions

**Question 48: Check Constraint Definitions**

**Answer**: Check constraints:
- `attribution_events.revenue_cents >= 0` (line 109, 116-118)
- `attribution_allocations.allocated_revenue_cents >= 0` (line 201, 208-210)
- `revenue_ledger.revenue_cents >= 0` (line 245, 253-255)
- `reconciliation_runs.state IN ('idle', 'running', 'failed', 'completed')` (line 282, 290-292)

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py` shows all CHECK constraints

**Question 49: Idempotency Key Design**

**Answer**: Idempotency enforced via unique indexes:
- `idx_attribution_events_tenant_external_event_id` on `(tenant_id, external_event_id)` WHERE `external_event_id IS NOT NULL` (lines 121-125)
- `idx_attribution_events_tenant_correlation_id` on `(tenant_id, correlation_id)` WHERE `correlation_id IS NOT NULL AND external_event_id IS NULL` (lines 127-131)

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:121-131`

**Question 50: Materialized View Definitions**

**Answer**: Materialized views created in:
- `202511131119_add_materialized_views.py`: `mv_realtime_revenue`, `mv_reconciliation_status`
- `202511151500_add_mv_channel_performance.py`: `mv_channel_performance`
- `202511151510_add_mv_daily_revenue_summary.py`: `mv_daily_revenue_summary` (referenced but file not read)

**Evidence**: 
- `alembic/versions/001_core_schema/202511131119_add_materialized_views.py:45-91`
- `alembic/versions/003_data_governance/202511151500_add_mv_channel_performance.py:70-101`

**Question 51: Row-Level Security Policies**

**Answer**: RLS policies created in `202511131120_add_rls_policies.py`:
- Policy name: `tenant_isolation_policy`
- SQL: `USING (tenant_id = current_setting('app.current_tenant_id')::uuid) WITH CHECK (...)` (lines 67-71)
- Applied to: attribution_events, dead_events, attribution_allocations, revenue_ledger, reconciliation_runs

**Evidence**: `alembic/versions/001_core_schema/202511131120_add_rls_policies.py:67-71`

**Question 52: Composite Index Strategy**

**Answer**: Composite indexes:
- `idx_attribution_events_tenant_occurred_at` on `(tenant_id, occurred_at DESC)` (lines 134-136)
- `idx_attribution_allocations_tenant_created_at` on `(tenant_id, created_at DESC)` (lines 214-216)
- `idx_revenue_ledger_tenant_updated_at` on `(tenant_id, updated_at DESC)` (lines 259-261)

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py` shows index definitions

**Question 53: JSONB Field Usage**

**Answer**: `raw_payload JSONB NOT NULL` in `attribution_events` (line 110). No GIN indexes found in core migration.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:110`

**Question 54: Cascade Deletion Policies**

**Answer**: All foreign keys use `ON DELETE CASCADE`:
- All `tenant_id` FKs: CASCADE (lines 102, 158, 196, 242, 278)
- `attribution_allocations.event_id`: CASCADE (line 197)

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py` shows all FK definitions

**Question 55: Audit Trigger Implementation**

**Answer**: No audit triggers found in core schema migrations. PII audit table created in `202511161210_add_pii_audit_table.py` (not read).

**Evidence**: No triggers in `202511131115_add_core_tables.py`

**Question 56: Materialized View Refresh Schedule**

**Answer**: Refresh policy documented in comments as "CONCURRENTLY with TTL-based refresh (30-60s)" but no Celery task found.

**Evidence**: `alembic/versions/001_core_schema/202511131119_add_materialized_views.py:63,90`

**Question 57: Migration Rollback Testing**

**Answer**: All migrations include `downgrade()` functions. No test cases found for rollback validation.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:311-330` shows downgrade function

**Question 58: Schema-to-Contract Alignment**

**Answer**: Materialized views align with contracts:
- `mv_realtime_revenue` → `RealtimeRevenueResponse` (attribution.yaml)
- `mv_reconciliation_status` → `ReconciliationStatusResponse` (reconciliation.yaml)

**Evidence**: 
- `alembic/versions/001_core_schema/202511131119_add_materialized_views.py:45-64`
- `api-contracts/openapi/v1/attribution.yaml:40-64`

**Question 59: Ingestion Service Schema Assumptions**

**Answer**: Schema supports idempotency via unique indexes on `(tenant_id, external_event_id)` and `(tenant_id, correlation_id)`. `processing_status` field exists for tracking.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:121-131`

**Question 60: Revenue Ledger Integration Points**

**Answer**: `revenue_ledger` table stores verified revenue aggregates. No direct webhook integration - events flow through `attribution_events` first.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:238-272`

**Question 61: Dead Events Queue Schema**

**Answer**: `dead_events` table structure (lines 155-166):
- `error_code` (text)
- `error_detail` (jsonb)
- `raw_payload` (jsonb)
- `correlation_id` (uuid)
- `external_event_id` (text)

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:155-166`

**Question 62: Index Usage Validation**

**Answer**: No `EXPLAIN ANALYZE` output found in codebase.

**Evidence**: No query plan files found

**Question 63: RLS Policy Performance Testing**

**Answer**: No benchmark data found comparing RLS vs non-RLS performance.

**Evidence**: No benchmark scripts found

**Question 64: Materialized View Refresh Performance**

**Answer**: No timing data found for refresh operations.

**Evidence**: No performance test results found

**Question 65: Migration Execution Time**

**Answer**: No measured execution times found.

**Evidence**: No timing data found

**Question 66: Concurrent Write Testing**

**Answer**: No load test results found.

**Evidence**: No load testing scripts found

**Question 67: Database Schema Documentation**

**Answer**: Schema documentation exists in `db/schema/canonical_schema.sql` and various markdown files in `db/schema/`.

**Evidence**: `db/schema/canonical_schema.sql:1-208` (partial read)

**Question 68: Migration Validation Script**

**Answer**: `scripts/validate-migration.sh` detects destructive operations:
- Patterns: DROP TABLE, DROP COLUMN, TRUNCATE, etc. (lines 59-69)
- Bypass: `# CI:DESTRUCTIVE_OK` comment (line 76)

**Evidence**: `scripts/validate-migration.sh:1-112`

**Question 69: Data Retention Policy Documentation**

**Answer**: No retention policy documentation or Celery tasks found.

**Evidence**: No retention policy files found

**Question 70: Schema Evolution Guidelines**

**Answer**: Guidelines exist in `db/schema/CHANGE_CONTROL.md` and related files (not read).

**Evidence**: File exists but not read

### Engineering Analyst: Alex

**Question 1: Alembic Migration File Location**

**Answer**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py` creates core tables.

**Evidence**: File exists and contains table definitions

**Question 2: PII Prohibition in Schema**

**Answer**: `attribution_events.raw_payload` stores JSONB but PII is stripped before persistence (documented in comments). No PII columns in schema.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:145-147` (comment)

**Question 3: Idempotency Constraint**

**Answer**: Unique indexes on `(tenant_id, external_event_id)` and `(tenant_id, correlation_id)` enforce idempotency.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:121-131`

**Question 4: Materialized View Migration**

**Answer**: `202511131119_add_materialized_views.py` creates `mv_realtime_revenue` and `mv_reconciliation_status`.

**Evidence**: `alembic/versions/001_core_schema/202511131119_add_materialized_views.py:45-91`

**Question 5: Dead Events Table Schema**

**Answer**: See Billy's question 61.

**Question 6: Revenue Ledger State Transitions**

**Answer**: `revenue_ledger` has `is_verified` and `verified_at` fields. `revenue_state_transitions` table created in `202511151450_create_revenue_state_transitions.py` (not read).

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:238-272`

**Question 7: RLS Policy SQL Syntax**

**Answer**: See Billy's question 51.

**Question 8: app.current_tenant_id Population**

**Answer**: Application must call `set_config('app.current_tenant_id', tenant_id::text, false)`. No implementation found.

**Evidence**: `alembic/versions/001_core_schema/202511131120_add_rls_policies.py:22-24` (comment)

**Question 9: Materialized View Without Redis**

**Answer**: Materialized views support 30-60s polling without cache. Refresh CONCURRENTLY enables non-blocking updates.

**Evidence**: `alembic/versions/001_core_schema/202511131119_add_materialized_views.py:18-19` (comment)

**Question 10: Composite Index Design**

**Answer**: Indexes use `(tenant_id, timestamp)` pattern for tenant-scoped time-series queries. No `INCLUDE` columns found in core migrations.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:134-136`

**Question 11: pg_trgm Extension Usage**

**Answer**: No `pg_trgm` extension found in migrations.

**Evidence**: No extension creation found

**Question 12: Schema Documentation ERD**

**Answer**: `docs/database-schema.md` mentioned but not found. Schema docs in `db/schema/` directory.

**Evidence**: `db/schema/` directory exists

**Question 13: Schema-to-Contract Data Type Alignment**

**Answer**: Contracts use `integer` for cents, database uses `INTEGER`. Alignment exists but not validated.

**Evidence**: Compare `attribution.yaml:48-49` (float dollars) vs database (INTEGER cents)

**Question 14: Dead Events Error Handling Support**

**Answer**: `dead_events` table supports error handling with `error_code`, `error_detail` (jsonb), and `raw_payload`.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:155-166`

**Question 15: app.current_tenant_id Population by Auth Service**

**Answer**: No implementation found. Architecture requires auth service to set tenant context.

**Evidence**: No implementation code found

**Question 16: Revenue Ledger Constraints vs Webhook Schemas**

**Answer**: Webhook schemas include `transaction_id`/`order_id` which map to `external_event_id` in events table, not directly to ledger.

**Evidence**: Webhook contracts vs database schema comparison

**Question 17: RLS Policy Test Case**

**Answer**: Test file exists: `db/tests/test_rls_isolation.sql` with cross-tenant denial tests.

**Evidence**: `db/tests/test_rls_isolation.sql:1-100` (partial read)

**Question 18: Migration Downgrade Testing**

**Answer**: All migrations have `downgrade()` functions but no test cases found.

**Evidence**: `alembic/versions/001_core_schema/202511131115_add_core_tables.py:311-330`

**Question 19: EXPLAIN ANALYZE Output**

**Answer**: No query plan output found.

**Evidence**: No EXPLAIN ANALYZE results found

**Question 20: Migration Validation CI/CD Script**

**Answer**: `scripts/validate-migration.sh` detects destructive operations.

**Evidence**: `scripts/validate-migration.sh:1-112`

**Question 21: CHECK Constraint Testing**

**Answer**: No test cases found validating CHECK constraints reject invalid data.

**Evidence**: No test files found

**Question 22: ERD Generation**

**Answer**: No ERD found. Schema documentation exists but no diagram.

**Evidence**: No ERD files found

**Question 23: Materialized View Refresh Schedule Documentation**

**Answer**: Refresh policy mentioned in migration comments but no schedule documentation found.

**Evidence**: `alembic/versions/001_core_schema/202511131119_add_materialized_views.py:18-19,63,90`

---

## SUMMARY

### Findings

**Strengths**:
- Complete OpenAPI 3.1 contract definitions
- Comprehensive database schema with RLS
- Docker Compose mock server setup
- Migration validation scripts
- Documentation structure in place

**Gaps**:
- No contract testing (Dredd/Pact)
- No automated example validation
- No performance benchmarks
- No load testing
- Limited integration test coverage
- No monitoring infrastructure
- No TypeScript SDK generation
- No ERD diagrams

**Recommendations**:
1. Implement contract testing with Dredd or Pact
2. Add automated example validation
3. Create performance benchmark suite
4. Implement monitoring for mock servers
5. Generate TypeScript SDK from contracts
6. Add integration tests for mock servers
7. Create ERD diagrams from schema
8. Document materialized view refresh schedules

---

**Document Status**: Local-only analysis, not for repository commit




