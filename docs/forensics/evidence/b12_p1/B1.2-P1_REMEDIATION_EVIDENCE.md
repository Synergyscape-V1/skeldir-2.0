# B1.2-P1 Remediation Evidence

Scope: Tenant Context Safety (transaction-local GUC binding; API + worker parity).

Primary branch authority: `main` code + required CI checks.

## Exit Gate 1 - API transaction ordering + pool-bleed proof
- Test: `backend/tests/test_b12_p1_tenant_context_safety.py::test_api_transaction_local_guc_ordering_and_no_pool_bleed`
- Invariants proven:
  - tenant/user GUC bind statements execute before tenant read statements inside request transaction.
  - forced pool reuse (`pool_size=1`) does not leak tenant context across requests.
- Negative controls (codified in `scripts/contracts/run_negative_controls.sh`):
  - `SKELDIR_B12_FORCE_SESSION_SCOPED_GUC=1` (session-scoped regression) must fail test.
  - `SKELDIR_B12_DISABLE_AFTER_BEGIN_GUC_BINDING=1` (ordering regression by removing post-BEGIN binding) must fail test.
- Merge-blocking job: `Phase 1 Negative Controls` and `JWT Tenant Context Invariants` in `.github/workflows/ci.yml`.
- Evidence links:
  - Green PR run: `PENDING`
  - Red mutation run: `PENDING`

## Exit Gate 2 - Worker pool lifecycle parity proof
- Test: `backend/tests/test_b12_p1_tenant_context_safety.py::test_worker_real_process_pool_reuse_no_bleed_and_tenant_envelope_required`
- Invariants proven:
  - real Celery worker subprocess (non-eager) executes tenant-scoped task in worker lifecycle.
  - forced pool reuse (`DATABASE_FORCE_POOLING=1`, pool size 1) does not bleed context across sequential tasks.
  - tenant envelope remains mandatory (`tenant_id` omission fails task).
- Negative control (codified in `scripts/contracts/run_negative_controls.sh`):
  - mutate `backend/app/tasks/context.py` to bypass tenant guard; test must fail.
- Merge-blocking job: `Phase 1 Negative Controls` and `JWT Tenant Context Invariants` in `.github/workflows/ci.yml`.
- Evidence links:
  - Green PR run: `PENDING`
  - Red mutation run: `PENDING`

## Exit Gate 3 - Missing-tenant preflight preserved
- Test: `tests/test_b060_phase1_auth_tenant.py::test_missing_tenant_claim_returns_401`
- Invariant proven:
  - missing `tenant_id` claim returns `401` before DB/GUC binding.
- Merge-blocking job: `JWT Tenant Context Invariants` in `.github/workflows/ci.yml`.
- Evidence links:
  - Green PR run: `PENDING`

## Exit Gate 4 - Enforcement plane compliance
- Required-check contract anchor: `contracts-internal/governance/b03_phase2_required_status_checks.main.json`.
- Execution surfaces:
  - Positive proofs run in `JWT Tenant Context Invariants`.
  - Non-vacuous negative controls run in `Phase 1 Negative Controls`.
- Evidence links:
  - Branch-protection required-check proof: `PENDING`
  - Merge-block proof run (intentional regression): `PENDING`
