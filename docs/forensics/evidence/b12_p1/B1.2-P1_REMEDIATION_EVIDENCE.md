# B1.2-P1 Remediation Evidence

Scope: Tenant Context Safety (transaction-local GUC binding; API + worker parity).

Primary branch authority: `main` code + required CI checks.

## Initial findings validated on code/runtime
- API tenant context binding was session-scoped (`set_config(..., false)`), which permits pool bleed risk.
- Worker context parity was not proven at real worker lifecycle by existing proofs.
- Deterministic pool-reuse adjudication was missing without forced reuse harnesses.
- Static governance scanner (`b11_p4_generate_static_scans.py`) initially failed on new P1 tests due direct `os.environ["DATABASE_URL"]` access; this blocked required `b11-p4`/`b11-p6` gates until corrected.

## Remediations implemented
- API transaction-local binding:
  - Added post-`BEGIN` binding via SQLAlchemy `after_begin` hook in `backend/app/db/session.py`.
  - Bound `app.current_tenant_id` and `app.current_user_id` transaction-locally (`set_config(..., true)`), sourced from session envelope/context.
- Worker parity:
  - Removed legacy side-transaction GUC behavior in `backend/app/tasks/context.py`.
  - Ensured worker task SQL uses transaction-local GUC semantics (housekeeping/maintenance paths).
  - Added real worker probe task and parity assertions in `backend/tests/test_b12_p1_tenant_context_safety.py`.
- Deterministic proofs and non-vacuity:
  - Added forced pool-reuse API + worker tests (`pool_size=1` / forced pooling).
  - Added codified negative controls in `scripts/contracts/run_negative_controls.sh` for:
    - API session-scoped regression
    - API post-BEGIN ordering regression
    - Worker envelope bypass regression
- CI/main adjudication unblock:
  - Replaced direct env secret access in P1 test with sanctioned accessor (`get_database_url()`), restoring required scanner compliance and unblocking `b11-p4-static-and-runtime-gate` and `b11-p6-closure-gates`.

## Merge to main + full green CI validation
- PR merged: `https://github.com/Synergyscape-V1/skeldir-2.0/pull/138`
- Merge commit on `main`: `9c9acec8ccd07e513601c8a347075b3955698b58` (merged at `2026-02-27T17:58:56Z`)
- Commit-scoped checks for merge SHA:
  - `30/30` check-runs successful
  - `0` in-progress, `0` failed
- Main push workflow evidence (all success for merge SHA):
  - CI: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707354`
  - b11-p4 gate pack: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707376`
  - b11-p6 closure pack: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707385`
  - Empirical validation: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707356`
  - Contract-first enforcement (post-run): `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497782596`

## Exit Gate 1 - API transaction ordering + pool-bleed proof
- Test: `backend/tests/test_b12_p1_tenant_context_safety.py::test_api_transaction_local_guc_ordering_and_no_pool_bleed`
- Invariants proven:
  - tenant/user GUC bind statements execute before tenant read statements inside request transaction.
  - forced pool reuse (`pool_size=1`) does not leak tenant context across requests.
- Negative controls (codified in `scripts/contracts/run_negative_controls.sh`):
  - `SKELDIR_B12_FORCE_SESSION_SCOPED_GUC=1` (session-scoped regression) must fail test.
  - `SKELDIR_B12_DISABLE_AFTER_BEGIN_GUC_BINDING=1` (ordering regression by removing post-BEGIN binding) must fail test.
- Merge-blocking job: `Phase 1 Negative Controls` and `JWT Tenant Context Invariants` in `.github/workflows/ci.yml`.
- Evidence links:
  - Green PR run: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22496857891/job/65173791704`
  - Green main run: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707354/job/65176683461`
  - Red mutation proof run (codified in harness): `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707354/job/65176683544`

## Exit Gate 2 - Worker pool lifecycle parity proof
- Test: `backend/tests/test_b12_p1_tenant_context_safety.py::test_worker_real_process_pool_reuse_no_bleed_and_tenant_envelope_required`
- Invariants proven:
  - real Celery worker subprocess (non-eager) executes tenant-scoped task in worker lifecycle.
  - forced pool reuse (`DATABASE_FORCE_POOLING=1`, pool size 1) does not bleed context across sequential tasks.
  - tenant envelope remains mandatory (`tenant_id` omission fails task).
- Negative control (codified in `scripts/contracts/run_negative_controls.sh`):
  - mutate `backend/app/tasks/context.py` to bypass tenant guard; test must fail.
- Merge-blocking job: `Phase 1 Negative Controls` and `JWT Tenant Context Invariants` in `.github/workflows/ci.yml`.
- Evidence links:
  - Green PR run: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22496857891/job/65173791704`
  - Green main run: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707354/job/65176683461`
  - Red mutation proof run (codified in harness): `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707354/job/65176683544`

## Exit Gate 3 - Missing-tenant preflight preserved
- Test: `tests/test_b060_phase1_auth_tenant.py::test_missing_tenant_claim_returns_401`
- Invariant proven:
  - missing `tenant_id` claim returns `401` before DB/GUC binding.
- Merge-blocking job: `JWT Tenant Context Invariants` in `.github/workflows/ci.yml`.
- Evidence links:
  - Green PR run: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22496857891/job/65173791704`
  - Green main run: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707354/job/65176683461`

## Exit Gate 4 - Enforcement plane compliance
- Required-check contract anchor: `contracts-internal/governance/b03_phase2_required_status_checks.main.json`.
- Execution surfaces:
  - Positive proofs run in `JWT Tenant Context Invariants`.
  - Non-vacuous negative controls run in `Phase 1 Negative Controls`.
- Evidence links:
  - Branch-protection required-check proof (PR checks): `https://github.com/Synergyscape-V1/skeldir-2.0/pull/138/checks`
  - Merge to main commit checks (all green): `https://github.com/Synergyscape-V1/skeldir-2.0/commit/9c9acec8ccd07e513601c8a347075b3955698b58/checks`
  - Merge-block non-vacuity proof (required negative controls): `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22497707354/job/65176683544`
