timestamp_utc=2026-02-20T21:45:12.929692+00:00
terraform_dir=/home/runner/work/skeldir-2.0/skeldir-2.0/infra/b11_p1/terraform
aws_region=us-east-2
state_bucket=skeldir-b11-p1-tfstate-326730685463-us-east-2
state_lock_table=skeldir-b11-p1-tf-locks
state_key=terraform.tfstate

# Import commands (executed only when state entries are missing):
terraform import -input=false -var environment=ci aws_iam_openid_connect_provider.github_actions arn:aws:iam::326730685463:oidc-provider/token.actions.githubusercontent.com
terraform import -input=false -var environment=ci aws_iam_role.runtime_prod skeldir-app-runtime-prod
terraform import -input=false -var environment=ci aws_iam_role.runtime_stage skeldir-app-runtime-stage
terraform import -input=false -var environment=ci aws_iam_role.ci_deploy skeldir-ci-deploy
terraform import -input=false -var environment=ci aws_iam_role.rotation_lambda skeldir-rotation-lambda

$ terraform fmt -check
exit_code=0
stdout=<empty>
stderr=<empty>

$ terraform init -backend-config=bucket=skeldir-b11-p1-tfstate-326730685463-us-east-2 -backend-config=key=terraform.tfstate -backend-config=region=us-east-2 -backend-config=dynamodb_table=skeldir-b11-p1-tf-locks -backend-config=encrypt=true -reconfigure -input=false
exit_code=0
stdout=[0m[1mInitializing the backend...[0m
[0m[32m
Successfully configured the backend "s3"! Terraform will automatically
use this backend unless the backend configuration changes.[0m
[0m[1mInitializing provider plugins...[0m
- Reusing previous version of hashicorp/aws from the dependency lock file
- Using previously-installed hashicorp/aws v6.33.0

[0m[1m[32mTerraform has been successfully initialized![0m[32m[0m
[0m[32m
You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.[0m
stderr=<empty>

$ terraform validate
exit_code=0
stdout=[32m[1mSuccess![0m The configuration is valid.
[0m
stderr=<empty>

$ terraform state list
exit_code=0
stdout=data.aws_caller_identity.current
data.aws_iam_openid_connect_provider.github_actions_live
data.aws_iam_role.ci_deploy_live
data.aws_iam_role.rotation_lambda_live
data.aws_iam_role.runtime_prod_live
data.aws_iam_role.runtime_stage_live
aws_iam_openid_connect_provider.github_actions
aws_iam_role.ci_deploy
aws_iam_role.rotation_lambda
aws_iam_role.runtime_prod
aws_iam_role.runtime_stage
stderr=<empty>

$ skip import aws_iam_openid_connect_provider.github_actions (already in state)
exit_code=0
stdout=already_in_state
stderr=<empty>

$ skip import aws_iam_role.runtime_prod (already in state)
exit_code=0
stdout=already_in_state
stderr=<empty>

$ skip import aws_iam_role.runtime_stage (already in state)
exit_code=0
stdout=already_in_state
stderr=<empty>

$ skip import aws_iam_role.ci_deploy (already in state)
exit_code=0
stdout=already_in_state
stderr=<empty>

$ skip import aws_iam_role.rotation_lambda (already in state)
exit_code=0
stdout=already_in_state
stderr=<empty>

$ terraform state list
exit_code=0
stdout=data.aws_caller_identity.current
data.aws_iam_openid_connect_provider.github_actions_live
data.aws_iam_role.ci_deploy_live
data.aws_iam_role.rotation_lambda_live
data.aws_iam_role.runtime_prod_live
data.aws_iam_role.runtime_stage_live
aws_iam_openid_connect_provider.github_actions
aws_iam_role.ci_deploy
aws_iam_role.rotation_lambda
aws_iam_role.runtime_prod
aws_iam_role.runtime_stage
stderr=<empty>

$ terraform state show aws_iam_openid_connect_provider.github_actions
exit_code=0
stdout=# aws_iam_openid_connect_provider.github_actions:
resource "aws_iam_openid_connect_provider" "github_actions" {
    arn             = "arn:aws:iam::326730685463:oidc-provider/token.actions.githubusercontent.com"
    client_id_list  = [
        "sts.amazonaws.com",
    ]
    id              = "arn:aws:iam::326730685463:oidc-provider/token.actions.githubusercontent.com"
    tags            = {}
    tags_all        = {}
    thumbprint_list = [
        "6938fd4d98bab03faadb97b34396831e3780aea1",
        "1c58a3a8518e8759bf075b76b750d4f2df264fcd",
    ]
    url             = "token.actions.githubusercontent.com"
}
stderr=<empty>

$ terraform state show aws_iam_role.runtime_prod
exit_code=0
stdout=# aws_iam_role.runtime_prod:
resource "aws_iam_role" "runtime_prod" {
    arn                   = "arn:aws:iam::326730685463:role/skeldir-app-runtime-prod"
    assume_role_policy    = jsonencode(
        {
            Statement = [
                {
                    Action    = "sts:AssumeRole"
                    Condition = {
                        StringEquals = {
                            "aws:SourceAccount" = "326730685463"
                        }
                    }
                    Effect    = "Allow"
                    Principal = {
                        Service = "ecs-tasks.amazonaws.com"
                    }
                    Sid       = "AllowECSTaskAssumption"
                },
            ]
            Version   = "2012-10-17"
        }
    )
    create_date           = "2026-02-18T19:35:31Z"
    description           = "Skeldir app runtime role for PROD - reads prod secrets/config only"
    force_detach_policies = false
    id                    = "skeldir-app-runtime-prod"
    managed_policy_arns   = []
    max_session_duration  = 3600
    name                  = "skeldir-app-runtime-prod"
    name_prefix           = [90mnull[0m[0m
    path                  = "/"
    permissions_boundary  = "arn:aws:iam::326730685463:policy/skeldir-permission-boundary"
    tags                  = {
        "Environment" = "prod"
        "Phase"       = "B1.1-P1"
        "Project"     = "skeldir"
    }
    tags_all              = {
        "Environment" = "prod"
        "Phase"       = "B1.1-P1"
        "Project"     = "skeldir"
    }
    unique_id             = "AROAUYEVKTQLYX3XONSKL"

    inline_policy {
        name   = "skeldir-app-runtime-prod-policy"
        policy = jsonencode(
            {
                Statement = [
                    {
                        Action   = [
                            "secretsmanager:GetSecretValue",
                            "secretsmanager:DescribeSecret",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/prod/*"
                        Sid      = "ReadProdSecrets"
                    },
                    {
                        Action   = [
                            "ssm:GetParameter",
                            "ssm:GetParameters",
                            "ssm:GetParametersByPath",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:ssm:us-east-2:326730685463:parameter/skeldir/prod/*"
                        Sid      = "ReadProdSSM"
                    },
                    {
                        Action   = "ssm:DescribeParameters"
                        Effect   = "Allow"
                        Resource = "*"
                        Sid      = "DescribeParameters"
                    },
                    {
                        Action    = [
                            "kms:Decrypt",
                            "kms:DescribeKey",
                        ]
                        Condition = {
                            StringEquals = {
                                "kms:ViaService" = [
                                    "secretsmanager.us-east-2.amazonaws.com",
                                    "ssm.us-east-2.amazonaws.com",
                                ]
                            }
                        }
                        Effect    = "Allow"
                        Resource  = "arn:aws:kms:us-east-2:326730685463:key/*"
                        Sid       = "KMSDecryptViaSM"
                    },
                    {
                        Action   = "secretsmanager:GetSecretValue"
                        Effect   = "Deny"
                        Resource = [
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/stage/*",
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/ci/*",
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/dev/*",
                        ]
                        Sid      = "DenyNonProdAccess"
                    },
                ]
                Version   = "2012-10-17"
            }
        )
    }
}
stderr=<empty>

$ terraform state show aws_iam_role.runtime_stage
exit_code=0
stdout=# aws_iam_role.runtime_stage:
resource "aws_iam_role" "runtime_stage" {
    arn                   = "arn:aws:iam::326730685463:role/skeldir-app-runtime-stage"
    assume_role_policy    = jsonencode(
        {
            Statement = [
                {
                    Action    = "sts:AssumeRole"
                    Condition = {
                        StringEquals = {
                            "aws:SourceAccount" = "326730685463"
                        }
                    }
                    Effect    = "Allow"
                    Principal = {
                        Service = "ecs-tasks.amazonaws.com"
                    }
                    Sid       = "AllowECSTaskAssumption"
                },
            ]
            Version   = "2012-10-17"
        }
    )
    create_date           = "2026-02-18T19:35:34Z"
    description           = "Skeldir app runtime role for STAGE - reads stage secrets/config only"
    force_detach_policies = false
    id                    = "skeldir-app-runtime-stage"
    managed_policy_arns   = []
    max_session_duration  = 3600
    name                  = "skeldir-app-runtime-stage"
    name_prefix           = [90mnull[0m[0m
    path                  = "/"
    permissions_boundary  = "arn:aws:iam::326730685463:policy/skeldir-permission-boundary"
    tags                  = {
        "Environment" = "stage"
        "Phase"       = "B1.1-P1"
        "Project"     = "skeldir"
    }
    tags_all              = {
        "Environment" = "stage"
        "Phase"       = "B1.1-P1"
        "Project"     = "skeldir"
    }
    unique_id             = "AROAUYEVKTQL6XC6SGZZH"

    inline_policy {
        name   = "skeldir-app-runtime-stage-policy"
        policy = jsonencode(
            {
                Statement = [
                    {
                        Action   = [
                            "secretsmanager:GetSecretValue",
                            "secretsmanager:DescribeSecret",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/stage/*"
                        Sid      = "ReadStageSecrets"
                    },
                    {
                        Action   = [
                            "ssm:GetParameter",
                            "ssm:GetParameters",
                            "ssm:GetParametersByPath",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:ssm:us-east-2:326730685463:parameter/skeldir/stage/*"
                        Sid      = "ReadStageSSM"
                    },
                    {
                        Action   = "ssm:DescribeParameters"
                        Effect   = "Allow"
                        Resource = "*"
                        Sid      = "DescribeParameters"
                    },
                    {
                        Action    = [
                            "kms:Decrypt",
                            "kms:DescribeKey",
                        ]
                        Condition = {
                            StringEquals = {
                                "kms:ViaService" = [
                                    "secretsmanager.us-east-2.amazonaws.com",
                                    "ssm.us-east-2.amazonaws.com",
                                ]
                            }
                        }
                        Effect    = "Allow"
                        Resource  = "arn:aws:kms:us-east-2:326730685463:key/*"
                        Sid       = "KMSDecryptViaSM"
                    },
                    {
                        Action   = "secretsmanager:GetSecretValue"
                        Effect   = "Deny"
                        Resource = [
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/prod/*",
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/ci/*",
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/dev/*",
                        ]
                        Sid      = "DenyNonStageAccess"
                    },
                ]
                Version   = "2012-10-17"
            }
        )
    }
}
stderr=<empty>

$ terraform state show aws_iam_role.ci_deploy
exit_code=0
stdout=# aws_iam_role.ci_deploy:
resource "aws_iam_role" "ci_deploy" {
    arn                   = "arn:aws:iam::326730685463:role/skeldir-ci-deploy"
    assume_role_policy    = jsonencode(
        {
            Statement = [
                {
                    Action    = "sts:AssumeRoleWithWebIdentity"
                    Condition = {
                        StringEquals = {
                            "token.actions.githubusercontent.com:aud" = "sts.amazonaws.com"
                        }
                        StringLike   = {
                            "token.actions.githubusercontent.com:sub" = "repo:Synergyscape-V1/skeldir-2.0:ref:refs/heads/main"
                        }
                    }
                    Effect    = "Allow"
                    Principal = {
                        Federated = "arn:aws:iam::326730685463:oidc-provider/token.actions.githubusercontent.com"
                    }
                    Sid       = "AllowGitHubActionsOIDC"
                },
            ]
            Version   = "2012-10-17"
        }
    )
    create_date           = "2026-02-18T19:35:36Z"
    description           = "Skeldir CI/CD role - GitHub Actions OIDC - reads CI secrets only"
    force_detach_policies = false
    id                    = "skeldir-ci-deploy"
    managed_policy_arns   = []
    max_session_duration  = 3600
    name                  = "skeldir-ci-deploy"
    name_prefix           = [90mnull[0m[0m
    path                  = "/"
    permissions_boundary  = "arn:aws:iam::326730685463:policy/skeldir-permission-boundary"
    tags                  = {
        "Environment" = "ci"
        "Phase"       = "B1.1-P4"
        "Project"     = "skeldir"
    }
    tags_all              = {
        "Environment" = "ci"
        "Phase"       = "B1.1-P4"
        "Project"     = "skeldir"
    }
    unique_id             = "AROAUYEVKTQLWEA2RJXDN"

    inline_policy {
        name   = "skeldir-ci-deploy-policy"
        policy = jsonencode(
            {
                Statement = [
                    {
                        Action   = [
                            "secretsmanager:GetSecretValue",
                            "secretsmanager:DescribeSecret",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/ci/*"
                        Sid      = "ReadCISecrets"
                    },
                    {
                        Action   = [
                            "ssm:GetParameter",
                            "ssm:GetParameters",
                            "ssm:GetParametersByPath",
                        ]
                        Effect   = "Allow"
                        Resource = [
                            "arn:aws:ssm:us-east-2:326730685463:parameter/skeldir/ci/*",
                            "arn:aws:ssm:us-east-2:326730685463:parameter/skeldir/shared/*",
                        ]
                        Sid      = "ReadCIAndSharedSSM"
                    },
                    {
                        Action   = "ssm:DescribeParameters"
                        Effect   = "Allow"
                        Resource = "*"
                        Sid      = "DescribeParameters"
                    },
                    {
                        Action    = [
                            "kms:Decrypt",
                            "kms:DescribeKey",
                        ]
                        Condition = {
                            StringEquals = {
                                "kms:ViaService" = [
                                    "secretsmanager.us-east-2.amazonaws.com",
                                    "ssm.us-east-2.amazonaws.com",
                                ]
                            }
                        }
                        Effect    = "Allow"
                        Resource  = "arn:aws:kms:us-east-2:326730685463:key/*"
                        Sid       = "KMSDecryptViaSM"
                    },
                    {
                        Action   = "secretsmanager:GetSecretValue"
                        Effect   = "Deny"
                        Resource = [
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/prod/*",
                            "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/stage/*",
                        ]
                        Sid      = "DenyProdStageSecretAccess"
                    },
                ]
                Version   = "2012-10-17"
            }
        )
    }
    inline_policy {
        name   = "tf-backend-access"
        policy = jsonencode(
            {
                Statement = [
                    {
                        Action   = "s3:ListBucket"
                        Effect   = "Allow"
                        Resource = "arn:aws:s3:::skeldir-b11-p1-tfstate-326730685463-us-east-2"
                        Sid      = "TFStateListBucket"
                    },
                    {
                        Action   = [
                            "s3:GetObject",
                            "s3:PutObject",
                            "s3:DeleteObject",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:s3:::skeldir-b11-p1-tfstate-326730685463-us-east-2/terraform.tfstate*"
                        Sid      = "TFStateObjectAccess"
                    },
                    {
                        Action   = [
                            "dynamodb:DescribeTable",
                            "dynamodb:GetItem",
                            "dynamodb:PutItem",
                            "dynamodb:DeleteItem",
                            "dynamodb:UpdateItem",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:dynamodb:us-east-2:326730685463:table/skeldir-b11-p1-tf-locks"
                        Sid      = "TFLockTableAccess"
                    },
                    {
                        Action   = [
                            "iam:GetRole",
                            "iam:ListRolePolicies",
                            "iam:ListAttachedRolePolicies",
                            "iam:GetRolePolicy",
                        ]
                        Effect   = "Allow"
                        Resource = [
                            "arn:aws:iam::326730685463:role/skeldir-app-runtime-prod",
                            "arn:aws:iam::326730685463:role/skeldir-app-runtime-stage",
                            "arn:aws:iam::326730685463:role/skeldir-ci-deploy",
                            "arn:aws:iam::326730685463:role/skeldir-rotation-lambda",
                        ]
                        Sid      = "TFImportIAMRoleRead"
                    },
                    {
                        Action   = [
                            "iam:ListOpenIDConnectProviders",
                            "iam:GetOpenIDConnectProvider",
                        ]
                        Effect   = "Allow"
                        Resource = "*"
                        Sid      = "TFImportOIDCRead"
                    },
                    {
                        Action   = [
                            "iam:GetPolicy",
                            "iam:GetPolicyVersion",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:iam::326730685463:policy/*"
                        Sid      = "TFImportManagedPolicyRead"
                    },
                ]
                Version   = "2012-10-17"
            }
        )
    }
}
stderr=<empty>

$ terraform state show aws_iam_role.rotation_lambda
exit_code=0
stdout=# aws_iam_role.rotation_lambda:
resource "aws_iam_role" "rotation_lambda" {
    arn                   = "arn:aws:iam::326730685463:role/skeldir-rotation-lambda"
    assume_role_policy    = jsonencode(
        {
            Statement = [
                {
                    Action    = "sts:AssumeRole"
                    Condition = {
                        StringEquals = {
                            "aws:SourceAccount" = "326730685463"
                        }
                    }
                    Effect    = "Allow"
                    Principal = {
                        Service = "lambda.amazonaws.com"
                    }
                    Sid       = "AllowLambdaAssumption"
                },
            ]
            Version   = "2012-10-17"
        }
    )
    create_date           = "2026-02-18T19:35:37Z"
    description           = "Skeldir rotation Lambda role - rotates secrets in skeldir/*/rotatable/* namespace"
    force_detach_policies = false
    id                    = "skeldir-rotation-lambda"
    managed_policy_arns   = []
    max_session_duration  = 3600
    name                  = "skeldir-rotation-lambda"
    name_prefix           = [90mnull[0m[0m
    path                  = "/"
    permissions_boundary  = "arn:aws:iam::326730685463:policy/skeldir-permission-boundary"
    tags                  = {
        "Phase"   = "B1.1-P3"
        "Project" = "skeldir"
    }
    tags_all              = {
        "Phase"   = "B1.1-P3"
        "Project" = "skeldir"
    }
    unique_id             = "AROAUYEVKTQL3AZHZIKKU"

    inline_policy {
        name   = "skeldir-rotation-lambda-policy"
        policy = jsonencode(
            {
                Statement = [
                    {
                        Action   = [
                            "secretsmanager:GetSecretValue",
                            "secretsmanager:DescribeSecret",
                            "secretsmanager:PutSecretValue",
                            "secretsmanager:UpdateSecretVersionStage",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:secretsmanager:us-east-2:326730685463:secret:skeldir/*/rotatable/*"
                        Sid      = "RotateSecrets"
                    },
                    {
                        Action   = "secretsmanager:GetRandomPassword"
                        Effect   = "Allow"
                        Resource = "*"
                        Sid      = "GetRandomPassword"
                    },
                    {
                        Action    = [
                            "kms:Decrypt",
                            "kms:Encrypt",
                            "kms:GenerateDataKey",
                            "kms:DescribeKey",
                        ]
                        Condition = {
                            StringEquals = {
                                "kms:ViaService" = "secretsmanager.us-east-2.amazonaws.com"
                            }
                        }
                        Effect    = "Allow"
                        Resource  = "arn:aws:kms:us-east-2:326730685463:key/*"
                        Sid       = "KMSForRotation"
                    },
                    {
                        Action   = [
                            "logs:CreateLogGroup",
                            "logs:CreateLogStream",
                            "logs:PutLogEvents",
                        ]
                        Effect   = "Allow"
                        Resource = "arn:aws:logs:us-east-2:326730685463:log-group:/aws/lambda/skeldir-rotation-*"
                        Sid      = "CloudWatchLogs"
                    },
                ]
                Version   = "2012-10-17"
            }
        )
    }
}
stderr=<empty>

$ terraform plan -detailed-exitcode -lock=true -input=false -var environment=ci -var manage_prefix_policies=false -var manage_namespace_placeholders=false
exit_code=0
stdout=[0m[1mdata.aws_iam_role.ci_deploy_live: Reading...[0m[0m
[0m[1mdata.aws_iam_role.runtime_prod_live: Reading...[0m[0m
[0m[1mdata.aws_caller_identity.current: Reading...[0m[0m
[0m[1mdata.aws_iam_openid_connect_provider.github_actions_live: Reading...[0m[0m
[0m[1mdata.aws_iam_role.rotation_lambda_live: Reading...[0m[0m
[0m[1mdata.aws_iam_role.runtime_stage_live: Reading...[0m[0m
[0m[1mdata.aws_caller_identity.current: Read complete after 0s [id=326730685463][0m
[0m[1mdata.aws_iam_role.rotation_lambda_live: Read complete after 0s [id=skeldir-rotation-lambda][0m
[0m[1maws_iam_role.rotation_lambda: Refreshing state... [id=skeldir-rotation-lambda][0m
[0m[1mdata.aws_iam_role.ci_deploy_live: Read complete after 0s [id=skeldir-ci-deploy][0m
[0m[1maws_iam_role.ci_deploy: Refreshing state... [id=skeldir-ci-deploy][0m
[0m[1mdata.aws_iam_role.runtime_prod_live: Read complete after 0s [id=skeldir-app-runtime-prod][0m
[0m[1maws_iam_role.runtime_prod: Refreshing state... [id=skeldir-app-runtime-prod][0m
[0m[1mdata.aws_iam_role.runtime_stage_live: Read complete after 0s [id=skeldir-app-runtime-stage][0m
[0m[1maws_iam_role.runtime_stage: Refreshing state... [id=skeldir-app-runtime-stage][0m
[0m[1mdata.aws_iam_openid_connect_provider.github_actions_live: Read complete after 0s [id=arn:aws:iam::326730685463:oidc-provider/token.actions.githubusercontent.com][0m
[0m[1maws_iam_openid_connect_provider.github_actions: Refreshing state... [id=arn:aws:iam::326730685463:oidc-provider/token.actions.githubusercontent.com][0m

[0m[1m[32mNo changes.[0m[1m Your infrastructure matches the configuration.[0m

[0mTerraform has compared your real infrastructure against your configuration
and found no differences, so no changes are needed.
stderr=<empty>

status=pass
