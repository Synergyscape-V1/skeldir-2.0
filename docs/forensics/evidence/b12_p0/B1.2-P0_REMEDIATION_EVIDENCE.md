# B1.2-P0 Remediation Evidence

## Scope
- Phase: `B1.2-P0 Contract + CI Adjudication Lock`
- Authority target: `origin/main`
- Remediation boundary: contracts + CI wiring only

## Findings (Pre-Remediation)
1. Auth topology contracts were partially fragmented.
- `tenantKeyAuth` was defined redundantly per webhook contract instead of centrally in shared contract authority.

2. Contract semantics adjudication had vacuity risk for auth topology + canonical auth error surfaces.
- Runtime contract test coverage did not explicitly fail on JWT/webhook security-mode drift and 401/403 payload media/schema drift.

3. Required-check contract did not include explicit JWT->tenant-context invariant gate.
- `Phase 1 Runtime Conformance` was required, but a dedicated invariant suite for missing `tenant_id` pre-DB denial + JWT->GUC binding was not listed as required context.

## Remediations Applied
1. Centralized security scheme authority.
- Added `tenantKeyAuth` to shared base contract:
  - `api-contracts/openapi/v1/_common/base.yaml`
- Updated webhook contracts to reference shared scheme:
  - `api-contracts/openapi/v1/webhooks/shopify.yaml`
  - `api-contracts/openapi/v1/webhooks/woocommerce.yaml`
  - `api-contracts/openapi/v1/webhooks/stripe.yaml`
  - `api-contracts/openapi/v1/webhooks/paypal.yaml`

2. Added explicit, non-vacuous contract adjudication assertions.
- Extended:
  - `tests/contract/test_contract_semantics.py`
- New assertions fail on:
  - JWT family missing `bearerAuth`
  - webhook family missing `tenantKeyAuth` or containing `bearerAuth`
  - `401/403` drift from `application/problem+json` + canonical `ProblemDetails`

3. Added dedicated JWT tenant-context invariant required check wiring.
- CI job added:
  - `.github/workflows/ci.yml`
  - Job: `JWT Tenant Context Invariants`
  - Executes:
    - `tests/test_b060_phase1_auth_tenant.py::test_missing_tenant_claim_returns_401`
    - `backend/tests/test_b07_p1_identity_guc.py`
- Required status check contract updated:
  - `contracts-internal/governance/b03_phase2_required_status_checks.main.json`

4. Strengthened non-vacuous proof harness.
- Expanded:
  - `scripts/contracts/run_negative_controls.sh`
- Added negative controls for:
  - auth topology drift
  - auth error schema drift
  - JWT missing-tenant invariant bypass

5. Added deterministic adjudication artifact generator.
- Added:
  - `scripts/contracts/generate_b12_p0_adjudication_map.py`
- Generated:
  - `docs/forensics/evidence/b12_p0/B1.2-P0_Adjudication_Map.md`
  - `docs/forensics/evidence/b12_p0/auth_contract_inventory.json`

## Validation Evidence (Local)
- Contract topology/error adjudication:
  - `pytest tests/contract/test_contract_semantics.py -q -k test_contract_auth_topology_and_error_surface`
  - Result: pass
- Missing-tenant denial invariant:
  - `pytest tests/test_b060_phase1_auth_tenant.py -q -k test_missing_tenant_claim_returns_401`
  - Result: pass
- JWT->GUC session binding invariant:
  - `pytest backend/tests/test_b07_p1_identity_guc.py -q`
  - Result: pass

## Non-Vacuous Negative Controls (Recorded)
- `docs/forensics/evidence/b12_p0/runtime/negative_control_topology.txt`
- `docs/forensics/evidence/b12_p0/runtime/negative_control_error_schema.txt`
- `docs/forensics/evidence/b12_p0/runtime/negative_control_jwt_tenant.txt`

## Commit + Push + Live Branch Protection Confirmation
- Pending in this document until push to `main` completes and required checks settle.
- Will record:
  - commit SHA
  - GitHub Actions run URL(s)
  - required-check statuses for the pushed SHA
  - branch protection `required_status_checks` evidence snapshot

