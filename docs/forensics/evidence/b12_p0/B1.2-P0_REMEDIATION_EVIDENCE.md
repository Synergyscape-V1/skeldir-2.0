# B1.2-P0 Remediation Evidence (Corrective Action)

## Scope
- Phase: `B1.2-P0 Contract + CI Adjudication Lock`
- Branch authority target: `main` (PR-only merge path)
- Remediation boundary: contracts, contract semantics tests, CI adjudication wiring, negative-control harness, and evidence artifacts

## Findings (Validated)
1. H01 validated: bundled contracts exposed `0` operations with canonical `403` despite shared `ForbiddenError` component availability.
2. H02 validated: `Validate Contracts` `oasdiff` step compared only sparse baseline files and could skip most bundled families.
3. H03 validated: `JWT Tenant Context Invariants` check executed HTTP + session tests but did not dispatch a Celery task through `@tenant_task`.
4. H04 validated: `run_negative_controls.sh` lacked explicit `403` drift and worker-plane `@tenant_task` bypass controls.

## Remediations Applied
1. Contract surface lock for `403`:
- Added canonical `403` references (`ForbiddenError`) to JWT-protected OpenAPI operations in:
  - `api-contracts/openapi/v1/attribution.yaml`
  - `api-contracts/openapi/v1/auth.yaml`
  - `api-contracts/openapi/v1/export.yaml`
  - `api-contracts/openapi/v1/health.yaml`
  - `api-contracts/openapi/v1/llm-budget.yaml`
  - `api-contracts/openapi/v1/llm-explanations.yaml`
  - `api-contracts/openapi/v1/llm-investigations.yaml`
  - `api-contracts/openapi/v1/reconciliation.yaml`
  - `api-contracts/openapi/v1/revenue.yaml`

2. Non-vacuous contract semantics enforcement:
- Updated `tests/contract/test_contract_semantics.py` to require, for JWT-protected non-public operations:
  - declared `bearerAuth`
  - declared `401` and `403`
  - canonical `application/problem+json` + `ProblemDetails`
- Added bundle-level assertion preventing 403 drift checks from becoming vacuous on JWT families.

3. Structural diff adjudication coverage lock:
- Updated `.github/workflows/ci.yml` (`Validate Contracts` job) to run `oasdiff breaking` against `origin/main` bundled artifacts for every current bundled family (`api-contracts/dist/openapi/v1/*.bundled.yaml`).
- Added hard-fail behavior when expected `origin/main` bundled counterpart is missing.

4. Worker-plane invariant adjudication:
- Extended `backend/tests/test_b07_p1_identity_guc.py` with Celery dispatch tests through `@tenant_task`:
  - `test_worker_tenant_task_rejects_missing_tenant_envelope`
  - `test_worker_tenant_task_attempts_guc_binding_before_task_sql`

5. Negative-control closure:
- Extended `scripts/contracts/run_negative_controls.sh` with:
  - `403` schema drift mutation control
  - worker `@tenant_task` tenant-envelope bypass mutation control
- Updated script sequencing to `8/8` controls.

6. Evidence/inventory regeneration:
- Updated `scripts/contracts/generate_b12_p0_adjudication_map.py` to publish `oasdiff` coverage mode and family list.
- Regenerated:
  - `docs/forensics/evidence/b12_p0/B1.2-P0_Adjudication_Map.md`
  - `docs/forensics/evidence/b12_p0/auth_contract_inventory.json`

## Local Validation Executed
- `pytest tests/contract/test_contract_semantics.py -q -k test_contract_auth_topology_and_error_surface` (pass)
- `pytest tests/test_b060_phase1_auth_tenant.py -q -k test_missing_tenant_claim_returns_401` (pass)
- `pytest backend/tests/test_b07_p1_identity_guc.py -q` (pass; includes new `@tenant_task` tests)
- `scripts/contracts/run_negative_controls.sh` partial execution:
  - controls 1 and 2 observed expected failures under mutation
  - local run halted at control 3 due missing local `go/oasdiff` toolchain

## Updated Inventory Outcomes
- `operations_with_403_problem`: `22` (was `0`)
- `oasdiff_coverage.mode`: `origin/main bundled contract comparison`
- `oasdiff_coverage.families`: 13 bundled families (all current bundles)

## CI/Branch Protection Evidence (Post-PR)
- PR link: _to be filled after push_
- Passing CI run link: _to be filled after completion_
- Negative-control CI failure proofs: _to be filled after completion_
- Required-check/branch-protection confirmation artifact: _to be filled after completion_
