# B1.2-P2 Corrective Evidence (Users Registry Least-Privilege)

## Summary

This corrective patch closes the Users Registry least-privilege gap by enforcing:

- self-only RLS + FORCE RLS on `public.users`
- non-enumerability of `users` under runtime roles
- a DB-enforced tenantless lookup boundary (`auth.lookup_user_by_login_hash`)
- CI-adjudicated role posture + grant posture + RLS posture + negative controls

## Initial Findings (Baseline)

Baseline investigation is recorded in `docs/forensics/B1.2-P2_CORRECTIVE_PROOF_BASELINE.md`.

- H01 validated: `users` was directly readable by `app_rw` and `app_ro`.
- H02 validated: `public.users` had no RLS and no FORCE RLS.
- H03 refuted at baseline snapshot: runtime roles were not superuser and not BYPASSRLS.
- H04 validated: no `auth.lookup_user_by_login_hash` boundary existed.
- H05 refuted at baseline snapshot: `users.tenant_id` was not present.

## Remediations Implemented

- Added corrective migration `202602281100` to:
  - revoke broad `users` reads from `app_rw`/`app_ro`
  - enforce `ENABLE ROW LEVEL SECURITY` + `FORCE ROW LEVEL SECURITY` on `public.users`
  - add self-only `SELECT`/`UPDATE` policies keyed to `app.current_user_id`
  - create `auth.lookup_user_by_login_hash(...)` as SECURITY DEFINER with exact-match lookup and minimal projection
  - grant function execute rights without granting broad table scan rights
- Updated canonical schema authority to include the same `users` RLS/force/policy/function posture.
- Extended corrective tests (`test_06`-`test_09`) to assert role posture, users non-enumerability, self-only users RLS, tenantless lookup boundary, and schema invariant (`users.tenant_id` absent).
- Wired 3 corrective negative controls into `scripts/contracts/run_negative_controls.sh`:
  - forced BYPASSRLS role
  - forced users grant regression
  - forced users RLS disablement

## Code Changes

- Migration:
  - `alembic/versions/007_skeldir_foundation/202602281100_b12_p2_users_registry_least_privilege.py`
- Canonical schema authority update:
  - `db/schema/canonical_schema.sql`
- Corrective tests:
  - `backend/tests/test_b12_p2_auth_substrate.py`
- CI negative control harness:
  - `scripts/contracts/run_negative_controls.sh`
- Contract doc update:
  - `docs/security/identity_storage_contract.md`
- Baseline investigation record:
  - `docs/forensics/B1.2-P2_CORRECTIVE_PROOF_BASELINE.md`

## Exit Gate Mapping

### Exit Gate 1 - Role Posture Hard Lock

- Proof:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_06_users_registry_least_privilege_contract`
- Negative control:
  - `SKELDIR_B12_USERS_FORCE_BYPASS_ROLE=1` path in `scripts/contracts/run_negative_controls.sh`

### Exit Gate 2 - Users Registry Non-Enumerability

- Proof:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_06_users_registry_least_privilege_contract`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_07_users_registry_self_only_rls_and_non_enumerability`
- Negative control:
  - `SKELDIR_B12_USERS_FORCE_GRANT_REGRESSION=1` path in `scripts/contracts/run_negative_controls.sh`

### Exit Gate 3 - Users Self-Only RLS

- Proof:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_06_users_registry_least_privilege_contract`
  - `backend/tests/test_b12_p2_auth_substrate.py::test_07_users_registry_self_only_rls_and_non_enumerability`
- Negative control:
  - `SKELDIR_B12_USERS_FORCE_DISABLE_RLS=1` path in `scripts/contracts/run_negative_controls.sh`

### Exit Gate 4 - Tenantless Lookup Boundary

- Proof:
  - `backend/tests/test_b12_p2_auth_substrate.py::test_08_tenantless_lookup_boundary_without_users_scan`
- Enforced boundary object:
  - `auth.lookup_user_by_login_hash` (SECURITY DEFINER, exact hash match, minimal projection)

### Exit Gate 5 - Enforcement Plane Compliance

- Merge-blocking jobs used:
  - `JWT Tenant Context Invariants` (runs `backend/tests/test_b12_p2_auth_substrate.py`)
  - `Phase 1 Negative Controls` (runs `scripts/contracts/run_negative_controls.sh`)

## Validation Evidence

- Positive local adjudication:
  - `pytest backend/tests/test_b12_p2_auth_substrate.py -q` -> `9 passed`
- Negative control adjudication (expected failure, non-vacuous):
  - `SKELDIR_B12_USERS_FORCE_BYPASS_ROLE=1 pytest ...::test_06... -q` -> fails on BYPASSRLS assertion
  - `SKELDIR_B12_USERS_FORCE_GRANT_REGRESSION=1 pytest ...::test_06... -q` -> fails on grant regression assertion
  - `SKELDIR_B12_USERS_FORCE_DISABLE_RLS=1 pytest ...::test_06... -q` -> fails on RLS posture assertion
- PR adjudication (merged):
  - PR: `https://github.com/Synergyscape-V1/skeldir-2.0/pull/143`
  - Merge commit: `29bce1176d48ed25032b245161779ce20e502a0f`
  - `JWT Tenant Context Invariants`: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22527505704/job/65261785801`
  - `Phase 1 Negative Controls`: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22527505704/job/65261785799`
  - `validate-schema-authority`: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22527505684/job/65261713523`
  - `Validate Migrations`: `https://github.com/Synergyscape-V1/skeldir-2.0/actions/runs/22527505704/job/65261720400`
- Main adjudication:
  - Main post-merge run set includes green checks on commit `29bce1176d48ed25032b245161779ce20e502a0f`.
  - Verification command: `gh api repos/Synergyscape-V1/skeldir-2.0/commits/29bce1176d48ed25032b245161779ce20e502a0f/check-runs` -> `in_progress=0`, `failed=0`.
