# B1.2-P3 PG Stampede Baseline (H01-H05)

## Scope
- Branch: `main` lineage before this corrective patch
- Baseline commit under inspection: `ca91974f9dbba44930ae66c2f896e8e6abf389cc`
- Method: static code-path inspection + existing CI test/wiring inspection

## H01 - Refresh coordination is process-local only
- **Validated (true)**.
- Evidence:
  - JWT unknown-`kid` debounce uses module globals + `threading.Lock`:
    - `backend/app/core/secrets.py:129`
    - `backend/app/core/secrets.py:130`
    - `backend/app/core/secrets.py:494`
    - `backend/app/core/secrets.py:502`
  - Verification ring cache is in-process memory with in-process lock:
    - `backend/app/core/secrets.py:71`
    - `backend/app/core/secrets.py:76`
    - `backend/app/core/secrets.py:77`
  - Unknown-`kid` refresh path calls `_refresh_jwt_verification_ring()` directly after local debounce:
    - `backend/app/core/secrets.py:447`
    - `backend/app/core/secrets.py:449`

## H02 - No fleet-grade coordination primitive exists
- **Validated (true)** for JWT verification refresh.
- Evidence:
  - No Postgres advisory lock call in JWT verifier/secret refresh path (`secrets.py` / `auth.py`).
  - Existing advisory lock helper is for matview refresh only:
    - `backend/app/core/pg_locks.py:64` (`try_acquire_refresh_xact_lock`)
    - lock keys are scoped to `view_name` + `tenant_id`, not JWT/JWKS domain:
      - `backend/app/core/pg_locks.py:46`
      - `backend/app/core/pg_locks.py:55`

## H03 - Refresh schedule lacks jitter/floor/backoff
- **Validated (true)**.
- Evidence:
  - Staleness uses fixed max-age threshold only (`age_seconds > max_staleness`), no jitter:
    - `backend/app/core/secrets.py:88`
    - `backend/app/core/secrets.py:90`
  - Unknown-`kid` debounce is fixed per-process window only; no fleet floor/backoff persistence:
    - `backend/app/core/secrets.py:496`
    - `backend/app/core/secrets.py:505`
  - No persisted retry/error cadence state for JWT verification key refresh in Postgres.

## H04 - Tests are not fleet-relevant (threads/process realism)
- **Validated (true)**.
- Evidence:
  - Existing unknown-`kid` flood test loops in one process:
    - `backend/tests/test_b11_p3_jwt_rotation_semantics.py:217`
    - `backend/tests/test_b11_p3_jwt_rotation_semantics.py:245`
  - Existing no-secret-fetch tests are single interpreter process:
    - `backend/tests/test_b12_p3_jwt_verification_standardization.py:77`
    - `backend/tests/test_b12_p3_jwt_verification_standardization.py:95`
    - `backend/tests/test_b12_p3_jwt_verification_standardization.py:114`
  - No `multiprocessing`/spawn-based JWT stampede proof present.

## H05 - Unknown-kid storm still triggers multiple refreshes across processes
- **Not directly proven by current tests; risk remains unrefuted**.
- Evidence basis:
  - Unknown-`kid` refresh gate is process-local only (H01).
  - No fleet-wide lock/cache primitive for JWT refresh (H02).
  - No OS-process adversarial test exists (H04).
- Scientific conclusion:
  - Given H01/H02/H04, multi-process unknown-`kid` storms can cause >1 concurrent refresh attempts fleet-wide.

## Current Refresh Call Graph (baseline)
1. HTTP plane and worker plane both call shared verifier:
   - `backend/app/security/auth.py:117`
   - `backend/app/tasks/context.py:79`
2. Verifier extracts `kid` then resolves keys:
   - `backend/app/security/auth.py:90`
   - `backend/app/security/auth.py:100`
3. Key resolver:
   - primary source: in-process cached verification ring
     - `backend/app/core/secrets.py:395`
   - unknown-`kid`: process-local debounce then direct refresh from source-of-truth
     - `backend/app/core/secrets.py:447`
     - `backend/app/core/secrets.py:449`
4. Source-of-truth read can hit control plane/AWS path:
   - `backend/app/core/secrets.py:167`
   - `backend/app/core/secrets.py:172`

## Baseline Ruling
- P3 remains blocked under fleet physics: boundedness exists only per process.
- Corrective path required: Postgres advisory-lock singleflight + Postgres shared JWKS cache + jitter/floor/backoff + OS-process CI proofs + non-vacuous negative control.
