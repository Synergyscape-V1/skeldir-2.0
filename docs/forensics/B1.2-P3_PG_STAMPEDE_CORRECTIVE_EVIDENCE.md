# B1.2-P3 PG Stampede Corrective Evidence

## 1) Initial Findings
- Baseline evidence doc: `docs/forensics/B1.2-P3_PG_STAMPEDE_BASELINE.md`
- Scientific baseline conclusion:
  - JWT refresh coordination was process-local only (`threading.Lock` + in-process cache).
  - No Postgres fleet-wide singleflight or shared JWKS cache row existed.
  - No OS-process (`spawn`) adversarial proof in CI.

## 2) Remediations Implemented
- Postgres-backed cache + singleflight:
  - Added singleton shared cache table migration:
    - `alembic/versions/007_skeldir_foundation/202603011930_b12_p3_pg_jwt_verification_cache.py`
  - Added Postgres advisory lock singleflight + shared cache read path in verifier secrets layer:
    - `backend/app/core/secrets.py`
- Refresh physics:
  - TTL jitter (`SKELDIR_JWT_REFRESH_JITTER_SECONDS`)
  - fleet min-refresh floor (`SKELDIR_JWT_REFRESH_MIN_FLOOR_SECONDS`)
  - fleet backoff (`SKELDIR_JWT_REFRESH_BACKOFF_BASE_SECONDS`, `SKELDIR_JWT_REFRESH_BACKOFF_MAX_SECONDS`)
- Fleet mutation toggle for negative control:
  - `SKELDIR_B12_P3_DISABLE_PG_SINGLEFLIGHT`
- New process-level tests:
  - `backend/tests/test_b12_p3_pg_fleet_stampede.py`
- Existing P3 suites updated for pg-cache reset isolation:
  - `backend/tests/test_b12_p3_jwt_verification_standardization.py`
  - `backend/tests/test_b11_p3_jwt_rotation_semantics.py`
- CI enforcement wiring:
  - Required job `JWT Tenant Context Invariants` now runs migrations + fleet stampede tests:
    - `.github/workflows/ci.yml`
  - Required negative harness adds non-vacuous mutation check:
    - `scripts/contracts/run_negative_controls.sh`

## 3) Exit Gate Mapping

### Exit Gate 1 - Postgres Singleflight Lock Proven
- Code proof:
  - `backend/app/core/secrets.py` (`pg_try_advisory_lock` / `pg_advisory_unlock` in `_resolve_verification_ring_via_postgres`)
- Test proof:
  - `backend/tests/test_b12_p3_pg_fleet_stampede.py::test_unknown_kid_refresh_is_fleet_singleflight_with_spawn_processes`
- Required CI job:
  - `JWT Tenant Context Invariants`

### Exit Gate 2 - Postgres Shared JWKS Cache Proven
- Code proof:
  - migration table: `public.jwt_verification_cache`
  - runtime shared row read/write in `backend/app/core/secrets.py`
- Test proof:
  - `backend/tests/test_b12_p3_pg_fleet_stampede.py::test_refresh_floor_blocks_repeated_unknown_kid_refresh`
  - `backend/tests/test_b12_p3_jwt_verification_standardization.py::test_verification_steady_state_does_not_read_secret_source`
- Required CI job:
  - `JWT Tenant Context Invariants`

### Exit Gate 3 - Fleet Stampede Proof (OS-process CI)
- Test proof (spawn/process):
  - `backend/tests/test_b12_p3_pg_fleet_stampede.py::test_unknown_kid_refresh_is_fleet_singleflight_with_spawn_processes`
  - uses `multiprocessing.get_context("spawn")`
  - asserts Postgres `refresh_event_count <= 1`
- Required CI job:
  - `JWT Tenant Context Invariants`

### Exit Gate 4 - Jitter/Floor/Backoff Proven
- Test proof:
  - `backend/tests/test_b12_p3_pg_fleet_stampede.py::test_refresh_floor_blocks_repeated_unknown_kid_refresh`
  - `backend/tests/test_b12_p3_pg_fleet_stampede.py::test_refresh_backoff_applies_after_failure`
  - `backend/tests/test_b12_p3_pg_fleet_stampede.py::test_refresh_jitter_changes_next_allowed_schedule`
- Required CI job:
  - `JWT Tenant Context Invariants`

### Exit Gate 5 - Non-vacuous Negative Control
- Mutation toggle:
  - `SKELDIR_B12_P3_DISABLE_PG_SINGLEFLIGHT=1`
- Negative-control proof command:
  - `pytest backend/tests/test_b12_p3_pg_fleet_stampede.py -q -k test_unknown_kid_refresh_is_fleet_singleflight_with_spawn_processes`
  - expected result under mutation: **fail** (refresh events > 1)
- Required CI job:
  - `Phase 1 Negative Controls`

### Exit Gate 6 - Enforcement Plane Compliance
- Required-check integration:
  - positive proofs in `JWT Tenant Context Invariants`
  - negative proof in `Phase 1 Negative Controls`
- Branch protection required contexts remain source-of-truth on `main`.

## 4) Local Validation Snapshot
- `pytest backend/tests/test_b12_p3_jwt_verification_standardization.py -q` -> passed
- `pytest backend/tests/test_b11_p3_jwt_rotation_semantics.py -q -k "unknown_kid_forces_debounced_refresh_and_recovers or unknown_kid_refresh_is_debounced_under_flood"` -> passed
- `python -m py_compile backend/app/core/secrets.py backend/tests/test_b12_p3_pg_fleet_stampede.py` -> passed

## 5) CI Run Links
- To be populated with PR run URLs after required checks complete:
  - Green run (`JWT Tenant Context Invariants`):
    - TODO
  - Green run (`Phase 1 Negative Controls`):
    - TODO
  - Negative-control red proof (mutation path fails as designed):
    - TODO
