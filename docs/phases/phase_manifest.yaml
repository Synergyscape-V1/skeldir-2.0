phases:
  - id: B0.1
    intent: "API contract definition and validation for attribution/auth/export/webhooks."
    prerequisites: []
    ci_gate:
      job_name: gate-b0_1
      command: ["python", "scripts/phase_gates/run_gate.py", "B0.1"]
      artifacts:
        - backend/validation/evidence/contracts/b0_1_summary.json
    exit_gates:
      - contract_validation
      - error_model
      - examples
      - models
      - contract_semantics

  - id: B0.2
    intent: "Mock server deployment and contract fidelity."
    prerequisites: ["B0.1"]
    ci_gate:
      job_name: gate-b0_2
      command: ["python", "scripts/phase_gates/run_gate.py", "B0.2"]
      artifacts:
        - backend/validation/evidence/mocks/b0_2_summary.json
    exit_gates:
      - config
      - toolchain
      - behavior
      - latency
      - error_simulation
      - frontend

  - id: B0.3
    intent: "Database schema foundation with migrations, guardrails, and performance checks."
    prerequisites: ["B0.1"]
    ci_gate:
      job_name: gate-b0_3
      command: ["python", "scripts/phase_gates/run_gate.py", "B0.3"]
      artifacts:
        - backend/validation/evidence/database/b0_3_summary.json
        - backend/validation/evidence/database/phase2_b03/phase2_b03_summary.json
    exit_gates:
      - EG2.1_canonical_schema_parity
      - EG2.2_migration_determinism
      - EG2.3_tenant_rls_structural
      - EG2.4_mandatory_ledger_tables
      - EG2.5_schema_write_shape_binding

  - id: SCHEMA_GUARD
    intent: "Schema contract guard enforcing required columns and forbidding raw inserts."
    prerequisites: ["B0.3"]
    ci_gate:
      job_name: gate-schema-guard
      command: ["python", "scripts/phase_gates/schema_guard_gate.py"]
      artifacts:
        - backend/validation/evidence/phases/schema_guard_summary.json
    exit_gates:
      - schema_contract_guard
      - no_raw_inserts

  - id: B0.4
    intent: "PostgreSQL-first ingestion service: idempotency, DLQ, and RLS isolation."
    prerequisites: ["B0.3", "SCHEMA_GUARD"]
    ci_gate:
      job_name: gate-b0_4
      command: ["python", "scripts/phase_gates/b0_4_gate.py"]
      artifacts:
        - backend/validation/evidence/phases/b0_4_summary.json
    exit_gates:
      - migrations
      - ingestion_soundness

  - id: B0.6
    intent: "Realtime revenue cache + stampede prevention (Postgres-only)."
    prerequisites: ["B0.4"]
    ci_gate:
      job_name: gate-b0_6
      command: ["python", "scripts/phase_gates/b0_6_gate.py"]
      artifacts:
        - backend/validation/evidence/phases/b0_6_summary.json
    exit_gates:
      - revenue_cache
      - stampede_prevention
      - failure_cooldown

  - id: VALUE_01
    intent: "Value Trace 01-WIN - Ghost revenue reconciliation (adversarial double-counting detection)."
    prerequisites: ["B0.4"]
    ci_gate:
      job_name: gate-value-01
      command: ["python", "scripts/phase_gates/value_01_gate.py"]
      artifacts:
        - backend/validation/evidence/value_traces/value_01_summary.json
        - docs/forensics/evidence/value_traces/value_01_revenue_trace.md
    exit_gates:
      - ghost_revenue_detection
      - idempotent_reconciliation
      - penny_perfect

  - id: VALUE_02
    intent: "Value Trace 02 - Constraint guard/bypass prevention."
    prerequisites: ["SCHEMA_GUARD"]
    ci_gate:
      job_name: gate-value-02
      command: ["python", "scripts/phase_gates/value_02_gate.py"]
      artifacts:
        - backend/validation/evidence/value_traces/value_02_summary.json
        - docs/forensics/evidence/value_traces/value_02_constraint_trace.md
    exit_gates:
      - constraint_trace

  - id: VALUE_03
    intent: "Value Trace 03-WIN - Budget-kill circuit breaker (premium call enforcement)."
    prerequisites: ["B0.1", "B0.4"]
    ci_gate:
      job_name: gate-value-03
      command: ["python", "scripts/phase_gates/value_03_gate.py"]
      artifacts:
        - backend/validation/evidence/value_traces/value_03_summary.json
        - docs/forensics/evidence/value_traces/value_03_provider_handshake.md
    exit_gates:
      - contract_fields_present
      - budget_enforcement
      - audit_trail

  - id: VALUE_04
    intent: "Value Trace 04 - Registry-to-reality matview inventory parity."
    prerequisites: ["B0.3"]
    ci_gate:
      job_name: gate-value-04
      command: ["python", "scripts/phase_gates/value_04_gate.py"]
      artifacts:
        - backend/validation/evidence/value_traces/value_04_summary.json
        - docs/forensics/evidence/value_traces/value_04_registry_trace.md
    exit_gates:
      - registry_parity

  - id: VALUE_05
    intent: "Value Trace 05-WIN - Centaur friction (review/approve + minimum pending enforcement)."
    prerequisites: ["B0.4"]
    ci_gate:
      job_name: gate-value-05
      command: ["python", "scripts/phase_gates/value_05_gate.py"]
      artifacts:
        - backend/validation/evidence/value_traces/value_05_summary.json
        - docs/forensics/evidence/value_traces/value_05_centaur_enforcement.md
    exit_gates:
      - min_hold_enforced
      - approval_gate_enforced
      - state_machine_integrity
