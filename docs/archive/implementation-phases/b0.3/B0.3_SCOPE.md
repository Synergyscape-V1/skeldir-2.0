# B0.3 Database Schema Foundation — Object Inventory

**Document Purpose**: Canonical, single-source-of-truth scope document for Phase B0.3  
**Last Updated**: 2025-11-13  
**Status**: Phase 0 & 1 Implementation

This document provides a complete inventory of all database objects owned by Phase B0.3, organized by domain and sub-phase. It serves as the authoritative reference for answering "Does B0.3 own X?" and understanding the scope and responsibilities of the B0.3 database foundation.

---

## Table of Contents

1. [Governance & Baseline](#governance--baseline)
2. [Tenancy & RLS Substrate](#tenancy--rls-substrate)
3. [Ingestion Facts](#ingestion-facts)
4. [Allocation & Ledger](#allocation--ledger)
5. [Read Path](#read-path)
6. [Sub-Phase Responsibility Mapping](#sub-phase-responsibility-mapping)
7. [Source-of-Truth Crosswalk](#source-of-truth-crosswalk)

---

## Governance & Baseline

**Sub-Phase**: B0.3 Governance Foundation  
**Purpose**: Establish single source of truth for schema/migrations, mapping, linting, checks, and review processes.

### Migration System

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Directory | `alembic/` | Alembic migration system root | Project root |
| Config | `alembic.ini` | Alembic configuration (parameterized, no hardcoded credentials) | Project root |
| Environment | `alembic/env.py` | Environment configuration (reads DATABASE_URL from env) | `alembic/env.py` |
| Template | `alembic/script.py.mako` | Migration template | `alembic/script.py.mako` |
| Baseline | `alembic/versions/202511121302_baseline.py` | Baseline migration (empty DDL) | `alembic/versions/202511121302_baseline.py` |

### Documentation & Governance Artifacts

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Style Guide | `db/docs/SCHEMA_STYLE_GUIDE.md` | Complete style guide with all conventions | `db/docs/SCHEMA_STYLE_GUIDE.md` |
| Mapping Rulebook | `db/docs/CONTRACT_TO_SCHEMA_MAPPING.md` | Human-readable contract→schema mapping rules | `db/docs/CONTRACT_TO_SCHEMA_MAPPING.md` |
| Mapping YAML | `db/docs/contract_schema_mapping.yaml` | Machine-readable contract→schema mapping | `db/docs/contract_schema_mapping.yaml` |
| Extension Allow-List | `db/docs/EXTENSION_ALLOWLIST.md` | Extension allow-list with names and rationale | `db/docs/EXTENSION_ALLOWLIST.md` |
| Migration Safety | `db/docs/MIGRATION_SAFETY_CHECKLIST.md` | Complete safety checklist (timeouts, backfill playbook) | `db/docs/MIGRATION_SAFETY_CHECKLIST.md` |
| Schema Snapshots | `db/docs/SCHEMA_SNAPSHOTS.md` | Snapshot format and process documentation | `db/docs/SCHEMA_SNAPSHOTS.md` |
| PR Checklist | `.github/PULL_REQUEST_TEMPLATE/schema-migration.md` | PR checklist template for schema changes | `.github/PULL_REQUEST_TEMPLATE/schema-migration.md` |

---

## Tenancy & RLS Substrate

**Sub-Phase**: B0.3 Tenancy Foundation  
**Purpose**: Establish shared-schema, strict row isolation via Row-Level Security (RLS).

### Core Tables

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Table | `tenants` | Tenant identity and management | `alembic/versions/202511131115_add_core_tables.py:54-96` |

### Roles & GRANTs

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Role | `app_rw` | Read-write application role (SELECT, INSERT, UPDATE, DELETE on tenant-scoped tables) | `db/docs/ROLES_AND_GRANTS.md:7-18` |
| Role | `app_ro` | Read-only application role (SELECT on tenant-scoped tables) | `db/docs/ROLES_AND_GRANTS.md:20-31` |
| Role | `app_admin` | Administrative operations role (SELECT, INSERT, UPDATE, DELETE on administrative tables) | `db/docs/ROLES_AND_GRANTS.md:33-44` |
| Role | `migration_owner` | Migration execution role (full database access for migration execution) | `db/docs/ROLES_AND_GRANTS.md:46-58` |
| Migration | `202511131121_add_grants.py` | Applies GRANTs per ROLES_AND_GRANTS.md matrix | `alembic/versions/202511131121_add_grants.py:53-88` |

### RLS Policies

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| RLS Macro | `tenant_isolation_policy` | RLS policy template using `current_setting('app.current_tenant_id')::uuid` | `alembic/versions/202511131120_add_rls_policies.py:67-71` |
| Policy | `tenant_isolation_policy on attribution_events` | Tenant isolation for attribution_events table | `alembic/versions/202511131120_add_rls_policies.py:67-71` (applied via loop) |
| Policy | `tenant_isolation_policy on dead_events` | Tenant isolation for dead_events table | `alembic/versions/202511131120_add_rls_policies.py:67-71` (applied via loop) |
| Policy | `tenant_isolation_policy on attribution_allocations` | Tenant isolation for attribution_allocations table | `alembic/versions/202511131120_add_rls_policies.py:67-71` (applied via loop) |
| Policy | `tenant_isolation_policy on revenue_ledger` | Tenant isolation for revenue_ledger table | `alembic/versions/202511131120_add_rls_policies.py:67-71` (applied via loop) |
| Policy | `tenant_isolation_policy on reconciliation_runs` | Tenant isolation for reconciliation_runs table | `alembic/versions/202511131120_add_rls_policies.py:67-71` (applied via loop) |
| Migration | `202511131120_add_rls_policies.py` | Enables RLS and creates tenant isolation policies | `alembic/versions/202511131120_add_rls_policies.py:48-77` |

---

## Ingestion Facts

**Sub-Phase**: B0.3 Ingestion Foundation  
**Purpose**: Append-only event ingestion with idempotency and dead-letter queue.

### Core Tables

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Table | `attribution_events` | Canonical append-only event log for attribution; idempotent ingest anchor | `alembic/versions/202511131115_add_core_tables.py:98-152` |
| Table | `dead_events` | Dead-letter queue for failed ingestion attempts | `alembic/versions/202511131115_add_core_tables.py:154-190` |

### Idempotency Constraints

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Index | `idx_attribution_events_tenant_external_event_id` | UNIQUE (tenant_id, external_event_id) WHERE external_event_id IS NOT NULL | `alembic/versions/202511131115_add_core_tables.py:121-125` |
| Index | `idx_attribution_events_tenant_correlation_id` | UNIQUE (tenant_id, correlation_id) WHERE correlation_id IS NOT NULL AND external_event_id IS NULL | `alembic/versions/202511131115_add_core_tables.py:127-131` |

---

## Allocation & Ledger

**Sub-Phase**: B0.3 Allocation & Ledger Foundation  
**Purpose**: Deterministic allocations, immutable ledger, reconciliation.

### Core Tables

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Table | `attribution_allocations` | Attribution model allocations (channel credit) with revenue accounting determinism | `alembic/versions/202511131115_add_core_tables.py:192-236` (base) + `alembic/versions/202511131232_enhance_allocation_schema.py:36-124` (enhancement) |
| Table | `revenue_ledger` | Verified revenue aggregates for reconciliation with allocation-based posting support | `alembic/versions/202511131115_add_core_tables.py:238-272` (base) + `alembic/versions/202511131250_enhance_revenue_ledger.py:35-77` (enhancement) |
| Table | `reconciliation_runs` | Reconciliation pipeline run status | `alembic/versions/202511131115_add_core_tables.py:274-308` |

### Sum-Equality Invariant

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Trigger Function | `check_allocation_sum()` | Validates that allocations sum to event revenue per (event_id, model_version) with ±1 cent tolerance | `alembic/versions/202511131240_add_sum_equality_validation.py:45-69` |
| Trigger | `trg_check_allocation_sum` | Enforces sum-equality invariant on attribution_allocations table | `alembic/versions/202511131240_add_sum_equality_validation.py:77-87` |
| Materialized View | `mv_allocation_summary` | Aggregates allocation sums per (tenant_id, event_id, model_version) for sum-equality validation | `alembic/versions/202511131240_add_sum_equality_validation.py:89-131` |
| Migration | `202511131240_add_sum_equality_validation.py` | Implements sum-equality invariant (trigger + MV) | `alembic/versions/202511131240_add_sum_equality_validation.py:34-152` |

---

## Read Path

**Sub-Phase**: B0.3 Read Path Foundation  
**Purpose**: Contract-shaped views/MVs for low-latency aggregates aligned to OpenAPI.

### Materialized Views

| Object | Name | Purpose | File Reference |
|--------|------|---------|----------------|
| Materialized View | `mv_realtime_revenue` | Aggregates revenue data for GET /api/attribution/revenue/realtime | `alembic/versions/202511131119_add_materialized_views.py:44-64` |
| Materialized View | `mv_reconciliation_status` | Aggregates reconciliation status for GET /api/reconciliation/status | `alembic/versions/202511131119_add_materialized_views.py:66-91` |
| Materialized View | `mv_allocation_summary` | Aggregates allocation sums per (tenant_id, event_id, model_version) for sum-equality validation | `alembic/versions/202511131240_add_sum_equality_validation.py:89-131` |
| Migration | `202511131119_add_materialized_views.py` | Creates contract-compliant materialized views | `alembic/versions/202511131119_add_materialized_views.py:34-103` |

---

## Migration Files Summary

**Total**: 8 migrations

| Revision | Migration File | Purpose | Down Revision |
|----------|---------------|---------|---------------|
| `baseline` | `202511121302_baseline.py` | Baseline (pre-existing) | None |
| `202511131115` | `202511131115_add_core_tables.py` | Core tables (6 tables) | `baseline` |
| `202511131119` | `202511131119_add_materialized_views.py` | Materialized views (2 MVs) | `202511131115` |
| `202511131120` | `202511131120_add_rls_policies.py` | RLS policies (5 policies) | `202511131119` |
| `202511131121` | `202511131121_add_grants.py` | GRANTs (app_rw, app_ro) | `202511131120` |
| `202511131232` | `202511131232_enhance_allocation_schema.py` | Phase 4A: Allocation schema enhancement | `202511131121` |
| `202511131240` | `202511131240_add_sum_equality_validation.py` | Phase 4B: Sum-equality invariant | `202511131232` |
| `202511131250` | `202511131250_enhance_revenue_ledger.py` | Phase 4C: Revenue ledger enhancement | `202511131240` |

---

## Sub-Phase Responsibility Mapping

This section assigns ownership and responsibility to each object, documenting which B0.3 sub-phase owns it and which future phases will use it.

### Governance & Baseline Objects

| Object | Responsibility | Sub-Phase Ownership | Cross-Phase Dependencies |
|--------|----------------|---------------------|-------------------------|
| Migration System | Single source of truth for schema changes; version-controlled DDL | B0.3 Governance Foundation | Used by all future phases (B0.4+) for schema evolution |
| Style Guide | Enforces naming conventions, type mappings, comment standards | B0.3 Governance Foundation | Used by all future phases for consistency |
| Contract Mapping | Maps OpenAPI contracts to database schema; ensures contract compliance | B0.3 Governance Foundation | Used by B0.4+ for contract validation |
| Extension Allow-List | Controls which PostgreSQL extensions are permitted | B0.3 Governance Foundation | Used by all future phases for extension requests |
| Migration Safety | Defines safety procedures for database migrations | B0.3 Governance Foundation | Used by all future phases for migration execution |
| Schema Snapshots | Enables drift detection and schema versioning | B0.3 Governance Foundation | Used by all future phases for schema validation |
| PR Checklist | Enforces review gates for schema changes | B0.3 Governance Foundation | Used by all future phases for PR review |

### Tenancy & RLS Substrate Objects

| Object | Responsibility | Sub-Phase Ownership | Cross-Phase Dependencies |
|--------|----------------|---------------------|-------------------------|
| `tenants` table | Tenant identity and management; root of tenant hierarchy | B0.3 Tenancy Foundation | Used by all future phases (B0.4+) for tenant context |
| `app_rw` role | Read-write application role with RLS-enforced tenant isolation | B0.3 Tenancy Foundation | Used by B0.4 ingestion service (writes), B0.5+ attribution service (reads/writes) |
| `app_ro` role | Read-only application role with RLS-enforced tenant isolation | B0.3 Tenancy Foundation | Used by B0.5+ reporting/analytics services (reads) |
| `app_admin` role | Administrative operations role for configuration management | B0.3 Tenancy Foundation | Used by B0.5+ admin services (configuration) |
| `migration_owner` role | Migration execution role with full database access | B0.3 Tenancy Foundation | Used by all future phases for migration execution |
| RLS Policies | Enforce tenant isolation on all tenant-scoped tables | B0.3 Tenancy Foundation | Used by all future phases for tenant data access |

### Ingestion Facts Objects

| Object | Responsibility | Sub-Phase Ownership | Cross-Phase Dependencies |
|--------|----------------|---------------------|-------------------------|
| `attribution_events` table | Canonical append-only event log for attribution; idempotent ingest anchor | B0.3 Ingestion Foundation | Used by B0.4 ingestion service (writes), B0.5+ attribution service (reads) |
| `dead_events` table | Dead-letter queue for failed ingestion attempts; diagnostic storage | B0.3 Ingestion Foundation | Used by B0.4 ingestion service (writes failed events), B0.5+ admin services (reads for diagnostics) |
| Idempotency constraints | Ensure idempotent event ingestion via UNIQUE constraints | B0.3 Ingestion Foundation | Used by B0.4 ingestion service for idempotency enforcement |

### Allocation & Ledger Objects

| Object | Responsibility | Sub-Phase Ownership | Cross-Phase Dependencies |
|--------|----------------|---------------------|-------------------------|
| `attribution_allocations` table | Attribution model allocations (channel credit) with revenue accounting determinism | B0.3 Allocation & Ledger Foundation | Used by B0.5+ attribution service (writes allocations), B0.6+ reporting services (reads) |
| `revenue_ledger` table | Verified revenue aggregates for reconciliation with allocation-based posting support | B0.3 Allocation & Ledger Foundation | Used by B0.5+ reconciliation service (writes ledger entries), B0.6+ reporting services (reads) |
| `reconciliation_runs` table | Reconciliation pipeline run status tracking | B0.3 Allocation & Ledger Foundation | Used by B0.5+ reconciliation service (writes run status), B0.6+ admin services (reads status) |
| `trg_check_allocation_sum` trigger | Enforces sum-equality invariant: allocations must sum to event revenue | B0.3 Allocation & Ledger Foundation | Used by B0.5+ attribution service (validates allocations on write) |
| `mv_allocation_summary` MV | Aggregates allocation sums for sum-equality validation and reporting | B0.3 Allocation & Ledger Foundation | Used by B0.5+ reconciliation service (validates allocations), B0.6+ reporting services (reads summaries) |

### Read Path Objects

| Object | Responsibility | Sub-Phase Ownership | Cross-Phase Dependencies |
|--------|----------------|---------------------|-------------------------|
| `mv_realtime_revenue` MV | Aggregates revenue data for GET /api/attribution/revenue/realtime endpoint | B0.3 Read Path Foundation | Used by B0.6+ frontend/API services (reads for dashboard) |
| `mv_reconciliation_status` MV | Aggregates reconciliation status for GET /api/reconciliation/status endpoint | B0.3 Read Path Foundation | Used by B0.6+ frontend/API services (reads for status dashboard) |

---

## Source-of-Truth Crosswalk

This section proves that B0.3's schema foundation is aligned to Source-of-Truth (SoT) documents: backend architecture guide and OpenAPI contracts.

### Governance & Baseline ↔ SoT

**Architecture SoT Sections**:
- **PostgreSQL-first**: All migrations use PostgreSQL-specific features (RLS, materialized views, triggers)
- **Shared-schema tenancy**: RLS policies enforce tenant isolation in shared schema
- **Migration discipline**: Alembic migration system with version control and safety checklists
- **Contract mapping**: Machine-readable YAML mapping ensures contract compliance

**Contract SoT**:
- **OpenAPI 3.1 contracts**: All contract schemas defined in `api-contracts/openapi/v1/`
- **Contract compliance**: Mapping rulebook (`db/docs/CONTRACT_TO_SCHEMA_MAPPING.md`) ensures schema aligns with contracts
- **Type mappings**: Contract types (string UUID, number float currency) mapped to PostgreSQL types (uuid, integer cents)

**Internal-Only Artifacts**:
- Migration system configuration (`alembic.ini`, `alembic/env.py`) - Internal-only, not exposed via contracts
- Style guide and lint rules - Internal-only, governance artifacts
- Extension allow-list - Internal-only, security governance

### Tenancy & RLS Substrate ↔ SoT

**Architecture SoT Sections**:
- **Shared-schema tenancy**: `tenants` table and RLS policies implement shared-schema multi-tenancy
- **Row-Level Security**: RLS policies use `current_setting('app.current_tenant_id')::uuid` for tenant context
- **Least-privilege roles**: Role model (`app_rw`, `app_ro`, `app_admin`, `migration_owner`) enforces least-privilege access

**Contract SoT**:
- **Tenant context**: All tenant-scoped endpoints require `tenant_id` (mapped from OpenAPI `tenant_id: string uuid`)
- **RLS enforcement**: Contract endpoints automatically filtered by RLS policies (no explicit tenant filtering in queries)

**Internal-Only Artifacts**:
- `tenants` table - Internal-only, not exposed via contracts (referenced via `tenant_id` FK)
- Role definitions - Internal-only, database security configuration
- RLS policy implementation - Internal-only, database security enforcement

### Ingestion Facts ↔ SoT

**Architecture SoT Sections**:
- **Append-only event stream**: `attribution_events` table implements append-only semantics (no UPDATE/DELETE for app roles)
- **Idempotent ingestion**: Idempotency constraints ensure idempotent event ingestion
- **Dead-letter queue**: `dead_events` table implements DLQ pattern for failed ingestion

**Contract SoT**:
- **Webhook ingestion**: `attribution_events` supports webhook ingestion endpoints (Shopify, Stripe, PayPal, WooCommerce)
  - Contract: `api-contracts/openapi/v1/attribution.yaml` (webhook endpoints)
  - Mapping: `db/docs/contract_schema_mapping.yaml:98-125`
- **Event fields**: Contract event fields mapped to table columns:
  - `tenant_id: string uuid` → `tenant_id uuid NOT NULL`
  - `total_revenue: number float` → `revenue_cents INTEGER NOT NULL` (converted to cents)
  - `X-Correlation-ID header` → `correlation_id uuid` (for distributed tracing)

**Internal-Only Artifacts**:
- `dead_events` table - Internal-only, diagnostic storage for failed ingestion (not exposed via contracts)
- Idempotency indexes - Internal-only, database constraints (not exposed via contracts)

### Allocation & Ledger ↔ SoT

**Architecture SoT Sections**:
- **Deterministic allocations**: `attribution_allocations` table with `allocation_ratio` and `model_version` enables deterministic revenue accounting
- **Sum-equality invariant**: Trigger `trg_check_allocation_sum` enforces allocations sum to event revenue
- **Immutability for ledger**: `revenue_ledger` table implements immutable ledger pattern (no UPDATE/DELETE for app roles)

**Contract SoT**:
- **Allocation fields**: Allocation fields mapped to table columns:
  - `allocation_ratio: number float` → `allocation_ratio numeric(6,5) NOT NULL`
  - `model_version: string` → `model_version text NOT NULL`
  - `channel_code: string enum` → `channel text NOT NULL` (CHECK constraint for enum)
- **Revenue ledger**: `revenue_ledger` supports RealtimeRevenueResponse:
  - Contract: `api-contracts/openapi/v1/attribution.yaml:39-64` (RealtimeRevenueResponse)
  - Mapping: `db/docs/contract_schema_mapping.yaml:187-214`
- **Reconciliation status**: `reconciliation_runs` supports ReconciliationStatusResponse:
  - Contract: `api-contracts/openapi/v1/reconciliation.yaml:39-64` (ReconciliationStatusResponse)
  - Mapping: `db/docs/contract_schema_mapping.yaml:216-231`

**Internal-Only Artifacts**:
- Sum-equality trigger - Internal-only, database constraint enforcement (not exposed via contracts)
- `mv_allocation_summary` MV - Internal-only, validation/reporting view (not exposed via contracts)

### Read Path ↔ SoT

**Architecture SoT Sections**:
- **Contract-shaped views/MVs**: Materialized views produce contract-compliant JSON shapes
- **Low-latency aggregates**: MVs pre-aggregate data for p95 < 50ms performance target
- **Refresh policy**: CONCURRENTLY refresh with TTL-based cadence (30-60 seconds)

**Contract SoT**:
- **mv_realtime_revenue**: GET /api/attribution/revenue/realtime
  - Contract: `api-contracts/openapi/v1/attribution.yaml:39-64` (RealtimeRevenueResponse)
  - MV columns: `tenant_id`, `total_revenue`, `verified`, `data_freshness_seconds`
  - Mapping: Contract fields match MV columns exactly
- **mv_reconciliation_status**: GET /api/reconciliation/status
  - Contract: `api-contracts/openapi/v1/reconciliation.yaml:39-64` (ReconciliationStatusResponse)
  - MV columns: `tenant_id`, `state`, `last_run_at`, `reconciliation_run_id`
  - Mapping: Contract fields match MV columns exactly

**Internal-Only Artifacts**:
- MV refresh metadata - Internal-only, operational metadata (not exposed via contracts)
- MV indexes - Internal-only, performance optimization (not exposed via contracts)

### Explicit Statement

> **B0.3 does not introduce any DB-visible fields or shapes that are not either:**
>
> **(a) directly mapped from OpenAPI**, or  
> **(b) internal-only and explicitly documented as such** (e.g., audit or operational tables).
>
> All internal-only artifacts are marked in the crosswalk above with rationale (e.g., "Internal-only, diagnostic storage", "Internal-only, database constraint enforcement").

---

## Cross-References

- **Main Implementation Document**: `B0.3_IMPLEMENTATION_COMPLETE.md`
- **Forensic Analysis**: `B0.3_FORENSIC_ANALYSIS_RESPONSE.md`
- **Governance Baseline**: `db/GOVERNANCE_BASELINE_CHECKLIST.md`
- **Contract Mapping**: `db/docs/contract_schema_mapping.yaml`
- **Roles & GRANTs**: `db/docs/ROLES_AND_GRANTS.md`

---

**Document Status**: ✅ **COMPLETE** (Phase 0.1, 0.2, 0.3)



