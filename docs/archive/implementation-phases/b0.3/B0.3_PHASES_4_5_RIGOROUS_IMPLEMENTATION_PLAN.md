# Phases 4 & 5 Rigorous Implementation Plan
## Forensic Validation & Absolute Phase Advancement Control

**Document Version**: 2.0  
**Date**: 2025-11-13  
**Status**: REFINED - Ready for Execution

---

## Executive Summary

This plan synthesizes Jamie's revenue accounting rigor and Schmidt's integrity enforcement into a unified implementation roadmap with **absolute phase advancement prohibition** until all exit gates are empirically verified. Every phase includes forensic validation requirements, explicit agent restraint mechanisms, and industry best practices compliance.

**Critical Enforcement**: **NO PHASE CAN BE STARTED UNTIL ALL EXIT GATES OF THE PREVIOUS PHASE ARE VERIFIED AND DOCUMENTED WITH EMPIRICAL PROOF.**

---

## Part I: Forensic Gap Analysis

### A. Current Implementation Assessment

**✅ Implemented (Schmidt-aligned)**:
- Core tables with PK/UQ/NOT NULL constraints
- Foreign keys with ON DELETE CASCADE
- RLS policies on all tenant-scoped tables
- Materialized views (mv_realtime_revenue, mv_reconciliation_status)
- Idempotency constraints (partial unique indexes)
- Index plan with query path justification
- Contract mapping documentation

**❌ Missing (Jamie-aligned)**:
- `allocation_ratio numeric(6,5)` with CHECK (0-1) in `attribution_allocations`
- `model_version text NOT NULL` in `attribution_allocations`
- Sum-equality invariant: `sum(allocated_revenue_cents) = events.revenue_cents` per `(tenant_id, event_id, model_version)`
- `allocation_id uuid FK` in `revenue_ledger` (currently has `reconciliation_run_id` only)
- `posted_at timestamptz` in `revenue_ledger` (currently has `verified_at` only)
- Unique constraint on `(tenant_id, allocation_id)` for ledger idempotency
- Immutability policy documentation for `revenue_ledger`
- Channel code enum/CHECK constraint (currently `text` without validation)

**⚠️ Partially Complete**:
- Reconciliation status exists as `reconciliation_runs` table + MV (matches both directives)
- Empirical tests created but not executed (Schmidt requirement)

---

## Part II: Implementation Phases with Rigorous Exit Gates

### Phase 4A: Enhance Allocation Schema (Jamie's Requirements)

**Intent**: Add revenue accounting determinism to `attribution_allocations` with forensic validation.

**BLOCKING CONDITION**: **NO ADVANCEMENT TO PHASE 4B UNTIL ALL 10 EXIT GATES BELOW ARE EMPIRICALLY VERIFIED AND DOCUMENTED.**

**Changes Required**:

1. **Add `allocation_ratio` column**:
   ```sql
   ALTER TABLE attribution_allocations
       ADD COLUMN allocation_ratio numeric(6,5) NOT NULL
       CHECK (allocation_ratio >= 0 AND allocation_ratio <= 1);
   ```

2. **Add `model_version` column**:
   ```sql
   ALTER TABLE attribution_allocations
       ADD COLUMN model_version text NOT NULL;
   ```

3. **Add `channel_code` enum/CHECK**:
   ```sql
   -- Option A: CHECK constraint (if enum is small/stable)
   ALTER TABLE attribution_allocations
       ADD CONSTRAINT ck_attribution_allocations_channel_code_valid
       CHECK (channel IN ('google_search', 'facebook_ads', 'direct', 'email', 'organic'));
   
   -- Option B: Lookup table (if enum is large/evolving)
   -- Defer to contract review for channel_code enum definition
   ```

4. **Update idempotency unique constraint**:
   ```sql
   -- Add model_version to idempotency key
   CREATE UNIQUE INDEX idx_attribution_allocations_tenant_event_model_channel
       ON attribution_allocations (tenant_id, event_id, model_version, channel)
       WHERE model_version IS NOT NULL;
   ```

**Exit Gates (ALL MUST PASS - ABSOLUTE BLOCKING)**:

**Gate 4A.1: Migration File Existence & Structure**
- **Requirement**: Migration file exists with correct naming pattern
- **Verification Method**: 
  ```bash
  ls -la alembic/versions/*enhance_allocation_schema.py
  grep -q "def upgrade()" alembic/versions/*enhance_allocation_schema.py
  grep -q "def downgrade()" alembic/versions/*enhance_allocation_schema.py
  ```
- **Expected Result**: File exists, contains both upgrade() and downgrade() functions
- **Empirical Proof**: File path and grep output must be documented in `db/docs/PHASE_4A_EXIT_GATE_VERIFICATION.md`
- **Blocking**: If file missing or incomplete, Phase 4B is PROHIBITED

**Gate 4A.2: Allocation Ratio Column Added**
- **Requirement**: `allocation_ratio numeric(6,5) NOT NULL` with CHECK constraint exists
- **Verification Method**:
  ```sql
  SELECT column_name, data_type, numeric_precision, numeric_scale, is_nullable
  FROM information_schema.columns
  WHERE table_name = 'attribution_allocations' AND column_name = 'allocation_ratio';
  
  SELECT constraint_name, check_clause
  FROM information_schema.check_constraints
  WHERE constraint_name LIKE '%allocation_ratio%';
  ```
- **Expected Result**: 
  - Column exists with type `numeric`, precision `6`, scale `5`, `is_nullable = 'NO'`
  - CHECK constraint exists with clause containing `>= 0 AND <= 1`
- **Empirical Proof**: SQL query results must be captured and documented
- **Blocking**: If column missing, wrong type, or constraint missing, Phase 4B is PROHIBITED

**Gate 4A.3: Model Version Column Added**
- **Requirement**: `model_version text NOT NULL` exists
- **Verification Method**:
  ```sql
  SELECT column_name, data_type, is_nullable
  FROM information_schema.columns
  WHERE table_name = 'attribution_allocations' AND column_name = 'model_version';
  ```
- **Expected Result**: Column exists with `data_type = 'text'`, `is_nullable = 'NO'`
- **Empirical Proof**: SQL query results must be captured and documented
- **Blocking**: If column missing or nullable, Phase 4B is PROHIBITED

**Gate 4A.4: Channel Code Validation Added**
- **Requirement**: Channel code validation exists (CHECK constraint or FK to lookup table)
- **Verification Method**:
  ```sql
  SELECT constraint_name, check_clause
  FROM information_schema.check_constraints
  WHERE constraint_name LIKE '%channel%';
  ```
- **Expected Result**: Either CHECK constraint exists OR FK to channel lookup table exists
- **Empirical Proof**: SQL query results must be captured and documented
- **Blocking**: If no validation exists, Phase 4B is PROHIBITED

**Gate 4A.5: Idempotency Constraint Updated**
- **Requirement**: Unique index includes `(tenant_id, event_id, model_version, channel)`
- **Verification Method**:
  ```sql
  SELECT indexname, indexdef
  FROM pg_indexes
  WHERE tablename = 'attribution_allocations'
    AND indexname LIKE '%tenant_event_model_channel%';
  ```
- **Expected Result**: Index exists with columns `tenant_id, event_id, model_version, channel` in definition
- **Empirical Proof**: SQL query results must be captured and documented
- **Blocking**: If index missing or incorrect columns, Phase 4B is PROHIBITED

**Gate 4A.6: Migration Reversibility Tested**
- **Requirement**: Migration can be rolled back without errors
- **Verification Method**:
  ```bash
  # On fresh test database
  alembic upgrade head
  alembic downgrade -1
  alembic upgrade head
  ```
- **Expected Result**: All three commands succeed without errors
- **Empirical Proof**: Command output must be captured showing zero errors
- **Blocking**: If rollback fails or causes errors, Phase 4B is PROHIBITED

**Gate 4A.7: DDL Spec Files Updated**
- **Requirement**: `db/docs/specs/attribution_allocations_ddl_spec.sql` reflects new columns
- **Verification Method**:
  ```bash
  grep -q "allocation_ratio" db/docs/specs/attribution_allocations_ddl_spec.sql
  grep -q "model_version" db/docs/specs/attribution_allocations_ddl_spec.sql
  ```
- **Expected Result**: Both grep commands return matches
- **Empirical Proof**: Grep output must be captured
- **Blocking**: If spec file not updated, Phase 4B is PROHIBITED

**Gate 4A.8: Contract Mapping Updated**
- **Requirement**: `db/docs/contract_schema_mapping.yaml` includes new columns
- **Verification Method**:
  ```bash
  grep -A 5 "attribution_allocations" db/docs/contract_schema_mapping.yaml | grep -q "allocation_ratio"
  grep -A 5 "attribution_allocations" db/docs/contract_schema_mapping.yaml | grep -q "model_version"
  ```
- **Expected Result**: Both grep commands return matches
- **Empirical Proof**: Grep output must be captured
- **Blocking**: If mapping not updated, Phase 4B is PROHIBITED

**Gate 4A.9: Migration Safety Checklist Compliance**
- **Requirement**: Migration follows `MIGRATION_SAFETY_CHECKLIST.md` procedures
- **Verification Method**:
  - Review migration file for lock_timeout/statement_timeout (if applicable)
  - Verify no hardcoded credentials
  - Verify downgrade() function exists and is complete
- **Expected Result**: Migration complies with safety checklist
- **Empirical Proof**: Checklist review document must be created
- **Blocking**: If safety checklist not followed, Phase 4B is PROHIBITED

**Gate 4A.10: Lint Validation Passes**
- **Requirement**: DDL lint rules pass (per `DDL_LINT_RULES.md`)
- **Verification Method**:
  ```bash
  grep -r "COMMENT ON" alembic/versions/*enhance_allocation_schema.py | wc -l
  # Should have comments for all new objects
  ```
- **Expected Result**: Lint tool reports zero blocking errors
- **Empirical Proof**: Lint output must be captured
- **Blocking**: If lint errors exist, Phase 4B is PROHIBITED

**AGENT RESTRAINT MECHANISM**: 
- **Explicit Prohibition**: Agent(s) MUST NOT proceed to Phase 4B until ALL 10 gates above are verified
- **Verification Document**: Create `db/docs/PHASE_4A_EXIT_GATE_VERIFICATION.md` with:
  - Date/time of each gate verification
  - Empirical proof (file paths, SQL results, command output)
  - Verifier signature/approval
- **Automated Check**: CI/CD must verify all gates before allowing Phase 4B merge

---

### Phase 4B: Implement Sum-Equality Invariant (Jamie's Core Requirement)

**Intent**: Ensure allocations sum to event revenue per `(tenant_id, event_id, model_version)` with forensic validation.

**BLOCKING CONDITION**: **NO ADVANCEMENT TO PHASE 4C UNTIL ALL 8 EXIT GATES BELOW ARE EMPIRICALLY VERIFIED AND DOCUMENTED.**

**Implementation Strategy**: **Defense-in-Depth** - Implement both MV (reporting) and trigger (enforcement).

**Implementation**:

**1. Materialized View for Validation** (Reporting/Validation):
```sql
CREATE MATERIALIZED VIEW mv_allocation_summary AS
SELECT 
    aa.tenant_id,
    aa.event_id,
    aa.model_version,
    SUM(aa.allocated_revenue_cents) AS total_allocated_cents,
    e.revenue_cents AS event_revenue_cents,
    (SUM(aa.allocated_revenue_cents) = e.revenue_cents) AS is_balanced,
    ABS(SUM(aa.allocated_revenue_cents) - e.revenue_cents) AS drift_cents
FROM attribution_allocations aa
INNER JOIN attribution_events e ON aa.event_id = e.id
GROUP BY aa.tenant_id, aa.event_id, aa.model_version, e.revenue_cents;

CREATE UNIQUE INDEX idx_mv_allocation_summary_key
    ON mv_allocation_summary (tenant_id, event_id, model_version);
```

**2. Trigger-Based Validation** (Real-Time Enforcement):
```sql
CREATE OR REPLACE FUNCTION check_allocation_sum()
RETURNS TRIGGER AS $$
DECLARE
    event_revenue INTEGER;
    allocated_sum INTEGER;
    tolerance_cents INTEGER := 1; -- ±1 cent rounding tolerance
BEGIN
    SELECT revenue_cents INTO event_revenue
    FROM attribution_events
    WHERE id = COALESCE(NEW.event_id, OLD.event_id);
    
    SELECT COALESCE(SUM(allocated_revenue_cents), 0) INTO allocated_sum
    FROM attribution_allocations
    WHERE event_id = COALESCE(NEW.event_id, OLD.event_id)
      AND model_version = COALESCE(NEW.model_version, OLD.model_version);
    
    IF ABS(allocated_sum - event_revenue) > tolerance_cents THEN
        RAISE EXCEPTION 'Allocation sum mismatch: allocated=% expected=% drift=%', 
            allocated_sum, event_revenue, ABS(allocated_sum - event_revenue);
    END IF;
    
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_allocation_sum
    AFTER INSERT OR UPDATE OR DELETE ON attribution_allocations
    FOR EACH ROW EXECUTE FUNCTION check_allocation_sum();
```

**Exit Gates (ALL MUST PASS - ABSOLUTE BLOCKING)**:

**Gate 4B.1: Materialized View Exists**
- **Requirement**: `mv_allocation_summary` MV exists with correct structure
- **Verification Method**:
  ```sql
  SELECT schemaname, matviewname, definition
  FROM pg_matviews
  WHERE matviewname = 'mv_allocation_summary';
  
  SELECT indexname, indexdef
  FROM pg_indexes
  WHERE tablename = 'mv_allocation_summary';
  ```
- **Expected Result**: 
  - MV exists with SELECT containing SUM, GROUP BY, JOIN
  - Unique index exists on `(tenant_id, event_id, model_version)`
- **Empirical Proof**: SQL query results must be captured
- **Blocking**: If MV missing or incorrect structure, Phase 4C is PROHIBITED

**Gate 4B.2: Trigger Function Exists**
- **Requirement**: `check_allocation_sum()` function exists
- **Verification Method**:
  ```sql
  SELECT proname, prosrc
  FROM pg_proc
  WHERE proname = 'check_allocation_sum';
  ```
- **Expected Result**: Function exists with logic checking sum equality
- **Empirical Proof**: SQL query results must be captured
- **Blocking**: If function missing, Phase 4C is PROHIBITED

**Gate 4B.3: Trigger Exists and is Active**
- **Requirement**: `trg_check_allocation_sum` trigger exists and is enabled
- **Verification Method**:
  ```sql
  SELECT tgname, tgtype, tgenabled, tgrelid::regclass
  FROM pg_trigger
  WHERE tgname = 'trg_check_allocation_sum';
  ```
- **Expected Result**: Trigger exists, `tgenabled = 'O'` (enabled)
- **Empirical Proof**: SQL query results must be captured
- **Blocking**: If trigger missing or disabled, Phase 4C is PROHIBITED

**Gate 4B.4: Sum-Equality Test Script Executes Successfully**
- **Requirement**: Test script validates sum-equality with sample data
- **Verification Method**: Execute `db/tests/test_sum_equality.sql` on test database
- **Expected Result**: 
  - Test script executes without errors
  - MV correctly identifies balanced allocations
  - Trigger correctly rejects mismatched allocations
- **Empirical Proof**: Test execution output must be captured in `db/tests/test_sum_equality_results.md`
- **Blocking**: If tests fail, Phase 4C is PROHIBITED

**Gate 4B.5: Rounding Policy Documented**
- **Requirement**: `db/docs/ROUNDING_POLICY.md` exists and documents ±1 cent tolerance
- **Verification Method**:
  ```bash
  test -f db/docs/ROUNDING_POLICY.md
  grep -q "tolerance\|rounding\|±1 cent" db/docs/ROUNDING_POLICY.md
  ```
- **Expected Result**: File exists and contains rounding policy documentation
- **Empirical Proof**: File existence and grep output must be captured
- **Blocking**: If documentation missing, Phase 4C is PROHIBITED

**Gate 4B.6: Invariant Documentation Created**
- **Requirement**: `db/docs/SUM_EQUALITY_INVARIANT.md` exists with invariant specification
- **Verification Method**:
  ```bash
  test -f db/docs/SUM_EQUALITY_INVARIANT.md
  grep -q "sum.*allocated.*revenue\|invariant" db/docs/SUM_EQUALITY_INVARIANT.md -i
  ```
- **Expected Result**: File exists and documents the invariant
- **Empirical Proof**: File existence and grep output must be captured
- **Blocking**: If documentation missing, Phase 4C is PROHIBITED

**Gate 4B.7: Contract Mapping Documents Invariant**
- **Requirement**: Contract mapping includes sum-equality invariant reference
- **Verification Method**:
  ```bash
  grep -q "sum.*equality\|invariant" db/docs/contract_schema_mapping.yaml -i
  ```
- **Expected Result**: Mapping file references the invariant
- **Empirical Proof**: Grep output must be captured
- **Blocking**: If mapping not updated, Phase 4C is PROHIBITED

**Gate 4B.8: Migration Reversibility Tested**
- **Requirement**: Migration can be rolled back without errors
- **Verification Method**:
  ```bash
  alembic upgrade head
  alembic downgrade -1
  alembic upgrade head
  ```
- **Expected Result**: All commands succeed
- **Empirical Proof**: Command output must be captured
- **Blocking**: If rollback fails, Phase 4C is PROHIBITED

**AGENT RESTRAINT MECHANISM**: 
- **Explicit Prohibition**: Agent(s) MUST NOT proceed to Phase 4C until ALL 8 gates above are verified
- **Verification Document**: Create `db/docs/PHASE_4B_EXIT_GATE_VERIFICATION.md` with empirical proof
- **Automated Check**: CI/CD must verify all gates before allowing Phase 4C merge

---

### Phase 4C: Enhance Revenue Ledger (Jamie's Requirements)

**Intent**: Add `allocation_id` FK and `posted_at` to support allocation-based posting while preserving reconciliation_run_id.

**BLOCKING CONDITION**: **NO ADVANCEMENT TO PHASE 4D UNTIL ALL 9 EXIT GATES BELOW ARE EMPIRICALLY VERIFIED AND DOCUMENTED.**

**Changes Required**:

1. **Add `allocation_id` FK** (nullable, supports both allocation-based and run-based posting):
   ```sql
   ALTER TABLE revenue_ledger
       ADD COLUMN allocation_id uuid REFERENCES attribution_allocations(id) ON DELETE CASCADE;
   ```

2. **Add `posted_at` timestamp**:
   ```sql
   ALTER TABLE revenue_ledger
       ADD COLUMN posted_at timestamptz NOT NULL DEFAULT now();
   ```

3. **Add idempotency unique constraint** (Jamie's requirement):
   ```sql
   CREATE UNIQUE INDEX idx_revenue_ledger_tenant_allocation_id
       ON revenue_ledger (tenant_id, allocation_id)
       WHERE allocation_id IS NOT NULL;
   ```

4. **Document immutability policy**:
   - Create `db/docs/IMMUTABILITY_POLICY.md`
   - State: `revenue_ledger` rows are immutable (no UPDATE allowed)
   - Corrections via new ledger entries or admin path
   - GRANT policy: `app_rw` has INSERT, SELECT only (no UPDATE)

**Exit Gates (ALL MUST PASS - ABSOLUTE BLOCKING)**:

**Gate 4C.1: Migration File Exists**
- **Requirement**: Migration file exists with upgrade() and downgrade()
- **Verification Method**: File existence and function presence check
- **Empirical Proof**: Documented in verification file
- **Blocking**: If missing, Phase 4D is PROHIBITED

**Gate 4C.2: Allocation ID Column Added**
- **Requirement**: `allocation_id uuid` FK exists, nullable
- **Verification Method**: SQL query to information_schema
- **Expected Result**: Column exists, FK constraint exists, nullable = YES
- **Empirical Proof**: SQL results captured
- **Blocking**: If missing or wrong type, Phase 4D is PROHIBITED

**Gate 4C.3: Posted At Column Added**
- **Requirement**: `posted_at timestamptz NOT NULL` exists
- **Verification Method**: SQL query to information_schema
- **Expected Result**: Column exists, type = timestamptz, nullable = NO
- **Empirical Proof**: SQL results captured
- **Blocking**: If missing or nullable, Phase 4D is PROHIBITED

**Gate 4C.4: Unique Constraint on (tenant_id, allocation_id)**
- **Requirement**: Unique index exists where allocation_id IS NOT NULL
- **Verification Method**: Query pg_indexes
- **Expected Result**: Index exists with correct columns and WHERE clause
- **Empirical Proof**: SQL results captured
- **Blocking**: If missing, Phase 4D is PROHIBITED

**Gate 4C.5: Immutability Policy Documented**
- **Requirement**: `db/docs/IMMUTABILITY_POLICY.md` exists
- **Verification Method**: File existence check
- **Expected Result**: File exists with policy documentation
- **Empirical Proof**: File path documented
- **Blocking**: If missing, Phase 4D is PROHIBITED

**Gate 4C.6: GRANT Policy Updated (if needed)**
- **Requirement**: GRANTs enforce immutability (no UPDATE on revenue_ledger)
- **Verification Method**: Review GRANT migration or current GRANTs
- **Expected Result**: app_rw has INSERT, SELECT only (no UPDATE)
- **Empirical Proof**: GRANT review documented
- **Blocking**: If UPDATE granted, Phase 4D is PROHIBITED

**Gate 4C.7: Contract Mapping Updated**
- **Requirement**: Contract mapping includes new columns
- **Verification Method**: Grep contract_schema_mapping.yaml
- **Expected Result**: allocation_id and posted_at mapped
- **Empirical Proof**: Grep output captured
- **Blocking**: If not updated, Phase 4D is PROHIBITED

**Gate 4C.8: Migration Reversibility Tested**
- **Requirement**: Migration rolls back cleanly
- **Verification Method**: alembic upgrade/downgrade cycle
- **Expected Result**: All commands succeed
- **Empirical Proof**: Command output captured
- **Blocking**: If rollback fails, Phase 4D is PROHIBITED

**Gate 4C.9: DDL Spec Files Updated**
- **Requirement**: revenue_ledger_ddl_spec.sql reflects changes
- **Verification Method**: Grep for new columns
- **Expected Result**: allocation_id and posted_at present
- **Empirical Proof**: Grep output captured
- **Blocking**: If not updated, Phase 4D is PROHIBITED

**AGENT RESTRAINT MECHANISM**: Same as previous phases - verification document required before advancement.

---

### Phase 4D: Empirical Constraint Validation (Schmidt's Requirement)

**Intent**: Execute empirical tests to verify all constraints, FKs, and idempotency work correctly.

**BLOCKING CONDITION**: **NO ADVANCEMENT TO PHASE 5A UNTIL ALL 5 EXIT GATES BELOW ARE EMPIRICALLY VERIFIED AND DOCUMENTED.**

**Test Scripts to Execute**:

1. **Idempotency Tests** (`db/tests/test_idempotency.sql`):
   - Test duplicate `(tenant_id, external_event_id)` rejection
   - Test duplicate `(tenant_id, correlation_id)` rejection (when external_event_id NULL)
   - Test duplicate `(tenant_id, event_id, model_version, channel)` rejection in allocations

2. **Foreign Key Tests** (`db/tests/test_foreign_keys.sql`):
   - Test ON DELETE CASCADE for tenant deletion
   - Test ON DELETE CASCADE for event deletion → allocation deletion
   - Test orphaned FK prevention (cannot insert allocation with invalid event_id)

3. **CHECK Constraint Tests** (`db/tests/test_check_constraints.sql`):
   - Test negative revenue rejection (revenue_cents < 0)
   - Test allocation_ratio bounds (0-1)
   - Test channel_code enum validation

4. **Sum-Equality Tests** (`db/tests/test_sum_equality.sql`):
   - Test allocations sum to event revenue
   - Test rounding tolerance (±1 cent if applicable)

**Exit Gates (ALL MUST PASS - ABSOLUTE BLOCKING)**:

**Gate 4D.1: All Test Scripts Execute Successfully**
- **Requirement**: All 4 test scripts run without errors
- **Verification Method**: Execute each test script on test database
- **Expected Result**: Zero test failures
- **Empirical Proof**: Test execution output captured in results files
- **Blocking**: If any test fails, Phase 5A is PROHIBITED

**Gate 4D.2: Test Results Documented**
- **Requirement**: Results files exist for all tests
- **Verification Method**: File existence check
- **Expected Result**: All `*_results.md` files exist
- **Empirical Proof**: File paths documented
- **Blocking**: If results missing, Phase 5A is PROHIBITED

**Gate 4D.3: Zero Constraint Violations**
- **Requirement**: All constraint tests pass (constraints work as expected)
- **Verification Method**: Review test results
- **Expected Result**: All constraints enforce correctly
- **Empirical Proof**: Test results show expected behavior
- **Blocking**: If constraints don't work, Phase 5A is PROHIBITED

**Gate 4D.4: CI Integration (Recommended)**
- **Requirement**: Constraint tests integrated into CI pipeline
- **Verification Method**: CI configuration review
- **Expected Result**: Tests run automatically on PR
- **Empirical Proof**: CI config documented
- **Blocking**: Not blocking, but recommended

**Gate 4D.5: Test Coverage Verified**
- **Requirement**: All constraint types tested (PK, FK, CHECK, UNIQUE)
- **Verification Method**: Review test scripts
- **Expected Result**: Coverage matrix shows all constraints tested
- **Empirical Proof**: Coverage matrix documented
- **Blocking**: If coverage incomplete, Phase 5A is PROHIBITED

**AGENT RESTRAINT MECHANISM**: Same as previous phases - verification document required before advancement.

---

### Phase 5A: Contract-Shaped Views Enhancement (Jamie's Requirement)

**Intent**: Ensure all read DTOs are exactly matched by views/MVs with correct column ordering and types.

**BLOCKING CONDITION**: **NO ADVANCEMENT TO PHASE 5B UNTIL ALL 4 EXIT GATES BELOW ARE EMPIRICALLY VERIFIED AND DOCUMENTED.**

**Validation Required**:

1. **Review existing MVs**:
   - `mv_realtime_revenue`: Verify column order/types match `RealtimeRevenueResponse`
   - `mv_reconciliation_status`: Verify column order/types match `ReconciliationStatusResponse`

2. **Create additional views if needed**:
   - `v_channel_allocations_daily` (if contract requires)
   - `v_revenue_posted_daily` (if contract requires)

3. **Contract compliance verification**:
   - Run `db/tests/test_contract_compliance.sql`
   - Verify JSON shape matches contract schemas exactly

**Exit Gates (ALL MUST PASS - ABSOLUTE BLOCKING)**:

**Gate 5A.1: All Contract Read DTOs Have Matching Views/MVs**
- **Requirement**: Every contract read DTO has corresponding view/MV
- **Verification Method**: Compare contract schemas to view definitions
- **Expected Result**: 1:1 mapping exists
- **Empirical Proof**: Mapping matrix documented
- **Blocking**: If any DTO unmapped, Phase 5B is PROHIBITED

**Gate 5A.2: Column Order/Types Match Contracts Exactly**
- **Requirement**: View columns match contract fields in order and type
- **Verification Method**: Automated comparison script
- **Expected Result**: Zero mismatches
- **Empirical Proof**: Comparison results documented
- **Blocking**: If mismatches exist, Phase 5B is PROHIBITED

**Gate 5A.3: Contract Compliance Tests Pass**
- **Requirement**: test_contract_compliance.sql executes successfully
- **Verification Method**: Execute test script
- **Expected Result**: All tests pass
- **Empirical Proof**: Test results documented
- **Blocking**: If tests fail, Phase 5B is PROHIBITED

**Gate 5A.4: Mapping Matrix Updated**
- **Requirement**: contract_schema_mapping.yaml includes all views/MVs
- **Verification Method**: Grep for view names
- **Expected Result**: All views/MVs mapped
- **Empirical Proof**: Grep output captured
- **Blocking**: If not updated, Phase 5B is PROHIBITED

**AGENT RESTRAINT MECHANISM**: Same as previous phases - verification document required before advancement.

---

### Phase 5B: Index Plan Validation (Schmidt's Requirement)

**Intent**: Verify all indexes are justified by query paths; remove speculative indexes.

**BLOCKING CONDITION**: **NO ADVANCEMENT TO FINAL SIGN-OFF UNTIL ALL 3 EXIT GATES BELOW ARE EMPIRICALLY VERIFIED AND DOCUMENTED.**

**Validation Steps**:

1. **Review `db/docs/INDEX_PLAN.md`**:
   - Each index must map to a contract endpoint or internal query
   - Document query patterns that use each index

2. **Remove unjustified indexes** (if any):
   - Only keep indexes with documented query paths

3. **Add missing indexes** (if needed):
   - `(tenant_id, model_version)` for allocation model rollups (Jamie's requirement)

**Exit Gates (ALL MUST PASS - ABSOLUTE BLOCKING)**:

**Gate 5B.1: All Indexes Documented with Query Path Justification**
- **Requirement**: Every index has documented query path
- **Verification Method**: Review INDEX_PLAN.md
- **Expected Result**: All indexes justified
- **Empirical Proof**: Index plan review documented
- **Blocking**: If unjustified indexes exist, Final Sign-Off is PROHIBITED

**Gate 5B.2: No Speculative Indexes Present**
- **Requirement**: All indexes have documented use cases
- **Verification Method**: Compare pg_indexes to INDEX_PLAN.md
- **Expected Result**: No undocumented indexes
- **Empirical Proof**: Comparison results documented
- **Blocking**: If speculative indexes exist, Final Sign-Off is PROHIBITED

**Gate 5B.3: Index Plan Updated with New Indexes**
- **Requirement**: New indexes (if added) documented in plan
- **Verification Method**: Review INDEX_PLAN.md for new entries
- **Expected Result**: All new indexes documented
- **Empirical Proof**: Plan review documented
- **Blocking**: If plan not updated, Final Sign-Off is PROHIBITED

**AGENT RESTRAINT MECHANISM**: Same as previous phases - verification document required before advancement.

---

## Part III: System-Level Exit Criteria

**Final Sign-Off Requirements** (ALL MUST BE MET):

1. **Determinism**: Allocations sum to event revenue per `(tenant, event, model_version)` with documented rounding rules ✅
2. **Idempotency**: Unique keys prevent duplicate allocations and duplicate ledger postings ✅
3. **Immutability**: Ledger entries are not updated in place; corrections are additive or admin-gated ✅
4. **Isolation**: Every object includes `tenant_id`; base tables and read models preserve RLS semantics ✅
5. **Contract Parity**: All read DTOs are exactly matched by views/MVs; compliance matrix updated ✅
6. **Performance**: Indexes map to endpoints; MVs cover heavy endpoints with documented refresh SLA ✅
7. **Empirical Validation**: All constraint tests pass; test results documented ✅

**Verification Documents Required**:
- `db/docs/PHASE_4A_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_4B_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_4C_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_4D_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_5A_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_5B_EXIT_GATE_VERIFICATION.md`

**Peer Review Sign-Off Required**:
- Backend Lead approval
- Database Architect approval (if applicable)
- All verification documents reviewed and signed

---

## Part IV: Agent Restraint & Enforcement Mechanisms

### Explicit Prohibition Rules

1. **Phase Advancement Prohibition**: NO phase can be started until ALL exit gates of the previous phase are verified
2. **Empirical Proof Required**: ALL exit gates require empirical proof (SQL results, file existence, command output)
3. **Verification Document Mandatory**: Each phase must have a verification document before advancement
4. **Automated CI Checks**: CI/CD must verify exit gates before allowing merge
5. **Peer Review Required**: Final sign-off requires peer review of all verification documents

### Verification Document Template

Each phase verification document must include:
- Date/time of verification
- Verifier name/identifier
- For each exit gate:
  - Gate number and name
  - Verification method used
  - Empirical proof (file paths, SQL results, command output)
  - Pass/fail status
  - Any remediation actions taken
- Overall phase status (PASS/FAIL)
- Sign-off approval

### CI/CD Integration

CI pipeline must:
1. Run all test scripts automatically
2. Verify file existence for required artifacts
3. Check SQL schema against expected structure
4. Validate contract compliance
5. Block merge if any exit gate fails

---

## Part V: File Locations & Artifacts

### New Migration Files (to be created):
- `alembic/versions/YYYYMMDDHHMM_enhance_allocation_schema.py`
- `alembic/versions/YYYYMMDDHHMM_add_sum_equality_validation.py`
- `alembic/versions/YYYYMMDDHHMM_enhance_revenue_ledger.py`

### Updated Files:
- `db/docs/specs/attribution_allocations_ddl_spec.sql`
- `db/docs/specs/revenue_ledger_ddl_spec.sql`
- `db/docs/contract_schema_mapping.yaml`
- `db/docs/INDEX_PLAN.md`

### New Documentation Files:
- `db/docs/IMMUTABILITY_POLICY.md`
- `db/docs/ROUNDING_POLICY.md`
- `db/docs/SUM_EQUALITY_INVARIANT.md`
- `db/docs/PHASE_4A_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_4B_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_4C_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_4D_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_5A_EXIT_GATE_VERIFICATION.md`
- `db/docs/PHASE_5B_EXIT_GATE_VERIFICATION.md`

### Test Scripts (to be executed):
- `db/tests/test_idempotency.sql`
- `db/tests/test_foreign_keys.sql`
- `db/tests/test_check_constraints.sql`
- `db/tests/test_sum_equality.sql`

---

## Conclusion

This rigorous implementation plan enforces **absolute phase advancement prohibition** with forensic validation requirements. Every exit gate must be empirically verified before progression. Agent(s) are explicitly restrained from advancing until complete compliance is documented and approved.

**NO EXCEPTIONS. NO SHORTCUTS. EMPIRICAL PROOF REQUIRED.**



